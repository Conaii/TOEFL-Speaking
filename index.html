<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>口语批改王 · TOEFL口语练习平台</title>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root { 
    --bg: #F8FAFC; 
    --surface: #FFFFFF; 
    --primary: #3B82F6;
    --primary-dark: #2563EB;
    --primary-light: #DBEAFE;
    --accent: #F59E0B;
    --accent-light: #FEF3C7;
    --success: #10B981;
    --success-light: #D1FAE5;
    --warning: #F97316;
    --warning-light: #FFEDD5;
    --text-dark: #1E293B;  
    --text-body: #334155;
    --text-muted: #64748B; 
    --border: #E2E8F0;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -1px rgba(0,0,0,0.04);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.03);
    --card-bg: #ffffff;
    --header-bg: linear-gradient(135deg, #e0f2fe 0%, #eef2ff 40%, #fdf2ff 100%);
    --stats-bg: linear-gradient(135deg, #fefce8 0%, #ecfeff 40%, #f9fafb 100%);
    --page-bg: radial-gradient(circle at top left, #e0f2fe 0, transparent 55%),
               radial-gradient(circle at bottom right, #fee2e2 0, transparent 55%),
               #f4f4fb;
    /* 高亮颜色系统 */
    --hl-yellow: #fef9c3;
    --hl-blue: #dbeafe;
    --hl-red: #fee2e2;
    --hl-orange: #ffedd5;
    --hl-purple: #f3e8ff;
    --hl-green: #dcfce7;
  }
  
  /* ==================== 登录系统样式 ==================== */
  .auth-container {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    z-index: 99999;
    align-items: center;
    justify-content: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  .auth-container.show { display: flex; }
  
  .auth-box {
    background: white;
    border-radius: 24px;
    padding: 40px;
    width: 400px;
    max-width: 90vw;
    box-shadow: 0 25px 80px rgba(0,0,0,0.3);
  }
  
  .auth-logo {
    text-align: center;
    margin-bottom: 30px;
  }
  .auth-logo-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }
  .auth-logo-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-dark);
    margin: 0;
  }
  .auth-logo-subtitle {
    font-size: 14px;
    color: var(--text-muted);
    margin-top: 4px;
  }
  
  .auth-tabs {
    display: flex;
    background: #f1f5f9;
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 24px;
  }
  .auth-tab {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  .auth-tab.active {
    background: white;
    color: var(--primary);
    box-shadow: var(--shadow-sm);
  }
  
  .auth-form {
    display: none;
  }
  .auth-form.active { display: block; }
  
  .auth-field {
    margin-bottom: 16px;
  }
  .auth-field label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-body);
    margin-bottom: 6px;
  }
  .auth-field input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 10px;
    font-size: 15px;
    transition: all 0.2s;
    box-sizing: border-box;
  }
  .auth-field input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }
  
  .auth-btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }
  .auth-btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
  }
  .auth-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
  }
  .auth-btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  
  .auth-divider {
    display: flex;
    align-items: center;
    margin: 20px 0;
    color: var(--text-muted);
    font-size: 13px;
  }
  .auth-divider::before,
  .auth-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .auth-divider span { padding: 0 12px; }
  
  .auth-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
    margin-bottom: 16px;
    display: none;
  }
  .auth-error.show { display: block; }
  
  .auth-success {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    color: #16a34a;
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
    margin-bottom: 16px;
    display: none;
  }
  .auth-success.show { display: block; }
  
  /* 用户信息显示 */
  .user-info {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255,255,255,0.9);
    border-radius: 20px;
    font-size: 13px;
    color: var(--text-body);
  }
  .user-info.show { display: flex; }
  .user-avatar {
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: 600;
  }
  .user-logout {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px 8px;
    font-size: 12px;
  }
  .user-logout:hover {
    color: #dc2626;
  }
  
  /* 背景主题样式 */
  [data-bg-theme="minimal"] {
    --page-bg: #ffffff;
    --header-bg: #fafafa;
    --stats-bg: #f5f5f5;
  }
  [data-bg-theme="warm"] {
    --page-bg: radial-gradient(circle at top left, #fef3c7 0, transparent 55%),
               radial-gradient(circle at bottom right, #fed7aa 0, transparent 55%),
               #fffbeb;
    --header-bg: linear-gradient(135deg, #fef3c7 0%, #fde68a 40%, #fef9c3 100%);
    --stats-bg: linear-gradient(135deg, #fffbeb 0%, #fef3c7 40%, #fff7ed 100%);
  }
  [data-bg-theme="cool"] {
    --page-bg: radial-gradient(circle at top left, #dbeafe 0, transparent 55%),
               radial-gradient(circle at bottom right, #e0e7ff 0, transparent 55%),
               #f0f9ff;
    --header-bg: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 40%, #e0e7ff 100%);
    --stats-bg: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 40%, #eff6ff 100%);
  }
  [data-bg-theme="nature"] {
    --page-bg: radial-gradient(circle at top left, #dcfce7 0, transparent 55%),
               radial-gradient(circle at bottom right, #d1fae5 0, transparent 55%),
               #f0fdf4;
    --header-bg: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 40%, #d1fae5 100%);
    --stats-bg: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 40%, #ecfdf5 100%);
  }
  [data-bg-theme="sunset"] {
    --page-bg: radial-gradient(circle at top left, #fce7f3 0, transparent 55%),
               radial-gradient(circle at bottom right, #fef3c7 0, transparent 55%),
               #fdf2f8;
    --header-bg: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 40%, #fef3c7 100%);
    --stats-bg: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 40%, #fffbeb 100%);
  }

  /* 深色模式变量 */
  [data-theme="dark"] {
    --bg: #0f172a;
    --surface: #1e293b;
    --primary: #60a5fa;
    --primary-dark: #3b82f6;
    --primary-light: #1e3a5f;
    --text-dark: #f1f5f9;
    --text-body: #cbd5e1;
    --text-muted: #94a3b8;
    --border: #334155;
    --card-bg: #1e293b;
    --header-bg: linear-gradient(135deg, #1e3a5f 0%, #312e81 40%, #4c1d95 100%);
    --stats-bg: linear-gradient(135deg, #422006 0%, #164e63 40%, #1e293b 100%);
    --page-bg: radial-gradient(circle at top left, #1e3a5f 0, transparent 55%),
               radial-gradient(circle at bottom right, #4c1d95 0, transparent 55%),
               #0f172a;
  }
  
  /* --- 核心字体定义：只保留 Times 和 Georgia --- */
  .font-times, .font-times * { font-family: "Times New Roman", Times, serif !important; }
  .font-georgia, .font-georgia * { font-family: Georgia, serif !important; }

  /* 字号控制 - 大号系（应用到所有子元素） */
  .size-lg, .size-lg td, .size-lg th, .size-lg div, .size-lg p, .size-lg span { font-size: 17px; }
  .size-xl, .size-xl td, .size-xl th, .size-xl div, .size-xl p, .size-xl span { font-size: 19px; } 
  .size-xxl, .size-xxl td, .size-xxl th, .size-xxl div, .size-xxl p, .size-xxl span { font-size: 21px; }

  /* 选中文字的字号调整 - 温和变化约1/5 */
  .text-size-sm { font-size: 0.8em !important; }
  .text-size-lg { font-size: 1.2em !important; }

  * { box-sizing: border-box; }
  html, body {
    margin: 0; padding: 0;
    background: var(--page-bg);
    color: var(--text-dark);
    -webkit-font-smoothing: antialiased;
    line-height: 1.65; 
    transition: background 0.3s, color 0.3s;
  }

  /* 整体容器：稍微窄一点 + 居中 + 上下留白 */
  .wrap { 
    max-width: 1180px;
    width: 100%;
    margin: 40px auto; 
    padding: 0 24px; 
    transition: width 0.3s ease; 
    max-width: 95vw; 
  }
  
  /* --- 工具栏：亮色玻璃感 --- */
  .toolbar {
    display: flex; justify-content: space-between; align-items: center;
    background: var(--card-bg);
    padding: 14px 18px;
    border-radius: 18px;
    margin-bottom: 20px; 
    border: 1px solid var(--border);
    box-shadow: 0 18px 40px rgba(148, 163, 184, 0.25), 0 0 0 1px var(--border);
    color: var(--text-dark);
    backdrop-filter: blur(12px);
    flex-wrap: wrap; gap: 12px; 
    transition: background 0.3s, border-color 0.3s;
  }
  .toolbar-left { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
  .toolbar-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  
  .app-title { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 8px; color: var(--text-dark); letter-spacing: 0.03em; }
  .app-tag { 
    font-size: 11px; 
    padding: 3px 10px; 
    border-radius: 999px; 
    background: linear-gradient(135deg, #38bdf8 0%, #6366f1 40%, #ec4899 100%);
    color: #f9fafb; 
    font-weight: 600;
    box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.08);
  }

  .input-group { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-muted); font-weight: 500;}
  .toolbar select,
  .toolbar input[type="text"],
  .toolbar input[type="date"],
  .toolbar input[type="number"] {
    padding: 8px 12px; 
    border: 1px solid var(--border); 
    border-radius: 10px;
    font-size: 13px; 
    color: var(--text-dark); 
    outline: none; 
    background: var(--card-bg);
    transition: border-color 0.15s, background 0.3s;
  }
  .toolbar select:hover, .toolbar input:hover { border-color: var(--primary); }
  .toolbar select:focus, .toolbar input:focus { border-color: var(--primary); outline: none; }
  .task-select {
    padding: 8px 14px;
    font-weight: 500;
    min-width: 120px;
  }
  input[type="text"], select, input[type="date"] {
    padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px;
    font-size: 13px; color: var(--text-dark); outline: none; background: var(--card-bg);
    transition: border-color 0.15s, background 0.3s;
  }
  select:hover, input:hover { border-color: #D1D5DB; }
  select:focus, input:focus { border-color: var(--primary); outline: none; }
  input[type="number"] {
    padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px;
    font-size: 13px; color: var(--text-dark); outline: none; background: var(--card-bg);
    width: 60px;
  }
  
  .btn {
    display: inline-flex; align-items: center; gap: 5px; padding: 8px 16px;
    border-radius: 999px; font-size: 13px; font-weight: 500; cursor: pointer;
    transition: all 0.15s; border: none; user-select: none;
  }
  .btn-ghost { 
    background: var(--surface); 
    color: var(--text-dark); 
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { background: var(--primary-light); border-color: var(--primary); }
  .btn-primary { 
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); 
    color: white; 
    box-shadow: 0 10px 25px rgba(59,130,246,0.4); 
  }
  .btn-primary:hover { background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); }
  .btn-danger { background: #FEF2F2; color: #DC2626; }
  .btn-danger:hover { background: #FEE2E2; }
  .btn-success { 
    background: linear-gradient(135deg, #10B981 0%, #059669 100%); 
    color: white; 
    box-shadow: 0 10px 25px rgba(16,185,129,0.4); 
  }
  .btn-success:hover { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
  .btn-purple { 
    background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); 
    color: white; 
    box-shadow: 0 10px 25px rgba(129,140,248,0.45); 
  }
  .btn-purple:hover { background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%); }
  .btn-orange {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    color: white;
    box-shadow: 0 10px 25px rgba(249,115,22,0.4);
  }
  .btn-orange:hover { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); }
  
  /* 导出下拉菜单 */
  .export-dropdown {
    position: relative;
    display: inline-block;
  }
  .export-dropdown-btn {
    min-width: 90px;
  }
  .export-dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 4px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    min-width: 220px;
    padding: 6px 0;
    opacity: 0;
    transform: translateY(-8px);
    transition: opacity 0.15s, transform 0.15s;
  }
  .export-dropdown-menu.show {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }
  .export-dropdown-menu button {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 10px 16px;
    border: none;
    background: transparent;
    color: var(--text-body);
    font-size: 13px;
    cursor: pointer;
    text-align: left;
    transition: background 0.15s;
  }
  .export-dropdown-menu button:hover {
    background: var(--primary-light);
    color: var(--text-dark);
  }
  .export-dropdown-menu button kbd {
    font-size: 10px;
    padding: 2px 6px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-muted);
  }
  .export-dropdown-divider {
    height: 1px;
    background: var(--border);
    margin: 6px 0;
  }
  
  /* 深色模式切换按钮 */
  .btn-theme {
    background: var(--surface);
    color: var(--text-dark);
    border: 1px solid var(--border);
    padding: 8px 12px;
    font-size: 16px;
  }
  .btn-theme:hover { background: var(--primary-light); }
  
  /* --- 导出区域：亮白 + 轻渐变 --- */
  #captureArea {
    background: var(--card-bg);
    border-radius: 22px;
    border: 1px solid var(--border);
    overflow: hidden;
    box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12), 0 0 0 1px var(--border);
    transition: background 0.3s, border-color 0.3s;
  }

  /* --- 头部区域：淡蓝+粉渐变 --- */
  .header-section {
    background: var(--header-bg);
    border-bottom: 1px solid var(--border);
    padding: 26px 38px 28px;
    transition: background 0.3s;
  }
  .header-date-topic {
    font-size: 26px;
    font-weight: 650;
    line-height: 1.4;
    color: var(--text-dark);
    letter-spacing: 0.02em;
  }
  .header-date-topic:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted);
  }
  
  /* 学生信息栏 */
  .student-info-bar {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  .student-info-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: var(--text-muted);
  }
  .student-info-item label {
    font-weight: 500;
  }
  .student-info-item input {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
    line-height: 1.4;
    background: var(--card-bg);
    color: var(--text-dark);
    width: 120px;
    vertical-align: middle;
  }
  .student-info-item input[type="date"] {
    width: 140px;
  }
  .student-info-item input[type="number"] {
    width: 60px;
  }
  .btn-student-import {
    padding: 4px 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface);
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.15s;
  }
  .btn-student-import:hover {
    background: var(--primary-light);
    color: var(--primary);
  }
  .btn-student-history {
    padding: 4px 8px;
    border: 1px solid #86efac;
    border-radius: 6px;
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    color: #059669;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.15s;
  }
  .btn-student-history:hover {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
  }
  .student-history-badge {
    display: none;
    padding: 2px 8px;
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
    font-size: 11px;
    font-weight: 600;
    border-radius: 999px;
    margin-left: 6px;
    box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
  }
  .student-history-badge.show {
    display: inline-block;
  }
  .bg-theme-select {
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 13px;
    background: var(--card-bg);
    color: var(--text-dark);
    cursor: pointer;
  }
  
  /* 学生名单导入弹窗 */
  .student-import-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }
  .student-import-modal.show { display: flex; }
  .student-import-content {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 24px;
    width: 400px;
    max-width: 90vw;
    box-shadow: var(--shadow-lg);
  }
  .student-import-content h3 {
    margin: 0 0 16px 0;
    font-size: 18px;
    color: var(--text-dark);
  }
  .student-import-content textarea {
    width: 100%;
    height: 200px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    background: var(--surface);
    color: var(--text-dark);
    resize: vertical;
    margin-bottom: 12px;
  }
  .student-import-content p {
    font-size: 12px;
    color: var(--text-muted);
    margin: 0 0 16px 0;
  }
  .student-import-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  
  /* 学生历史面板 */
  .student-history-panel {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }
  .student-history-panel.show { display: flex; }
  .student-history-content {
    background: var(--card-bg);
    border-radius: 16px;
    width: 700px;
    max-width: 95vw;
    max-height: 85vh;
    box-shadow: var(--shadow-lg);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .student-history-header {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .student-history-header h3 {
    margin: 0;
    font-size: 18px;
  }
  .student-history-close {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.2);
    color: white;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .student-history-close:hover {
    background: rgba(255,255,255,0.3);
  }
  .student-history-body {
    padding: 20px;
    overflow-y: auto;
  }
  .history-section {
    margin-bottom: 16px;
  }
  .history-section label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-body);
    margin-right: 8px;
  }
  .history-student-select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    background: var(--surface);
    color: var(--text-dark);
    min-width: 200px;
    cursor: pointer;
  }
  .history-stats {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    padding: 16px;
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border-radius: 12px;
  }
  .stat-item {
    flex: 1;
    text-align: center;
  }
  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #059669;
  }
  .stat-label {
    font-size: 12px;
    color: #047857;
    margin-top: 4px;
  }
  
  /* === 学生进步曲线样式 === */
  .progress-chart-section {
    margin-bottom: 20px;
    background: var(--surface);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid var(--border);
  }
  .progress-chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  .progress-chart-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .progress-chart-tabs {
    display: flex;
    gap: 4px;
  }
  .progress-chart-tab {
    padding: 6px 12px;
    border: none;
    background: transparent;
    font-size: 12px;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
  }
  .progress-chart-tab:hover {
    background: var(--primary-light);
  }
  .progress-chart-tab.active {
    background: var(--primary);
    color: white;
  }
  .progress-chart-container {
    height: 160px;
    position: relative;
  }
  .progress-chart-canvas {
    width: 100%;
    height: 100%;
  }
  .progress-chart-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 12px;
    font-size: 12px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }
  .legend-dot.words { background: #3B82F6; }
  .legend-dot.wpm { background: #10B981; }
  .legend-dot.fillers { background: #F59E0B; }
  .legend-dot.errors { background: #EF4444; }
  
  /* 进步趋势指标 */
  .progress-indicators {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-top: 16px;
  }
  .progress-indicator {
    background: var(--card-bg);
    border-radius: 10px;
    padding: 12px;
    text-align: center;
    border: 1px solid var(--border);
  }
  .indicator-value {
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }
  .indicator-value.positive { color: #10B981; }
  .indicator-value.negative { color: #EF4444; }
  .indicator-value.neutral { color: var(--text-muted); }
  .indicator-trend {
    font-size: 14px;
  }
  .indicator-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
  }
  
  /* 无数据提示 */
  .no-progress-data {
    text-align: center;
    padding: 30px;
    color: var(--text-muted);
  }
  .no-progress-data-icon {
    font-size: 40px;
    margin-bottom: 12px;
  }
  
  .history-records {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 16px;
  }
  .history-record-item {
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .history-record-info {
    flex: 1;
  }
  .history-record-date {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dark);
  }
  .history-record-topic {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 300px;
  }
  .history-record-badge {
    padding: 4px 10px;
    background: var(--primary);
    color: white;
    font-size: 11px;
    font-weight: 600;
    border-radius: 999px;
  }
  .history-actions {
    display: flex;
    gap: 10px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }
  .history-actions .btn-danger {
    color: #ef4444;
    border-color: #fecaca;
  }
  .history-actions .btn-danger:hover {
    background: #fef2f2;
  }
  .history-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }
  .history-empty-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }

  /* --- 题目信息栏：更轻一点 --- */
  .topic-bar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 12px 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    transition: background 0.3s;
  }
  .topic-bar-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .topic-bar-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .topic-speed {
    font-size: 16px;
    color: var(--text-body);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-weight: 500;
  }
  .speed-select {
    padding: 10px 20px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 16px;
    font-weight: 500;
    background: var(--card-bg);
    cursor: pointer;
    min-width: 100px;
    text-align: center;
    text-align-last: center;
  }
  .speed-select:focus { border-color: var(--primary); outline: none; }

  /* === 核心数据仪表盘：3个完全相同的大圆角卡片 === */
  .stats-dashboard {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 24px;
    padding: 24px 32px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    transition: background 0.3s;
  }
  
  /* 统一卡片样式 - 所有卡片完全相同 */
  .stat-card {
    width: 160px !important;
    height: 100px !important;
    min-width: 160px !important;
    max-width: 160px !important;
    min-height: 100px !important;
    max-height: 100px !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    background: var(--card-bg) !important;
    border-radius: 50px !important;
    border: 1px solid var(--border) !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06) !important;
    transition: transform 0.2s, box-shadow 0.2s, background 0.3s !important;
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
  }
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1) !important;
  }
  
  .stat-card-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 4px;
  }
  .stat-card-value {
    font-size: 32px;
    font-weight: 700;
    line-height: 1;
  }
  
  /* 颜色 */
  .stat-card.words .stat-card-value { color: #3b82f6; }
  .stat-card.filler .stat-card-value { color: #f59e0b; }
  .stat-card.repeat .stat-card-value { color: #ef4444; }
  
  /* === 错误类型统计块 === */
  .error-stats-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 32px;
    padding: 14px 32px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .error-stats-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  .error-stats-items {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  .error-stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: var(--text-body);
  }
  .error-stat-item .label {
    color: var(--text-muted);
  }
  .error-stat-item .count {
    font-weight: 700;
    min-width: 20px;
    text-align: center;
    background: var(--primary-light);
    padding: 2px 8px;
    border-radius: 10px;
  }
  .error-stat-item.grammar .count { color: #7c3aed; background: #f3e8ff; }
  .error-stat-item.pronunciation .count { color: #ec4899; background: #fce7f3; }
  .error-stat-item.stress .count { color: #0891b2; background: #cffafe; }
  .error-stat-item.vowel .count { color: #059669; background: #d1fae5; }
  
  [data-theme="dark"] .error-stat-item.grammar .count { background: #4c1d95; }
  [data-theme="dark"] .error-stat-item.pronunciation .count { background: #831843; }
  [data-theme="dark"] .error-stat-item.stress .count { background: #164e63; }
  [data-theme="dark"] .error-stat-item.vowel .count { background: #064e3b; }
  
  /* 响应式 */
  @media (max-width: 600px) {
    .stats-dashboard { flex-wrap: wrap; gap: 16px; }
    .stat-card { flex: 0 0 140px; height: 90px; }
    .error-stats-bar { gap: 16px; padding: 12px 20px; }
  }

  /* --- 表格核心：鲜艳但不土 --- */
  table { width: 100%; border-collapse: collapse; table-layout: fixed; }
  
  #correctionTable {
    border-top: 1px solid var(--border);
  }
  
  th {
    text-align: left; padding: 14px 24px; font-size: 12px; font-weight: 600;
    color: var(--text-body); 
    background: var(--primary-light);
    text-transform: uppercase; letter-spacing: 0.08em;
    border-bottom: 1px solid var(--border);
  }
  
  td {
    padding: 18px 24px; vertical-align: top;
    color: var(--text-body);
    border-bottom: 1px solid var(--border);
    font-size: inherit; 
    text-align: left !important; 
    white-space: normal !important; 
    word-wrap: break-word;
    word-break: normal;
    overflow-wrap: break-word;
    line-height: 1.9;
    min-width: 80px; /* 防止列过窄导致文字竖排 */
  }
  
  /* 修复contenteditable中粘贴的表格 */
  [contenteditable] table {
    width: 100%;
    table-layout: auto;
  }
  [contenteditable] td,
  [contenteditable] th {
    min-width: 100px;
    white-space: normal;
    word-break: break-word;
  }
  
  td:not(:last-child), th:not(:last-child) { border-right: 1px solid var(--border); }

  #correctionTable td { line-height: 1.9; }
  #correctionTable th:nth-child(1), #correctionTable td:nth-child(1) { width: 30%; }
  #correctionTable th:nth-child(2), #correctionTable td:nth-child(2) { width: 35%; }
  #correctionTable th:nth-child(3), #correctionTable td:nth-child(3) { width: 35%; }
  
  /* 奇偶行：暖橙 + 亮蓝交替 */
  #correctionTable tbody tr:nth-child(odd) td { background: #fff7ed; }
  #correctionTable tbody tr:nth-child(even) td { background: #eff6ff; }
  [data-theme="dark"] #correctionTable tbody tr:nth-child(odd) td { background: #422006; }
  [data-theme="dark"] #correctionTable tbody tr:nth-child(even) td { background: #1e3a5f; }
  
  /* 左侧彩色条 */
  #correctionTable tbody tr:nth-child(odd) td:first-child { box-shadow: inset 4px 0 0 #fb923c; }
  #correctionTable tbody tr:nth-child(even) td:first-child { box-shadow: inset 4px 0 0 #3b82f6; }

  /* --- Summary Tables (2 columns) --- */
  #summaryTable { margin-top: 0; border-top: 1px solid var(--border); }
  #summaryTable tbody tr td { 
    background: var(--card-bg); 
    line-height: 2.0; 
    border-bottom: 1px solid var(--border); 
    padding: 20px 24px;
  }
  #summaryTable td:nth-child(1) { 
    width: 12%; 
    vertical-align: top; 
    background: var(--primary-light); 
    border-right: 1px solid var(--border);
    font-size: 13px;
    font-weight: 600;
    padding: 20px 16px;
  }
  #summaryTable td:nth-child(2) { 
    width: 88%; 
    background: var(--card-bg); 
  }
  /* 思路内容中的加粗标题样式 */
  #summaryTable td:nth-child(2) b {
    color: var(--primary);
    font-weight: 700;
  }

  .summary-tag {
    display: inline-block; padding: 4px 12px;
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 40%, #22c55e 100%);
    color: #f9fafb;
    border-radius: 999px; font-size: 11px; font-weight: 600;
    text-align: center;
    letter-spacing: 0.06em;
  }
  
  .summary-content {
    line-height: 1.85;
  }
  .summary-content b {
    color: var(--text-dark);
    font-weight: 600;
  }

  /* === Block 2 Section Styles (润色+总评) === */
  .block2-section {
    padding: 24px 36px 22px;
    border-bottom: 1px solid var(--border);
  }
  .block2-section:last-child {
    border-bottom: none;
  }
  .block2-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-body);
    margin-bottom: 10px;
    letter-spacing: 0.09em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  /* TTS播放按钮 */
  .tts-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: none;
    letter-spacing: 0;
  }
  .tts-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  }
  .tts-btn.playing {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }
  .tts-btn .tts-icon {
    font-size: 14px;
  }
  .tts-mode-btn {
    padding: 3px 10px;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 999px;
    font-size: 11px;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: none;
    letter-spacing: 0;
  }
  .tts-mode-btn:hover {
    background: #e2e8f0;
  }
  .tts-mode-btn.ai-mode {
    background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
    border-color: #93c5fd;
    color: #1d4ed8;
  }
  
  /* TTS设置面板样式 */
  .tts-settings-panel {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 10003;
    align-items: center;
    justify-content: center;
  }
  .tts-settings-panel.show { display: flex; }
  .tts-settings-content {
    background: var(--card-bg);
    border-radius: 20px;
    width: 500px;
    max-width: 95vw;
    max-height: 90vh;
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .tts-settings-header {
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .tts-settings-header h3 { margin: 0; font-size: 18px; }
  .tts-settings-close {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.2);
    color: white;
    font-size: 20px;
    cursor: pointer;
  }
  .tts-settings-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
  }
  .tts-setting-group {
    margin-bottom: 20px;
  }
  .tts-setting-group > label {
    display: block;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 8px;
    font-size: 14px;
  }
  .tts-setting-group input[type="text"],
  .tts-setting-group input[type="password"],
  .tts-setting-group select {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    background: var(--surface);
  }
  .tts-setting-group input:focus,
  .tts-setting-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  .setting-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
  }
  .setting-hint a {
    color: var(--primary);
  }
  
  /* 提供商选择 */
  .tts-provider-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .tts-provider-option {
    cursor: pointer;
  }
  .tts-provider-option input { display: none; }
  .provider-card {
    display: grid;
    grid-template-columns: 40px 1fr auto;
    grid-template-rows: auto auto;
    gap: 2px 12px;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 12px;
    transition: all 0.2s;
  }
  .tts-provider-option input:checked + .provider-card {
    border-color: var(--primary);
    background: var(--primary-light);
  }
  .provider-icon {
    grid-row: span 2;
    font-size: 28px;
    display: flex;
    align-items: center;
  }
  .provider-name {
    font-weight: 600;
    color: var(--text-dark);
  }
  .provider-desc {
    font-size: 12px;
    color: var(--text-muted);
  }
  .provider-price {
    grid-row: span 2;
    font-size: 11px;
    color: #10b981;
    font-weight: 500;
    display: flex;
    align-items: center;
  }
  
  /* 语速滑块 */
  .tts-setting-group input[type="range"] {
    width: 100%;
    height: 6px;
    -webkit-appearance: none;
    background: var(--border);
    border-radius: 3px;
    outline: none;
  }
  .tts-setting-group input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
  }
  .tts-rate-labels {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
  }
  
  .tts-test-status {
    margin-left: 12px;
    font-size: 13px;
    color: var(--text-muted);
  }
  
  .tts-settings-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }
  
  /* AI批改面板样式 */
  .ai-panel {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px;
    max-width: 95vw;
    max-height: 90vh;
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.25);
    z-index: 10002;
    overflow-y: auto;
  }
  .ai-panel.open { display: block; }
  .ai-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
    color: white;
    border-radius: 20px 20px 0 0;
  }
  .ai-panel-header h3 {
    margin: 0;
    font-size: 18px;
  }
  .ai-panel-close {
    background: rgba(255,255,255,0.2);
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: white;
    padding: 4px 10px;
    border-radius: 8px;
    transition: background 0.2s;
  }
  .ai-panel-close:hover { background: rgba(255,255,255,0.3); }
  .ai-panel-body {
    padding: 24px;
  }
  .ai-section {
    margin-bottom: 20px;
  }
  .ai-section-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .ai-section-title .icon { font-size: 16px; }
  .ai-key-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 999px;
    margin-left: auto;
  }
  .ai-key-status.saved {
    background: #dcfce7;
    color: #166534;
  }
  .ai-key-status.missing {
    background: #fee2e2;
    color: #dc2626;
  }
  .ai-key-row {
    display: flex;
    gap: 8px;
  }
  .ai-key-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 13px;
    background: var(--surface);
    color: var(--text-dark);
    font-family: ui-monospace, monospace;
  }
  .ai-key-input:focus {
    outline: none;
    border-color: var(--primary);
  }
  .ai-hint {
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-muted);
  }
  .ai-hint a {
    color: var(--primary);
    text-decoration: none;
  }
  .ai-hint a:hover { text-decoration: underline; }
  .ai-transcript-input {
    width: 100%;
    height: 150px;
    padding: 14px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 14px;
    background: var(--surface);
    color: var(--text-dark);
    resize: vertical;
    line-height: 1.6;
  }
  .ai-transcript-input:focus {
    outline: none;
    border-color: var(--primary);
  }
  .ai-topic-input {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    background: var(--surface);
    color: var(--text-dark);
  }
  .ai-topic-input:focus {
    outline: none;
    border-color: var(--primary);
  }
  .ai-actions {
    text-align: center;
    margin: 24px 0;
  }
  .btn-lg {
    padding: 14px 32px;
    font-size: 15px;
  }
  .ai-btn-icon {
    font-size: 18px;
  }
  .ai-progress {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 16px;
    background: #f5f3ff;
    border-radius: 12px;
    margin-top: 16px;
  }
  .ai-progress.show { display: flex; }
  .ai-progress-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #e9d5ff;
    border-top-color: #8b5cf6;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .ai-progress-text {
    font-size: 14px;
    color: #7c3aed;
    font-weight: 500;
  }
  .ai-tips {
    background: #fefce8;
    border: 1px solid #fef08a;
    border-radius: 12px;
    padding: 16px;
  }
  .ai-tips-title {
    font-size: 13px;
    font-weight: 600;
    color: #854d0e;
    margin-bottom: 8px;
  }
  .ai-tips ul {
    margin: 0;
    padding-left: 20px;
    font-size: 12px;
    color: #a16207;
  }
  .ai-tips li {
    margin-bottom: 4px;
  }
  .btn-sm {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  /* AI模式切换Tab */
  .ai-mode-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  .ai-mode-tab {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: var(--surface);
    color: var(--text-body);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .ai-mode-tab:hover {
    border-color: var(--primary);
  }
  .ai-mode-tab.active {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
    color: #7c3aed;
  }
  .ai-mode-content {
    animation: fadeIn 0.2s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* 复制粘贴模式信息框 */
  .ai-info-box {
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border: 1px solid #a7f3d0;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
  }
  .ai-info-title {
    font-size: 14px;
    font-weight: 600;
    color: #059669;
    margin-bottom: 10px;
  }
  .ai-steps {
    margin: 0;
    padding-left: 20px;
    font-size: 13px;
    color: #047857;
  }
  .ai-steps li {
    margin-bottom: 6px;
  }
  .ai-steps a {
    color: #0369a1;
    font-weight: 500;
  }
  
  /* Prompt输出框 */
  .ai-prompt-output {
    width: 100%;
    height: 200px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 12px;
    font-family: ui-monospace, monospace;
    background: #f8fafc;
    color: var(--text-body);
    resize: vertical;
  }
  
  /* 回复输入框 */
  .ai-response-input {
    width: 100%;
    height: 200px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 13px;
    background: var(--surface);
    color: var(--text-dark);
    resize: vertical;
  }
  .ai-response-input:focus {
    outline: none;
    border-color: var(--primary);
  }
  
  /* AI提供商选择网格 */
  .ai-provider-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .ai-provider-option {
    cursor: pointer;
  }
  .ai-provider-option input {
    display: none;
  }
  .ai-provider-option .provider-card {
    padding: 12px 14px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: var(--surface);
    transition: all 0.2s;
  }
  .ai-provider-option:hover .provider-card {
    border-color: var(--primary);
  }
  .ai-provider-option input:checked + .provider-card {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
  }
  .provider-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 2px;
  }
  .provider-price {
    font-size: 11px;
    color: var(--text-muted);
  }
  .ai-provider-option input:checked + .provider-card .provider-name {
    color: #7c3aed;
  }
  
  /* 自定义批改要求 */
  .btn-xs {
    padding: 2px 8px;
    font-size: 11px;
  }
  .custom-prompt-container {
    margin-top: 10px;
  }
  .ai-custom-prompt {
    width: 100%;
    height: 100px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 13px;
    background: var(--surface);
    color: var(--text-dark);
    resize: vertical;
    line-height: 1.5;
  }
  .ai-custom-prompt:focus {
    outline: none;
    border-color: var(--primary);
  }
  
  .block2-content {
    line-height: 1.85;
    color: var(--text-body);
  }
  .block2-content:empty:before {
    content: '导入 Markdown 后自动填充...';
    color: var(--text-muted);
  }
  .polished-content {
    background: var(--surface);
    padding: 16px 18px;
    border-radius: 14px;
    border: 1px solid var(--border);
    line-height: 1.9;
    font-size: inherit;
  }
  .polished-content:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted);
  }
  .polished-word-count {
    text-align: right;
    margin-top: 10px;
    font-size: 12px;
    color: var(--text-muted);
  }
  .overall-content {
    background: var(--surface);
    padding: 18px 20px;
    border-radius: 14px;
    border: 1px solid var(--border);
    line-height: 1.8;
  }
  .overall-content:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted);
  }

  /* === Block 2 (思路+总评) Styles === */
  #capturePart2 {
    background: var(--card-bg);
    border-top: 2px solid var(--border);
  }

  /* === Block 3 (练习区) Styles === */
  #capturePart3 {
    background: var(--card-bg);
    border-top: 2px solid var(--border);
  }
  .block3-header {
    background: var(--primary-light);
    padding: 20px 36px 14px;
    border-bottom: 1px solid var(--border);
  }
  .block3-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-dark);
  }
  .block3-subtitle {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 4px;
  }
  .block3-content {
    padding: 22px 36px;
    border-bottom: 1px solid var(--border);
  }
  .exercise-content {
    background: var(--surface);
    padding: 20px;
    border-radius: 14px;
    border: 1px solid var(--border);
    line-height: 1.8;
    min-height: 80px;
  }
  .exercise-content:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted);
  }
  .exercise-content h3, .exercise-content .ex-title {
    color: var(--text-dark);
    font-weight: 600;
    font-size: 14px;
    margin: 20px 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }
  .exercise-content h3:first-child, .exercise-content .ex-title:first-child {
    margin-top: 0;
  }
  .exercise-content .ex-instruction {
    color: var(--text-muted);
    font-size: 14px;
    margin-bottom: 12px;
  }
  .exercise-content .ex-wordbank {
    background: var(--primary-light);
    padding: 10px 14px;
    border-radius: 6px;
    font-family: ui-monospace, monospace;
    font-size: 13px;
    margin-bottom: 14px;
    color: var(--primary);
  }
  .exercise-content ol, .exercise-content ul {
    margin: 12px 0;
    padding-left: 24px;
  }
  .exercise-content li {
    margin-bottom: 10px;
  }
  .exercise-content blockquote {
    border-left: 3px solid var(--primary);
    margin: 16px 0;
    padding: 12px 16px;
    background: var(--primary-light);
    color: var(--primary);
    font-style: italic;
    border-radius: 0 6px 6px 0;
  }
  .exercise-content hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 20px 0;
  }

  /* Block 3 Answer Section */
  .block3-answer {
    padding: 24px 32px;
  }
  .block3-answer-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 14px;
  }
  .answer-content {
    background: var(--surface);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--border);
    line-height: 1.8;
  }
  .answer-content:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted);
  }
  .answer-content h3 {
    color: var(--text-dark);
    font-weight: 600;
    font-size: 14px;
    margin: 18px 0 10px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }
  .answer-content h3:first-child {
    margin-top: 0;
  }
  .answer-content ol, .answer-content ul {
    margin: 8px 0;
    padding-left: 20px;
  }
  .answer-content li {
    margin-bottom: 6px;
  }

  /* === 新版练习卡片样式 === */
  /* === 新版练习挑战样式 === */
  .exercise-header-new {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 24px 36px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    position: relative;
    overflow: hidden;
  }
  .exercise-header-new::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: shimmer 3s ease-in-out infinite;
  }
  @keyframes shimmer {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(25%, 25%); }
  }
  .exercise-header-badge {
    font-size: 40px;
    line-height: 1;
    background: rgba(255,255,255,0.2);
    padding: 12px;
    border-radius: 16px;
    position: relative;
    z-index: 1;
  }
  .exercise-header-text {
    flex: 1;
    position: relative;
    z-index: 1;
  }
  .exercise-title-new {
    font-size: 22px;
    font-weight: 800;
    color: white;
    margin-bottom: 4px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .exercise-subtitle-new {
    font-size: 14px;
    color: rgba(255,255,255,0.85);
  }
  .exercise-progress {
    position: relative;
    z-index: 1;
  }
  .progress-text {
    background: rgba(255,255,255,0.2);
    padding: 8px 16px;
    border-radius: 20px;
    color: white;
    font-size: 13px;
    font-weight: 500;
  }
  
  /* 练习主内容区 */
  .exercise-main {
    padding: 24px 36px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  .exercise-content {
    background: var(--card-bg);
    padding: 24px;
    border-radius: 16px;
    border: 1px solid var(--border);
    line-height: 1.9;
    min-height: 100px;
    box-shadow: var(--shadow-sm);
  }
  .exercise-content:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted);
  }
  .exercise-content h3, .exercise-content .ex-title {
    color: var(--text-dark);
    font-weight: 700;
    font-size: 15px;
    margin: 24px 0 14px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--primary-light);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .exercise-content h3:first-child, .exercise-content .ex-title:first-child {
    margin-top: 0;
  }
  .exercise-content h3::before {
    content: '📝';
    font-size: 18px;
  }
  .exercise-content ol, .exercise-content ul {
    margin: 14px 0;
    padding-left: 28px;
  }
  .exercise-content li {
    margin-bottom: 12px;
    padding: 8px 12px;
    background: var(--surface);
    border-radius: 8px;
    border-left: 3px solid var(--primary);
  }
  .exercise-content blockquote {
    border-left: 4px solid var(--primary);
    margin: 16px 0;
    padding: 16px 20px;
    background: linear-gradient(135deg, var(--primary-light) 0%, #f8fafc 100%);
    color: var(--text-body);
    font-style: italic;
    border-radius: 0 12px 12px 0;
  }
  
  /* 可折叠答案区 */
  .answers-collapsible {
    border-top: 1px solid var(--border);
  }
  .answers-toggle {
    width: 100%;
    padding: 20px 36px;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 16px;
    font-weight: 600;
    color: #92400e;
    transition: all 0.3s;
  }
  .answers-toggle:hover {
    background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
  }
  .answers-toggle.open {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #047857;
  }
  .toggle-icon {
    font-size: 20px;
    transition: transform 0.3s;
  }
  .answers-toggle.open .toggle-icon {
    content: '🔓';
  }
  .toggle-text {
    flex: 1;
    text-align: left;
  }
  .toggle-arrow {
    font-size: 12px;
    transition: transform 0.3s;
  }
  .answers-toggle.open .toggle-arrow {
    transform: rotate(180deg);
  }
  
  /* 答案面板 */
  .answers-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
    background: var(--surface);
  }
  .answers-panel.open {
    max-height: 1000px;
  }
  .answers-reveal-hint {
    padding: 16px 36px 8px;
    font-size: 14px;
    color: #047857;
    font-weight: 500;
  }
  .answers-content {
    margin: 0 36px 24px;
    background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
    padding: 24px;
    border-radius: 16px;
    border: 2px solid #a7f3d0;
    line-height: 1.9;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
  }
  .answers-content:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted);
  }
  .answers-content ol, .answers-content ul {
    margin: 10px 0;
    padding-left: 28px;
  }
  .answers-content li {
    margin-bottom: 10px;
    padding: 6px 0;
  }
  .answers-content strong {
    color: #047857;
    background: rgba(16, 185, 129, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
  }

  /* --- 标注样式 --- */
  b {
    font-weight: 600; 
    color: var(--text-dark);
    background: transparent; 
    padding: 0; 
    border-radius: 0;
    display: inline;
  }
  
  s { text-decoration: line-through; text-decoration-thickness: 1.5px; text-decoration-color: #EF4444; opacity: 0.7; }

  mark {
    background: #FEF3C7; color: #92400E;
    padding: 1px 4px; border-radius: 3px;
    display: inline;
  }

  .blue-highlight {
    background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%); 
    color: #1d4ed8;
    padding: 1px 5px; border-radius: 5px; font-weight: 600;
    display: inline;
  }
  
  /* 新高亮颜色系统 - 导出时保留 */
  .hl-yellow {
    background: #fef08a !important;
    padding: 1px 4px;
    border-radius: 3px;
    color: #854d0e;
  }
  .hl-blue {
    background: #bfdbfe !important;
    padding: 1px 4px;
    border-radius: 3px;
    color: #1e40af;
  }
  .hl-red {
    background: #fecaca !important;
    padding: 1px 4px;
    border-radius: 3px;
    color: #991b1b;
  }
  .hl-orange {
    background: #fed7aa !important;
    padding: 1px 4px;
    border-radius: 3px;
    color: #c2410c;
  }
  .hl-purple {
    background: #e9d5ff !important;
    padding: 1px 4px;
    border-radius: 3px;
    color: #7c3aed;
  }
  .hl-green {
    background: #bbf7d0 !important;
    padding: 1px 4px;
    border-radius: 3px;
    color: #166534;
  }
  
  /* 红色高亮（问题/错误） */
  .red-highlight {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #b91c1c;
    padding: 1px 5px; border-radius: 5px; font-weight: 600;
    display: inline;
  }
  
  /* 紫色高亮（重点） */
  .purple-highlight {
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
    color: #7c3aed;
    padding: 1px 5px; border-radius: 5px; font-weight: 600;
    display: inline;
  }
  
  /* 备注块样式 - 使用inline-block但允许扩展 */
  .note-block {
    display: inline-block;
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    border: 1px solid #fcd34d;
    border-left: 4px solid #f59e0b;
    padding: 12px 16px;
    margin: 8px 4px;
    border-radius: 0 8px 8px 0;
    font-size: 0.85em;
    color: #78350f;
    vertical-align: top;
    min-width: 100px;
    max-width: 100%;
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.6;
    box-sizing: border-box;
  }
  .note-block::before {
    content: "📝 ";
  }
  /* 当note-block在表格单元格内时，改为block显示 */
  td .note-block,
  th .note-block {
    display: block;
    max-width: none;
    margin: 8px 0;
  }
  [data-theme="dark"] .note-block {
    background: linear-gradient(135deg, #422006 0%, #451a03 100%);
    border-color: #92400e;
    color: #fcd34d;
  }
  
  /* 问题块样式 */
  .issue-block {
    display: inline-block;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-left: 3px solid #ef4444;
    padding: 6px 12px;
    margin: 4px 2px;
    border-radius: 0 6px 6px 0;
    font-size: 0.9em;
    color: #b91c1c;
    vertical-align: middle;
  }
  .issue-block::before {
    content: "⚠️ ";
    font-weight: 600;
  }
  [data-theme="dark"] .issue-block {
    background: #450a0a;
    border-color: #7f1d1d;
    color: #fca5a5;
  }
  
  /* 单元格级字号覆盖 */
  td.cell-size-sm, td.cell-size-sm * { font-size: 14px !important; }
  td.cell-size-md, td.cell-size-md * { font-size: 17px !important; }
  td.cell-size-lg, td.cell-size-lg * { font-size: 20px !important; }
  
  /* 浮动工具栏字号按钮样式 */
  .btn-size { color: #6b7280; font-weight: 600; }
  
  .green-tag {
    display: inline-block;
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); 
    color: #047857;
    padding: 3px 10px; border-radius: 6px; font-weight: 600;
    font-size: 0.9em; margin-right: 6px;
    white-space: nowrap;
    box-shadow: 0 1px 2px rgba(16,185,129,0.15);
  }
  .yellow-tag {
    display: inline-block;
    background: linear-gradient(135deg, #fef9c3 0%, #fee2b3 100%);
    color: #b45309;
    padding: 3px 10px; border-radius: 6px; font-weight: 600;
    font-size: 0.9em; margin-right: 6px;
    white-space: nowrap;
    box-shadow: 0 1px 2px rgba(245,158,11,0.15);
  }
  
  .error-text {
    color: #DC2626; 
    font-weight: 600;
    text-decoration: underline; 
    text-decoration-style: wavy; 
    text-decoration-color: #FCA5A5;
    text-underline-offset: 3px;
  }
  .error-tag {
    display: inline-block;
    font-size: 0.7em; 
    background: #FEF2F2; 
    color: #B91C1C;
    padding: 2px 6px; 
    border-radius: 4px; 
    margin-left: 2px;
    vertical-align: middle; 
    font-weight: 600; 
    border: 1px solid #FECACA; 
    user-select: none;
    line-height: 1.2;
  }
  /* Filler 高亮 - 橙黄色 */
  .filler { 
    color: #b45309; 
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); 
    padding: 2px 6px; 
    border-radius: 4px; 
    font-weight: 600;
    border-bottom: 2px solid #f59e0b;
  }
  /* 重复高亮 - 红橙色 */
  .repeat { 
    color: #b91c1c; 
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); 
    padding: 2px 6px; 
    border-radius: 4px;
    font-weight: 600;
    border-bottom: 2px solid #f97316;
  }
  /* Filler + Repeat 双重高亮 */
  .filler.repeat {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
    border-bottom: 2px solid #ef4444;
  }

  /* Toolbar & Modal */
  .floating-toolbar {
    position: absolute; display: none;
    align-items: center; gap: 2px;
    background: var(--card-bg); padding: 8px 10px;
    border-radius: 999px;
    box-shadow: 0 18px 40px rgba(148, 163, 184, 0.4), 0 0 0 1px var(--border);
    z-index: 9999; border: 1px solid var(--border);
    white-space: nowrap;
  }
  .floating-toolbar button {
    border: none; background: transparent; color: var(--text-muted);
    padding: 7px 10px; border-radius: 999px; font-size: 13px; font-weight: 500; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .floating-toolbar button:hover { background: var(--primary-light); color: var(--text-dark); }
  
  .btn-hl { color: #D97706; background: #fffbeb; }
  .btn-hl:hover { background: #fef3c7; }
  .btn-err { color: #dc2626; }
  .btn-err:hover { background: #fef2f2; }

  /* Recorder Button */
  .btn-recorder { 
    background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%) !important; 
    color: white !important; 
    border: none !important;
  }
  .btn-recorder:hover { 
    background: linear-gradient(135deg, #db2777 0%, #e11d48 100%) !important; 
    transform: scale(1.02);
  }

  /* Recorder Panel */
  .recorder-panel {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 420px;
    background: var(--card-bg);
    border-radius: 24px;
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px var(--border);
    z-index: 10001;
    overflow: hidden;
  }
  .recorder-panel.open { display: block; }
  
  .recorder-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 24px;
    background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);
    color: white;
    font-weight: 600;
    font-size: 16px;
  }
  .recorder-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }
  .recorder-close:hover { background: rgba(255,255,255,0.3); }
  
  .recorder-body {
    padding: 24px;
  }
  
  .recorder-timer {
    font-size: 48px;
    font-weight: 700;
    text-align: center;
    color: var(--text-dark);
    font-family: ui-monospace, monospace;
    margin-bottom: 16px;
    letter-spacing: 2px;
  }
  .recorder-timer.recording {
    color: #ef4444;
    animation: pulse 1s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }
  
  .recorder-waveform {
    height: 80px;
    background: var(--surface);
    border-radius: 12px;
    margin-bottom: 20px;
    overflow: hidden;
    position: relative;
    border: 1px solid var(--border);
  }
  .recorder-waveform canvas {
    width: 100%;
    height: 100%;
  }
  
  .recorder-controls {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .rec-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 12px 20px;
    border: none;
    border-radius: 999px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .rec-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  .rec-btn .rec-icon {
    font-size: 12px;
  }
  
  .rec-btn-record {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
  }
  .rec-btn-record:hover:not(:disabled) { 
    transform: scale(1.05); 
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  }
  .rec-btn-record.recording {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    animation: recording-pulse 1.5s infinite;
  }
  @keyframes recording-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
    50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
  }
  
  .rec-btn-stop {
    background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    color: white;
  }
  .rec-btn-stop:hover:not(:disabled) { transform: scale(1.05); }
  
  .rec-btn-play {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
  }
  .rec-btn-play:hover:not(:disabled) { transform: scale(1.05); }
  .rec-btn-play.playing {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }
  
  .rec-btn-download {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
  }
  .rec-btn-download:hover:not(:disabled) { transform: scale(1.05); }
  
  .recorder-status {
    text-align: center;
    font-size: 13px;
    color: var(--text-muted);
    padding: 8px;
    background: var(--surface);
    border-radius: 8px;
  }
  
  /* Recorder overlay */
  .recorder-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.5);
    backdrop-filter: blur(4px);
    z-index: 10000;
  }
  .recorder-overlay.open { display: block; }

  /* Toast */
  #toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: #1e293b; color: white; padding: 12px 20px; border-radius: 12px;
    font-size: 13px; font-weight: 500; opacity: 0; pointer-events: none; 
    transition: opacity 0.3s, transform 0.3s; z-index: 10000;
    box-shadow: var(--shadow-lg);
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(-4px); }

  /* Modal 通用样式 */
  .modal {
    position: fixed; inset: 0; background: rgba(15,23,42,0.6); backdrop-filter: blur(4px);
    display: none; align-items: center; justify-content: center; z-index: 1000;
  }
  .modal.open { display: flex; }
  .modal-content { 
    background: var(--card-bg); width: 900px; max-width: 95vw; max-height: 90vh;
    border-radius: 20px; padding: 32px; box-shadow: var(--shadow-lg);
    overflow-y: auto;
  }
  .modal-content.modal-content-wide {
    width: 1000px;
    padding: 0;
  }
  .modal-content h3 {
    margin-top: 0;
    color: var(--text-dark);
    font-weight: 600;
  }
  
  /* 导入弹窗标签切换 */
  .modal-header-tabs {
    display: flex;
    border-bottom: 2px solid var(--border);
    padding: 0;
  }
  .modal-tab {
    flex: 1;
    padding: 16px 24px;
    border: none;
    background: transparent;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
  }
  .modal-tab:hover {
    color: var(--text-dark);
    background: var(--primary-light);
  }
  .modal-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }
  .import-tab-content {
    display: none;
    padding: 24px;
  }
  .import-tab-content.active {
    display: block;
  }
  
  /* 批量导入列表 */
  .batch-md-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-height: 50vh;
    overflow-y: auto;
    padding-right: 8px;
  }
  .batch-md-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
  }
  .batch-md-item-header {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    align-items: center;
  }
  .batch-md-item-num {
    width: 28px;
    height: 28px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 13px;
    flex-shrink: 0;
  }
  .batch-md-item-inputs {
    display: flex;
    gap: 12px;
    flex: 1;
  }
  .batch-md-item-inputs input,
  .batch-md-item-inputs select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
    background: var(--card-bg);
  }
  .batch-md-item-inputs input:first-child {
    width: 120px;
  }
  .batch-md-item-remove {
    padding: 6px 10px;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 6px;
  }
  .batch-md-item-remove:hover {
    background: #fee2e2;
    color: #dc2626;
  }
  .batch-md-item textarea {
    width: 100%;
    height: 120px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: ui-monospace, SFMono-Regular, monospace;
    font-size: 13px;
    background: var(--card-bg);
    resize: vertical;
  }
  .batch-md-item textarea:focus {
    outline: none;
    border-color: var(--primary);
  }
  .batch-md-actions {
    margin-top: 12px;
  }
  
  /* 批改队列指示器 */
  .correction-queue {
    display: none;
    background: linear-gradient(135deg, #dbeafe 0%, #ede9fe 100%);
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 16px;
  }
  .correction-queue.show {
    display: block;
  }
  .correction-queue-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .correction-queue-title {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 14px;
  }
  .correction-queue-actions {
    display: flex;
    gap: 8px;
  }
  .correction-queue-list {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .correction-queue-item {
    padding: 6px 12px;
    background: white;
    border: 2px solid transparent;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .correction-queue-item:hover {
    border-color: var(--primary);
  }
  .correction-queue-item.active {
    background: var(--primary);
    color: white;
  }
  .correction-queue-item .status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #d1d5db;
  }
  .correction-queue-item.exported .status {
    background: #10b981;
  }
  
  #mdTextarea {
    width: 100%; height: 400px; margin: 16px 0; padding: 16px;
    border: 1px solid var(--border); border-radius: 12px;
    font-family: ui-monospace, SFMono-Regular, monospace; font-size: 13px; 
    background: var(--surface); resize: vertical;
    transition: all 0.15s;
    color: var(--text-dark);
  }
  #mdTextarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
  }

  /* 设置面板样式 */
  .settings-panel {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    max-width: 95vw;
    max-height: 90vh;
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
    z-index: 10001;
    overflow-y: auto;
  }
  .settings-panel.open { display: block; }
  .settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--primary-light);
  }
  .settings-header h3 {
    margin: 0;
    font-size: 18px;
    color: var(--text-dark);
  }
  .settings-close {
    background: transparent;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    padding: 4px 8px;
    border-radius: 6px;
  }
  .settings-close:hover { background: var(--border); }
  .settings-body {
    padding: 24px;
  }
  .settings-section {
    margin-bottom: 24px;
  }
  .settings-section:last-child { margin-bottom: 0; }
  .settings-section h4 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dark);
    margin: 0 0 12px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .settings-section h4 .icon { font-size: 16px; }
  .settings-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }
  .settings-row label {
    min-width: 80px;
    font-size: 13px;
    color: var(--text-muted);
  }
  .settings-row select, .settings-row input[type="text"] {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 13px;
    background: var(--surface);
    color: var(--text-dark);
  }
  .filler-words-input {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 13px;
    background: var(--surface);
    color: var(--text-dark);
    min-height: 80px;
    resize: vertical;
    font-family: ui-monospace, monospace;
  }
  .settings-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
  }

  /* 模板管理面板 */
  .template-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 12px;
  }
  .template-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
  }
  .template-item:last-child { border-bottom: none; }
  .template-item:hover { background: var(--primary-light); }
  .template-item.active { background: var(--primary-light); }
  .template-item-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-dark);
  }
  .template-item-actions {
    display: flex;
    gap: 6px;
  }
  .template-item-actions button {
    padding: 4px 8px;
    font-size: 11px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .template-textarea {
    width: 100%;
    height: 150px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 12px;
    background: var(--surface);
    color: var(--text-dark);
    font-family: ui-monospace, monospace;
    resize: vertical;
  }

  /* 快捷键提示 */
  .shortcut-hint {
    position: fixed;
    bottom: 80px;
    right: 20px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: var(--shadow-lg);
    font-size: 12px;
    z-index: 100;
    display: none;
  }
  .shortcut-hint.show { display: block; }
  .shortcut-hint h4 {
    margin: 0 0 10px 0;
    font-size: 13px;
    color: var(--text-dark);
  }
  .shortcut-hint ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .shortcut-hint li {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    padding: 4px 0;
    color: var(--text-muted);
  }
  .shortcut-hint kbd {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 6px;
    font-family: ui-monospace, monospace;
    font-size: 11px;
  }

  /* 自动保存指示器 */
  .autosave-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 8px 16px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 500;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s;
    z-index: 100;
  }
  .autosave-indicator.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* Collapsible sections */
  .collapsible-header {
    cursor: pointer;
    user-select: none;
    transition: opacity 0.15s;
  }
  .collapsible-header:hover {
    opacity: 0.85;
  }
  .collapse-icon {
    transition: transform 0.2s;
    font-size: 12px;
  }
  .collapsed .collapse-icon {
    transform: rotate(-90deg);
  }
  .collapsible-content {
    max-height: 2000px;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  .collapsed .collapsible-content {
    max-height: 0;
  }

  /* Editable areas styling */
  [contenteditable="true"]:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
    border-radius: 4px;
  }
  [contenteditable="true"]:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted);
    font-style: italic;
  }
  #answerContent:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted);
    font-style: italic;
  }
  td[data-placeholder]:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted);
    font-style: italic;
  }

  /* Print styles */
  @media print {
    .toolbar, .floating-toolbar { display: none !important; }
    .wrap { width: 100% !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
    #captureArea { box-shadow: none !important; border: none !important; }
  }

  /* 音频上传预留区域 */
  .audio-upload-section {
    background: var(--surface);
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    margin: 16px 0;
    cursor: pointer;
    transition: all 0.2s;
  }
  .audio-upload-section:hover {
    border-color: var(--primary);
    background: var(--primary-light);
  }
  .audio-upload-section .upload-icon {
    font-size: 32px;
    margin-bottom: 8px;
  }
  .audio-upload-section .upload-text {
    font-size: 14px;
    color: var(--text-muted);
  }
  .audio-upload-section .upload-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
  }
  .audio-upload-section.coming-soon {
    opacity: 0.6;
    cursor: default;
  }
  .audio-upload-section.coming-soon:hover {
    border-color: var(--border);
    background: var(--surface);
  }
  
  /* ==================== 模式切换标签 ==================== */
  .mode-tabs {
    display: flex;
    gap: 0;
    padding: 0 32px;
    background: var(--surface);
    border-bottom: 2px solid var(--border);
  }
  .mode-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
  }
  .mode-tab:hover {
    color: var(--text-dark);
    background: var(--primary-light);
  }
  .mode-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
    background: transparent;
  }
  .mode-tab-key {
    display: inline-block;
    padding: 2px 6px;
    background: var(--border);
    color: var(--text-muted);
    font-size: 11px;
    font-weight: 600;
    border-radius: 4px;
  }
  .mode-tab.active .mode-tab-key {
    background: var(--primary);
    color: white;
  }
  .mode-tab-label {
    font-size: 14px;
  }
  
  /* 模式内容切换 */
  .mode-content {
    display: none;
  }
  .mode-content.active {
    display: block;
  }
  
  /* ==================== 快速检测样式 ==================== */
  .quick-check-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 32px;
  }
  .quick-check-header {
    text-align: center;
    margin-bottom: 32px;
  }
  .quick-check-header h2 {
    font-size: 28px;
    color: var(--text-dark);
    margin: 0 0 8px 0;
  }
  .quick-check-header p {
    color: var(--text-muted);
    font-size: 15px;
    margin: 0;
  }
  
  .quick-check-input-section {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow-md);
    margin-bottom: 24px;
  }
  .quick-check-row {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .quick-input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .quick-input-group label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
  }
  .quick-input-group input,
  .quick-input-group select {
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    background: var(--surface);
    color: var(--text-dark);
    min-width: 160px;
  }
  .quick-input-group input:focus,
  .quick-input-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
  }
  
  .quick-textarea-wrapper {
    position: relative;
  }
  .quick-textarea-wrapper textarea {
    width: 100%;
    height: 180px;
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 15px;
    line-height: 1.6;
    resize: vertical;
    background: var(--surface);
    color: var(--text-dark);
  }
  .quick-textarea-wrapper textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
  }
  .btn-analyze {
    position: absolute;
    bottom: 16px;
    right: 16px;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
  }
  
  /* 分析结果 */
  .quick-results {
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .quick-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .quick-stat-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
  }
  .quick-stat-card.warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
    border-color: #fcd34d;
  }
  .quick-stat-card.warning .stat-value {
    color: #b45309;
  }
  .quick-stat-card .stat-icon {
    font-size: 24px;
    margin-bottom: 8px;
  }
  .quick-stat-card .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
  }
  .quick-stat-card .stat-label {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 8px;
  }
  .quick-stat-card .stat-sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
    padding: 2px 8px;
    background: rgba(0,0,0,0.05);
    border-radius: 10px;
    display: inline-block;
  }
  
  /* WPM等级颜色 */
  .wpm-very-slow { color: #dc2626 !important; }
  .wpm-slow { color: #f97316 !important; }
  .wpm-normal { color: #10b981 !important; }
  .wpm-fast { color: #3b82f6 !important; }
  .wpm-very-fast { color: #8b5cf6 !important; }
  
  /* 详情区块 */
  .quick-detail-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow-sm);
  }
  .quick-detail-section h4 {
    margin: 0 0 12px 0;
    font-size: 15px;
    color: var(--text-dark);
  }
  .filler-breakdown {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .filler-tag {
    display: inline-flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: #fef3c7;
    border: 1px solid #fcd34d;
    border-radius: 12px;
    font-size: 13px;
    max-width: 200px;
  }
  .filler-tag .filler-word {
    font-weight: 600;
    color: #92400e;
  }
  .filler-tag .filler-count {
    background: #f59e0b;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
  }
  .filler-tag .filler-note {
    width: 100%;
    font-size: 11px;
    color: #78350f;
    font-style: italic;
    margin-top: 2px;
  }
  
  .repeat-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .repeat-tag {
    padding: 6px 12px;
    background: #fee2e2;
    border: 1px solid #fca5a5;
    border-radius: 20px;
    font-size: 13px;
    color: #991b1b;
  }
  
  /* 标注文本 */
  .quick-annotated-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow-sm);
  }
  .quick-annotated-section h4 {
    margin: 0 0 12px 0;
    font-size: 15px;
    color: var(--text-dark);
  }
  .annotated-text {
    padding: 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    line-height: 1.8;
    font-size: 15px;
  }
  .annotated-text mark.filler {
    background: #fef3c7;
    padding: 2px 4px;
    border-radius: 3px;
    border-bottom: 2px solid #f59e0b;
  }
  .annotated-text mark.repeat {
    background: #fee2e2;
    padding: 2px 4px;
    border-radius: 3px;
    border-bottom: 2px solid #ef4444;
  }
  .annotated-legend {
    display: flex;
    gap: 16px;
    margin-top: 12px;
    font-size: 12px;
    color: var(--text-muted);
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  /* 输入方式切换 */
  .input-method-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 16px;
    background: var(--surface);
    border-radius: 10px;
    padding: 4px;
    border: 1px solid var(--border);
  }
  .input-tab {
    flex: 1;
    padding: 10px 16px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
  }
  .input-tab:hover {
    color: var(--text-dark);
  }
  .input-tab.active {
    background: var(--primary);
    color: white;
  }
  .input-method-content {
    display: none;
  }
  .input-method-content.active {
    display: block;
  }
  
  /* 音频上传区域 */
  .audio-upload-area {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--surface);
  }
  .audio-upload-area:hover {
    border-color: var(--primary);
    background: var(--primary-light);
  }
  .audio-upload-area.dragover {
    border-color: var(--primary);
    background: var(--primary-light);
  }
  .upload-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }
  .upload-text {
    font-size: 16px;
    color: var(--text-dark);
    margin-bottom: 8px;
  }
  .upload-hint {
    font-size: 13px;
    color: var(--text-muted);
  }
  
  /* 音频预览 */
  .audio-preview {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
  }
  .audio-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .audio-name {
    font-weight: 500;
    color: var(--text-dark);
  }
  .audio-duration {
    color: var(--text-muted);
    font-size: 13px;
  }
  .audio-preview audio {
    width: 100%;
    margin-bottom: 12px;
  }
  .audio-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
  
  /* Whisper进度 */
  .whisper-progress {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 20px;
    background: var(--primary-light);
    border-radius: 10px;
    color: var(--primary);
    font-weight: 500;
  }
  .whisper-spinner {
    width: 20px;
    height: 20px;
    border: 3px solid var(--primary-light);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Whisper Key提示 */
  .whisper-key-hint {
    margin-top: 12px;
    padding: 12px;
    background: #fef3c7;
    border-radius: 8px;
    font-size: 13px;
    color: #92400e;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .whisper-key-hint a {
    color: #b45309;
    font-weight: 500;
  }
  
  /* 填充词备注提示 */
  .filler-note {
    font-size: 11px;
    color: var(--text-muted);
    font-style: italic;
  }
  .annotated-text .filler-tooltip {
    position: relative;
    cursor: help;
  }
  .annotated-text .filler-tooltip::after {
    content: attr(data-note);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #1e293b;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .annotated-text .filler-tooltip:hover::after {
    opacity: 1;
  }
  
  /* 操作按钮 */
  .quick-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
  }
  
  /* ==================== 批量处理样式 ==================== */
  .batch-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 32px;
  }
  .batch-header {
    text-align: center;
    margin-bottom: 32px;
  }
  .batch-header h2 {
    font-size: 28px;
    color: var(--text-dark);
    margin: 0 0 8px 0;
  }
  .batch-header p {
    color: var(--text-muted);
    font-size: 15px;
    margin: 0;
  }
  
  .batch-input-section {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow-md);
    margin-bottom: 24px;
  }
  
  .batch-settings {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .batch-setting-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .batch-setting-item label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
  }
  .batch-setting-item select,
  .batch-setting-item input {
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    background: var(--surface);
    min-width: 160px;
  }
  
  .batch-entries {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
    max-height: 400px;
    overflow-y: auto;
  }
  
  .batch-entry {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    padding: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    transition: border-color 0.2s;
  }
  .batch-entry:focus-within {
    border-color: var(--primary);
  }
  .batch-entry-num {
    width: 28px;
    height: 28px;
    background: var(--primary-light);
    color: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 13px;
    flex-shrink: 0;
    margin-top: 8px;
  }
  .batch-entry-fields {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .batch-entry-row {
    display: flex;
    gap: 12px;
  }
  .batch-entry-name {
    width: 120px;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
  }
  .batch-entry-text {
    flex: 1;
    min-height: 60px;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
    resize: vertical;
  }
  .batch-entry-remove {
    padding: 6px 10px;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
    margin-top: 8px;
  }
  .batch-entry-remove:hover {
    background: #fee2e2;
    color: #dc2626;
  }
  
  .batch-add-row {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }
  
  .batch-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }
  .btn-lg {
    padding: 14px 28px;
    font-size: 16px;
  }
  
  /* 批量结果 */
  .batch-results {
    animation: fadeIn 0.3s ease;
  }
  .batch-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .batch-results-header h3 {
    margin: 0;
    font-size: 20px;
    color: var(--text-dark);
  }
  .batch-results-actions {
    display: flex;
    gap: 8px;
  }
  .btn-sm {
    padding: 6px 12px;
    font-size: 13px;
  }
  .btn-xs {
    padding: 4px 10px;
    font-size: 12px;
  }
  
  .batch-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }
  .summary-card {
    background: var(--card-bg);
    border-radius: 10px;
    padding: 16px;
    text-align: center;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
  }
  .summary-card.warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
    border-color: #fcd34d;
  }
  .summary-card .summary-label {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 4px;
  }
  .summary-card .summary-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
  }
  .summary-card.warning .summary-value {
    color: #b45309;
  }
  
  .batch-table-wrapper {
    background: var(--card-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }
  .batch-table {
    width: 100%;
    border-collapse: collapse;
  }
  .batch-table th {
    background: var(--border);
    padding: 12px 16px;
    text-align: left;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dark);
  }
  .batch-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
  }
  .batch-table tr:last-child td {
    border-bottom: none;
  }
  .batch-table tr:hover {
    background: var(--primary-light);
  }
  .batch-table .wpm-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 500;
  }
  .batch-table .wpm-badge.very-slow { background: #fee2e2; color: #dc2626; }
  .batch-table .wpm-badge.slow { background: #ffedd5; color: #ea580c; }
  .batch-table .wpm-badge.normal { background: #d1fae5; color: #059669; }
  .batch-table .wpm-badge.fast { background: #dbeafe; color: #2563eb; }
  .batch-table .wpm-badge.very-fast { background: #ede9fe; color: #7c3aed; }
  .batch-table .action-btn {
    padding: 4px 8px;
    border: none;
    background: var(--primary-light);
    color: var(--primary);
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }
  .batch-table .action-btn:hover {
    background: var(--primary);
    color: white;
  }
  
  /* 批量导入弹窗 */
  .batch-import-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .batch-import-modal.show {
    display: flex;
  }
  .batch-import-content {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
  }
  .batch-import-content h3 {
    margin: 0 0 8px 0;
  }
  .batch-import-content p {
    color: var(--text-muted);
    font-size: 13px;
    margin-bottom: 16px;
  }
  .batch-import-textarea {
    width: 100%;
    height: 200px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: monospace;
    margin-bottom: 16px;
  }
  .batch-import-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
</style>
</head>
<body class="font-times size-lg">

<!-- ==================== 登录/注册界面 ==================== -->
<div class="auth-container show" id="authContainer">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-icon">👑</div>
      <h1 class="auth-logo-title">口语批改王</h1>
      <p class="auth-logo-subtitle">TOEFL · IELTS · DET 口语练习平台</p>
    </div>
    
    <div class="auth-tabs">
      <button class="auth-tab active" data-tab="login">登录</button>
      <button class="auth-tab" data-tab="register">注册</button>
    </div>
    
    <div class="auth-error" id="authError"></div>
    <div class="auth-success" id="authSuccess"></div>
    
    <!-- 登录表单 -->
    <form class="auth-form active" id="loginForm">
      <div class="auth-field">
        <label>邮箱</label>
        <input type="email" id="loginEmail" placeholder="your@email.com" required>
      </div>
      <div class="auth-field">
        <label>密码</label>
        <input type="password" id="loginPassword" placeholder="输入密码" required>
      </div>
      <button type="submit" class="auth-btn auth-btn-primary" id="loginBtn">登录</button>
    </form>
    
    <!-- 注册表单 -->
    <form class="auth-form" id="registerForm">
      <div class="auth-field">
        <label>邮箱</label>
        <input type="email" id="registerEmail" placeholder="your@email.com" required>
      </div>
      <div class="auth-field">
        <label>昵称</label>
        <input type="text" id="registerName" placeholder="你的昵称" required>
      </div>
      <div class="auth-field">
        <label>密码</label>
        <input type="password" id="registerPassword" placeholder="至少6位" minlength="6" required>
      </div>
      <button type="submit" class="auth-btn auth-btn-primary" id="registerBtn">注册</button>
    </form>
    
    <div class="auth-divider"><span>或</span></div>
    
    <button class="auth-btn" style="background:#f1f5f9; color:var(--text-body);" id="guestBtn">
      👤 游客模式（数据仅保存在本地）
    </button>
  </div>
</div>

<div class="wrap" id="mainWrap" style="display:none;">
  <!-- 自动保存指示器 -->
  <div class="autosave-indicator" id="autosaveIndicator">✓ 已自动保存</div>
  
  <!-- 工具栏 -->
  <div class="toolbar">
    <div class="toolbar-left">
      <div class="app-title">
        <span>口语批改王</span>
        <span class="app-tag">v81</span>
      </div>
      <!-- 用户信息 -->
      <div class="user-info" id="userInfo">
        <div class="user-avatar" id="userAvatar">U</div>
        <span id="userName">用户</span>
        <button class="user-logout" id="logoutBtn">退出</button>
      </div>
      <div class="input-group" style="margin-left: 12px;">
        <span>字体:</span>
        <select id="fontSelect" onchange="changeFont()">
          <option value="font-times" selected>Times</option>
          <option value="font-georgia">Georgia</option>
        </select>
        <select id="fontSizeSelect" onchange="changeFontSize()">
          <option value="size-lg" selected>大</option>
          <option value="size-xl">特大</option>
          <option value="size-xxl">超大</option>
        </select>
      </div>
      <button class="btn btn-theme" id="themeToggle" title="切换深色/浅色模式">🌙</button>
    </div>
    <div class="toolbar-right">
      <div class="input-group">
        <span>题型:</span>
        <select id="taskType" class="task-select">
          <option value="独立口语 Task 1">🎤 独立口语</option>
          <option value="综合口语 Task 2-4">📚 综合口语</option>
        </select>
      </div>
      <div class="input-group">
        <span>宽度:</span>
        <select id="widthSelect" onchange="changeWidth()">
          <option value="1000px">窄</option>
          <option value="1200px">中</option>
          <option value="1400px" selected>标准</option>
          <option value="1800px">宽</option>
        </select>
      </div>
      <button class="btn btn-ghost" id="detectBtn" title="自动检测 (Ctrl+D)">检测</button>
      <button class="btn btn-ghost" id="openMdBtn" title="导入 Markdown (Ctrl+E)">导入</button>
      <button class="btn btn-purple" id="aiCorrectionBtn" title="AI智能批改">🤖 AI批改</button>
      <button class="btn btn-ghost" id="settingsBtn" title="设置">⚙️</button>
      <button class="btn btn-ghost" id="templateBtn" title="模板管理">📋</button>
      <button class="btn btn-recorder" id="recorderBtn" title="录音练习">🎙️ 录音</button>
      <!-- 导出下拉菜单 -->
      <div class="export-dropdown" id="exportDropdown">
        <button class="btn btn-orange export-dropdown-btn" id="exportMainBtn">
          导出 ▾
        </button>
        <div class="export-dropdown-menu" id="exportMenu">
          <button data-export="all">📦 全部导出 <kbd>Tab→5</kbd></button>
          <button data-export="main">📝 批改表+思路 <kbd>Tab→4</kbd></button>
          <div class="export-dropdown-divider"></div>
          <button data-export="part1">批改表</button>
          <button data-export="part2">思路+总评</button>
          <button data-export="part3">练习+答案</button>
        </div>
      </div>
      <button class="btn btn-danger" id="clearAllBtn" title="清空全部">清空</button>
    </div>
  </div>

  <!-- 模式切换标签 -->
  <div class="mode-tabs">
    <button class="mode-tab active" data-mode="full" id="modeFullBtn">
      <span class="mode-tab-key">F1</span>
      <span class="mode-tab-label">完整批改</span>
    </button>
    <button class="mode-tab" data-mode="quick" id="modeQuickBtn">
      <span class="mode-tab-key">F2</span>
      <span class="mode-tab-label">课堂快速检测</span>
    </button>
    <button class="mode-tab" data-mode="batch" id="modeBatchBtn">
      <span class="mode-tab-key">F3</span>
      <span class="mode-tab-label">批量处理</span>
    </button>
  </div>

  <!-- 录音面板 -->
  <div class="recorder-panel" id="recorderPanel">
    <div class="recorder-header">
      <span>🎙️ 口语录音练习</span>
      <button class="recorder-close" id="closeRecorderBtn">×</button>
    </div>
    <div class="recorder-body">
      <div class="recorder-timer" id="recorderTimer">00:00</div>
      <div class="recorder-waveform" id="waveformContainer">
        <canvas id="waveformCanvas"></canvas>
      </div>
      <div class="recorder-controls">
        <button class="rec-btn rec-btn-record" id="startRecBtn" title="开始录音">
          <span class="rec-icon">●</span> 开始
        </button>
        <button class="rec-btn rec-btn-stop" id="stopRecBtn" title="停止录音" disabled>
          <span class="rec-icon">■</span> 停止
        </button>
        <button class="rec-btn rec-btn-play" id="playRecBtn" title="播放录音" disabled>
          <span class="rec-icon">▶</span> 播放
        </button>
        <button class="rec-btn rec-btn-download" id="downloadRecBtn" title="下载录音" disabled>
          <span class="rec-icon">⬇</span> 下载
        </button>
      </div>
      <div class="recorder-status" id="recorderStatus">点击"开始"按钮开始录音</div>
      
      <!-- 音频上传预留区域 -->
      <div class="audio-upload-section coming-soon" id="audioUploadArea">
        <div class="upload-icon">📤</div>
        <div class="upload-text">上传音频文件</div>
        <div class="upload-hint">🔜 即将支持 - Whisper API 自动转录</div>
      </div>
      
      <audio id="audioPlayback" style="display:none;"></audio>
    </div>
  </div>

  <!-- AI批改面板 -->
  <div class="ai-panel" id="aiPanel">
    <div class="ai-panel-header">
      <h3>🤖 AI 智能批改</h3>
      <button class="ai-panel-close" id="closeAiPanelBtn">×</button>
    </div>
    <div class="ai-panel-body">
      <!-- 模式切换 -->
      <div class="ai-mode-tabs">
        <button class="ai-mode-tab active" data-mode="copy">📋 复制粘贴模式（推荐）</button>
        <button class="ai-mode-tab" data-mode="api">🔑 API自动模式</button>
      </div>
      
      <!-- ========== 复制粘贴模式 ========== -->
      <div class="ai-mode-content" id="copyMode">
        <div class="ai-info-box">
          <div class="ai-info-title">💡 适合有ChatGPT账户的用户（3步完成）</div>
          <ol class="ai-steps">
            <li>输入学生转录 → 点击"生成Prompt"</li>
            <li>打开 <a href="https://chat.openai.com" target="_blank">chat.openai.com</a> → 粘贴发送</li>
            <li>复制ChatGPT回复 → 点击"导入结果"</li>
          </ol>
        </div>
        
        <div class="ai-section">
          <div class="ai-section-title"><span class="icon">📝</span> 学生口语转录</div>
          <textarea id="studentTranscript" class="ai-transcript-input" placeholder="粘贴学生的口语转录文本...&#10;可以从 Descript / Whisper / 飞书妙记 等工具复制"></textarea>
        </div>
        
        <div class="ai-section">
          <div class="ai-section-title"><span class="icon">💬</span> 口语话题（可选）</div>
          <input type="text" id="aiTopic" class="ai-topic-input" placeholder="例如：Do you think celebrities have a responsibility to be role models?">
        </div>
        
        <div class="ai-section" id="promptSection" style="display:none;">
          <div class="ai-section-title">
            <span class="icon">📄</span> 生成的Prompt
            <button class="btn btn-sm btn-primary" id="copyPromptBtn">📋 一键复制</button>
          </div>
          <textarea id="generatedPrompt" class="ai-prompt-output" readonly></textarea>
          <div class="ai-hint" style="margin-top:8px;">✅ 已复制！现在去 ChatGPT 粘贴发送，然后复制回复回来</div>
        </div>
        
        <div class="ai-section" id="responseSection" style="display:none;">
          <div class="ai-section-title"><span class="icon">🤖</span> 粘贴ChatGPT的回复</div>
          <textarea id="chatgptResponse" class="ai-response-input" placeholder="把ChatGPT的完整回复粘贴到这里..."></textarea>
        </div>
        
        <div class="ai-actions">
          <button class="btn btn-purple" id="generatePromptBtn">📝 Step 1: 生成Prompt</button>
          <button class="btn btn-success" id="importResponseBtn" style="display:none;">✨ Step 3: 导入结果</button>
        </div>
      </div>
      
      <!-- ========== API自动模式 ========== -->
      <div class="ai-mode-content" id="apiMode" style="display:none;">
        <!-- AI提供商选择 -->
        <div class="ai-section">
          <div class="ai-section-title"><span class="icon">🤖</span> 选择AI提供商</div>
          <div class="ai-provider-grid">
            <label class="ai-provider-option">
              <input type="radio" name="aiProvider" value="deepseek" checked>
              <div class="provider-card">
                <div class="provider-name">🔥 DeepSeek</div>
                <div class="provider-price">¥1/百万token · 性价比最高</div>
              </div>
            </label>
            <label class="ai-provider-option">
              <input type="radio" name="aiProvider" value="openai">
              <div class="provider-card">
                <div class="provider-name">OpenAI GPT-4o</div>
                <div class="provider-price">$2.5/百万token</div>
              </div>
            </label>
            <label class="ai-provider-option">
              <input type="radio" name="aiProvider" value="openai-o1">
              <div class="provider-card">
                <div class="provider-name">🧠 OpenAI o1</div>
                <div class="provider-price">$15/百万token · 深度思考</div>
              </div>
            </label>
            <label class="ai-provider-option">
              <input type="radio" name="aiProvider" value="gemini">
              <div class="provider-card">
                <div class="provider-name">🆓 Google Gemini</div>
                <div class="provider-price">有免费额度</div>
              </div>
            </label>
          </div>
        </div>
        
        <div class="ai-section">
          <div class="ai-section-title">
            <span class="icon">🔑</span> API Key
            <span class="ai-key-status" id="aiKeyStatus"></span>
          </div>
          <div class="ai-key-row">
            <input type="password" id="openaiApiKey" placeholder="粘贴你的API Key..." class="ai-key-input">
            <button class="btn btn-ghost btn-sm" id="toggleKeyVisibility">👁</button>
            <button class="btn btn-primary btn-sm" id="saveApiKeyBtn">保存</button>
          </div>
          <div class="ai-hint" id="apiHint">
            💡 <b>DeepSeek获取方式：</b><a href="https://platform.deepseek.com" target="_blank">platform.deepseek.com</a> → 注册 → API Keys → 创建
          </div>
        </div>
        
        <div class="ai-section">
          <div class="ai-section-title"><span class="icon">📝</span> 学生口语转录</div>
          <textarea id="studentTranscriptApi" class="ai-transcript-input" placeholder="粘贴学生的口语转录文本..."></textarea>
        </div>
        
        <div class="ai-section">
          <div class="ai-section-title"><span class="icon">💬</span> 口语话题（可选）</div>
          <input type="text" id="aiTopicApi" class="ai-topic-input" placeholder="例如：Do you think celebrities have a responsibility...">
        </div>
        
        <!-- 自定义批改要求 -->
        <div class="ai-section">
          <div class="ai-section-title">
            <span class="icon">⚙️</span> 自定义批改要求（可选）
            <button class="btn btn-ghost btn-xs" id="toggleCustomPrompt">展开</button>
          </div>
          <div class="custom-prompt-container" id="customPromptContainer" style="display:none;">
            <textarea id="customPromptInput" class="ai-custom-prompt" placeholder="输入你的个性化批改要求，例如：&#10;- 重点关注中式英语表达&#10;- 每个错误给出2-3种替代表达&#10;- 用鼓励的语气指出问题&#10;- 特别注意冠词和介词使用"></textarea>
            <div class="ai-hint">这些要求会添加到批改prompt中，AI会按照你的要求来批改</div>
          </div>
        </div>
        
        <div class="ai-actions">
          <button class="btn btn-purple btn-lg" id="startAiCorrectionBtn">
            <span class="ai-btn-icon">🚀</span>
            <span class="ai-btn-text">开始AI批改</span>
          </button>
          <div class="ai-progress" id="aiProgress">
            <div class="ai-progress-spinner"></div>
            <span class="ai-progress-text">正在批改中...</span>
          </div>
        </div>
        
        <div class="ai-tips">
          <div class="ai-tips-title">💰 推荐：DeepSeek</div>
          <ul>
            <li>价格只有GPT-4o的 <b>5%</b>，批改效果相当</li>
            <li>充¥10可以批改几百次！</li>
            <li>国内访问快，不需要梯子</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- 设置面板 -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <h3>⚙️ 设置</h3>
      <button class="settings-close" id="closeSettingsBtn">×</button>
    </div>
    <div class="settings-body">
      <!-- 导出设置 -->
      <div class="settings-section">
        <h4><span class="icon">📷</span> 导出设置</h4>
        <div class="settings-row">
          <label>图片格式:</label>
          <select id="exportFormat">
            <option value="png" selected>PNG (高质量)</option>
            <option value="jpeg">JPG (较小体积)</option>
          </select>
        </div>
        <div class="settings-row">
          <label>图片质量:</label>
          <select id="exportQuality">
            <option value="1">标准 (1x)</option>
            <option value="2" selected>高清 (2x)</option>
            <option value="3">超清 (3x)</option>
          </select>
        </div>
      </div>
      
      <!-- 填充词设置 -->
      <div class="settings-section">
        <h4><span class="icon">🔍</span> 填充词检测</h4>
        <textarea class="filler-words-input" id="fillerWordsInput" placeholder="每行一个填充词或短语...">um
uh
you know
I mean
like
so
basically
actually
literally</textarea>
        <div class="settings-hint">每行输入一个填充词或短语，检测时会自动识别</div>
      </div>
      
      <!-- 自动保存设置 -->
      <div class="settings-section">
        <h4><span class="icon">💾</span> 自动保存</h4>
        <div class="settings-row">
          <label>状态:</label>
          <select id="autosaveEnabled">
            <option value="true" selected>开启</option>
            <option value="false">关闭</option>
          </select>
        </div>
        <div class="settings-row">
          <button class="btn btn-ghost" id="clearCacheBtn">清除缓存数据</button>
          <button class="btn btn-ghost" id="exportDataBtn">导出数据备份</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 模板管理面板 -->
  <div class="settings-panel" id="templatePanel">
    <div class="settings-header">
      <h3>📋 Prompt 模板管理</h3>
      <button class="settings-close" id="closeTemplateBtn">×</button>
    </div>
    <div class="settings-body">
      <div style="background:#f0f9ff;padding:10px 14px;border-radius:8px;margin-bottom:14px;font-size:13px;color:#0369a1;border:1px solid #bae6fd;">
        💡 <b>用途</b>：保存你的ChatGPT批改提示词模板。点击"复制到剪贴板"后粘贴到ChatGPT使用。
      </div>
      <div class="template-list" id="templateList">
        <!-- 模板列表动态生成 -->
      </div>
      <div class="settings-row">
        <input type="text" id="newTemplateName" placeholder="新模板名称..." style="flex:1;">
        <button class="btn btn-primary" id="addTemplateBtn">添加</button>
      </div>
      <textarea class="template-textarea" id="templateContent" placeholder="在此编辑模板内容..."></textarea>
      <div class="settings-row" style="margin-top: 12px;">
        <button class="btn btn-ghost" id="copyTemplateBtn">📋 复制到剪贴板</button>
        <button class="btn btn-success" id="saveTemplateBtn">💾 保存模板</button>
      </div>
    </div>
  </div>

  <!-- F1: 完整批改模式 -->
  <div id="modeFullContent" class="mode-content active">
  
  <!-- 批改队列指示器 -->
  <div class="correction-queue" id="correctionQueue">
    <div class="correction-queue-header">
      <div class="correction-queue-title">📋 批改队列</div>
      <div class="correction-queue-actions">
        <button class="btn btn-xs btn-ghost" id="clearQueueBtn">清空队列</button>
        <button class="btn btn-xs btn-primary" id="exportAllQueueBtn">📦 全部导出</button>
      </div>
    </div>
    <div class="correction-queue-list" id="correctionQueueList">
      <!-- 动态生成 -->
    </div>
  </div>
  
  <!-- 导出区域 -->
  <div id="captureArea">
    
    <!-- === Block 1：批改表（只有表格） === -->
    <div id="capturePart1">
    
    <!-- 头部：日期 + 题目 -->
    <div class="header-section">
      <div class="header-date-topic" contenteditable="true" id="headerTitle" data-placeholder="日期 – 话题标题"></div>
      
      <!-- 学生信息栏 -->
      <div class="student-info-bar">
        <div class="student-info-item">
          <label>学生:</label>
          <input type="text" id="studentName" placeholder="输入或选择" list="studentNameList" autocomplete="off">
          <datalist id="studentNameList"></datalist>
          <button class="btn-student-import" id="importStudentsBtn" title="导入学生名单">📥</button>
          <button class="btn-student-history" id="studentHistoryBtn" title="查看学生历史记录">📊</button>
          <span class="student-history-badge" id="studentHistoryBadge" title="该学生历史批改总次数"></span>
        </div>
        <div class="student-info-item">
          <label>日期:</label>
          <input type="date" id="correctionDate">
        </div>
        <div class="student-info-item">
          <label>第</label>
          <input type="number" id="correctionNumber" min="1" value="1">
          <label>次批改</label>
        </div>
        <div class="student-info-item">
          <label>背景:</label>
          <select id="bgThemeSelect" class="bg-theme-select">
            <option value="default">默认</option>
            <option value="minimal">极简</option>
            <option value="warm">暖调</option>
            <option value="cool">冷调</option>
            <option value="nature">自然</option>
            <option value="sunset">日落</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 题目信息栏 -->
    <div class="topic-bar">
      <div class="topic-bar-left">
        <div class="topic-speed">
          语速: 
          <select id="speedSelect" class="speed-select">
            <option value="很慢">很慢</option>
            <option value="较慢">较慢</option>
            <option value="正常" selected>正常</option>
            <option value="较快">较快</option>
            <option value="很快">很快</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- 核心数据仪表盘 -->
    <div class="stats-dashboard">
      <div class="stat-card words">
        <div class="stat-card-label">总字数</div>
        <div class="stat-card-value" id="wordStats">0</div>
      </div>
      <div class="stat-card filler">
        <div class="stat-card-label">填充词</div>
        <div class="stat-card-value" id="fillerStats">0</div>
      </div>
      <div class="stat-card repeat">
        <div class="stat-card-label">重复</div>
        <div class="stat-card-value" id="repeatStats">0</div>
      </div>
    </div>
    
    <!-- 错误类型统计 -->
    <div class="error-stats-bar">
      <div class="error-stats-title">错误统计</div>
      <div class="error-stats-items">
        <div class="error-stat-item grammar">
          <span class="label">语法</span>
          <span class="count" id="errGrammar">0</span>
        </div>
        <div class="error-stat-item pronunciation">
          <span class="label">发音</span>
          <span class="count" id="errPronunciation">0</span>
        </div>
        <div class="error-stat-item stress">
          <span class="label">重音</span>
          <span class="count" id="errStress">0</span>
        </div>
        <div class="error-stat-item vowel">
          <span class="label">元音</span>
          <span class="count" id="errVowel">0</span>
        </div>
      </div>
    </div>

    <!-- 批改表 -->
    <table id="correctionTable">
      <thead>
        <tr>
          <th>原句</th>
          <th>修改后</th>
          <th>详细解释</th>
        </tr>
      </thead>
      <tbody contenteditable="true" spellcheck="false">
        <tr>
          <td data-placeholder="原句..."></td>
          <td data-placeholder="修改后..."></td>
          <td data-placeholder="详细解释..."></td>
        </tr>
      </tbody>
    </table>

    </div>
    <!-- === Block 1 结束 === -->

    <!-- === Block 2：思路 + 总评 === -->
    <div id="capturePart2">

    <!-- 思路区 -->
    <table id="summaryTable">
      <tbody contenteditable="true" spellcheck="false">
      </tbody>
    </table>

    <!-- 润色后高分版本 -->
    <div class="block2-section">
      <div class="block2-title">
        润色后高分版本
        <button class="tts-btn" id="playPolishedBtn" title="播放示范音频">
          <span class="tts-icon">🔊</span>
          <span class="tts-text">播放</span>
        </button>
        <button class="tts-mode-btn" id="toggleTtsMode" title="切换语音模式">
          <span id="ttsModeText">🤖 AI语音</span>
        </button>
      </div>
      <div class="polished-content" contenteditable="true" id="polishedVersion" data-placeholder="导入 Markdown 后自动填充..."></div>
      <div class="polished-word-count">约 <span id="polishedWordCount">0</span> 词</div>
    </div>

    <!-- 总评 -->
    <div class="block2-section">
      <div class="block2-title">总评</div>
      <div class="overall-content" contenteditable="true" id="overallComment" data-placeholder="导入 Markdown 后自动填充..."></div>
    </div>

    </div>
    <!-- === Block 2 结束 === -->

    <!-- === Block 3：练习 & 答案 === -->
    <div id="capturePart3">
    
    <!-- 练习区头部 -->
    <div class="exercise-header-new">
      <div class="exercise-header-badge">🎯</div>
      <div class="exercise-header-text">
        <div class="exercise-title-new">今日练习挑战</div>
        <div class="exercise-subtitle-new" id="exerciseTopicMirror">完成以下练习，掌握地道表达</div>
      </div>
      <div class="exercise-progress">
        <span class="progress-text">完成后点击查看答案 👇</span>
      </div>
    </div>
    
    <!-- 练习内容区 -->
    <div class="exercise-main">
      <div class="exercise-content" contenteditable="true" id="exerciseContent" data-placeholder="导入 Markdown 后自动填充..."></div>
    </div>

    <!-- 可折叠答案区 -->
    <div class="answers-collapsible">
      <button class="answers-toggle" id="answersToggle">
        <span class="toggle-icon">🔒</span>
        <span class="toggle-text">点击查看参考答案</span>
        <span class="toggle-arrow">▼</span>
      </button>
      <div class="answers-panel" id="answersPanel">
        <div class="answers-reveal-hint">✨ 答案已揭晓！对照检查你的答案吧</div>
        <div class="answers-content" contenteditable="true" id="answerContent" data-placeholder="导入 Markdown 后自动填充...">
        </div>
      </div>
    </div>
    </div>
    <!-- === Block 3 结束 === -->

  </div>
</div>
  </div>
  <!-- F1模式结束 -->

  <!-- F2: 课堂快速检测模式 -->
  <div id="modeQuickContent" class="mode-content">
    <div class="quick-check-container">
      <div class="quick-check-header">
        <h2>🎤 课堂快速检测</h2>
        <p>粘贴转录文本或上传音频，即时分析语速、填充词、重复词</p>
      </div>
      
      <div class="quick-check-input-section">
        <div class="quick-check-row">
          <div class="quick-input-group">
            <label>学生</label>
            <input type="text" id="quickStudentName" placeholder="选择或输入" list="studentNameList">
          </div>
          <div class="quick-input-group">
            <label>题型</label>
            <select id="quickTaskType">
              <option value="task1">独立口语 (45秒)</option>
              <option value="task2">综合口语 Task 2 (60秒)</option>
              <option value="task3">综合口语 Task 3 (60秒)</option>
              <option value="task4">综合口语 Task 4 (60秒)</option>
              <option value="custom">自定义时长</option>
            </select>
          </div>
          <div class="quick-input-group" id="customDurationGroup" style="display:none;">
            <label>时长(秒)</label>
            <input type="number" id="quickDuration" value="45" min="1" max="300">
          </div>
        </div>
        
        <!-- 输入方式切换 -->
        <div class="input-method-tabs">
          <button class="input-tab active" data-method="text" id="inputTabText">📝 粘贴文本</button>
          <button class="input-tab" data-method="audio" id="inputTabAudio">🎵 上传音频</button>
        </div>
        
        <!-- 文本输入 -->
        <div class="input-method-content active" id="inputMethodText">
          <div class="quick-textarea-wrapper">
            <textarea id="quickTranscript" placeholder="粘贴学生的口语转录文本...&#10;&#10;支持从 Descript / Whisper / 飞书妙记 复制"></textarea>
            <button class="btn btn-primary btn-analyze" id="quickAnalyzeBtn">⚡ 即时分析</button>
          </div>
        </div>
        
        <!-- 音频上传 -->
        <div class="input-method-content" id="inputMethodAudio">
          <div class="audio-upload-area" id="audioUploadArea">
            <div class="upload-icon">🎵</div>
            <div class="upload-text">点击或拖拽上传音频文件</div>
            <div class="upload-hint">支持 MP3, M4A, WAV, WEBM (最大25MB)</div>
            <input type="file" id="audioFileInput" accept="audio/*" style="display:none">
          </div>
          <div class="audio-preview" id="audioPreview" style="display:none;">
            <div class="audio-info">
              <span class="audio-name" id="audioFileName">-</span>
              <span class="audio-duration" id="audioDuration">-</span>
            </div>
            <audio id="audioPlayer" controls></audio>
            <div class="audio-actions">
              <button class="btn btn-ghost" id="removeAudioBtn">🗑️ 移除</button>
              <button class="btn btn-primary" id="transcribeBtn">🎤 Whisper转录</button>
            </div>
          </div>
          <div class="whisper-progress" id="whisperProgress" style="display:none;">
            <div class="whisper-spinner"></div>
            <span>正在转录中，请稍候...</span>
          </div>
          <div class="whisper-key-hint" id="whisperKeyHint">
            💡 需要 <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI API Key</a> 来使用Whisper转录
            <button class="btn btn-xs btn-ghost" id="setWhisperKeyBtn">设置Key</button>
          </div>
        </div>
      </div>
      
      <!-- 分析结果 -->
      <div class="quick-results" id="quickResults" style="display:none;">
        <div class="quick-stats-grid">
          <div class="quick-stat-card">
            <div class="stat-icon">📊</div>
            <div class="stat-value" id="qStatWords">0</div>
            <div class="stat-label">总词数</div>
          </div>
          <div class="quick-stat-card">
            <div class="stat-icon">⏱️</div>
            <div class="stat-value" id="qStatWPM">0</div>
            <div class="stat-label">语速 (WPM)</div>
            <div class="stat-sub" id="qStatWPMLevel">-</div>
          </div>
          <div class="quick-stat-card">
            <div class="stat-icon">🗣️</div>
            <div class="stat-value" id="qStatWPMClean">0</div>
            <div class="stat-label">净语速 (无填充词)</div>
          </div>
          <div class="quick-stat-card warning">
            <div class="stat-icon">⚠️</div>
            <div class="stat-value" id="qStatFillers">0</div>
            <div class="stat-label">填充词</div>
            <div class="stat-sub" id="qStatFillersPerMin">0/分钟</div>
          </div>
          <div class="quick-stat-card warning">
            <div class="stat-icon">🔁</div>
            <div class="stat-value" id="qStatRepeats">0</div>
            <div class="stat-label">相邻重复</div>
            <div class="stat-sub" id="qStatRepeatsPerMin">0/分钟</div>
          </div>
          <div class="quick-stat-card">
            <div class="stat-icon">📝</div>
            <div class="stat-value" id="qStatSentences">0</div>
            <div class="stat-label">句子数</div>
          </div>
        </div>
        
        <!-- 填充词详情 -->
        <div class="quick-detail-section" id="qFillerDetail" style="display:none;">
          <h4>🗣️ 填充词明细</h4>
          <div class="filler-breakdown" id="qFillerBreakdown"></div>
        </div>
        
        <!-- 重复词详情 -->
        <div class="quick-detail-section" id="qRepeatDetail" style="display:none;">
          <h4>🔁 相邻重复词</h4>
          <div class="repeat-list" id="qRepeatList"></div>
        </div>
        
        <!-- 标注文本 -->
        <div class="quick-annotated-section">
          <h4>📄 标注文本</h4>
          <div class="annotated-text" id="qAnnotatedText"></div>
          <div class="annotated-legend">
            <span class="legend-item"><mark class="filler">填充词</mark></span>
            <span class="legend-item"><mark class="repeat">重复</mark></span>
          </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="quick-actions">
          <button class="btn btn-ghost" id="quickClearBtn">🗑️ 清空</button>
          <button class="btn btn-success" id="quickSaveBtn">💾 保存到学生记录</button>
          <button class="btn btn-primary" id="quickToFullBtn">📝 转到完整批改</button>
        </div>
      </div>
    </div>
  </div>
  <!-- F2模式结束 -->

  <!-- F3: 批量处理模式 -->
  <div id="modeBatchContent" class="mode-content">
    <div class="batch-container">
      <div class="batch-header">
        <h2>📋 批量处理</h2>
        <p>一次分析多个学生的口语转录，快速生成对比报告</p>
      </div>
      
      <div class="batch-input-section">
        <div class="batch-settings">
          <div class="batch-setting-item">
            <label>题型</label>
            <select id="batchTaskType">
              <option value="task1">独立口语 (45秒)</option>
              <option value="task2">综合口语 Task 2 (60秒)</option>
              <option value="task3">综合口语 Task 3 (60秒)</option>
              <option value="task4">综合口语 Task 4 (60秒)</option>
              <option value="custom">自定义时长</option>
            </select>
          </div>
          <div class="batch-setting-item" id="batchCustomDuration" style="display:none;">
            <label>时长(秒)</label>
            <input type="number" id="batchDuration" value="45" min="1" max="300">
          </div>
        </div>
        
        <div class="batch-entries" id="batchEntries">
          <!-- 动态添加的学生条目 -->
        </div>
        
        <div class="batch-add-row">
          <button class="btn btn-ghost" id="addBatchEntryBtn">➕ 添加学生</button>
          <button class="btn btn-ghost" id="importBatchBtn">📥 批量导入</button>
        </div>
        
        <div class="batch-actions">
          <button class="btn btn-ghost" id="clearBatchBtn">🗑️ 清空全部</button>
          <button class="btn btn-primary btn-lg" id="analyzeBatchBtn">⚡ 批量分析</button>
        </div>
      </div>
      
      <!-- 批量分析结果 -->
      <div class="batch-results" id="batchResults" style="display:none;">
        <div class="batch-results-header">
          <h3>📊 分析结果</h3>
          <div class="batch-results-actions">
            <button class="btn btn-ghost btn-sm" id="exportBatchCsvBtn">📥 导出CSV</button>
            <button class="btn btn-ghost btn-sm" id="copyBatchResultsBtn">📋 复制结果</button>
          </div>
        </div>
        
        <!-- 汇总统计 -->
        <div class="batch-summary" id="batchSummary">
          <div class="summary-card">
            <div class="summary-label">学生数</div>
            <div class="summary-value" id="batchSumStudents">0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">平均词数</div>
            <div class="summary-value" id="batchSumWords">0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">平均WPM</div>
            <div class="summary-value" id="batchSumWPM">0</div>
          </div>
          <div class="summary-card warning">
            <div class="summary-label">平均填充词</div>
            <div class="summary-value" id="batchSumFillers">0</div>
          </div>
          <div class="summary-card warning">
            <div class="summary-label">平均重复</div>
            <div class="summary-value" id="batchSumRepeats">0</div>
          </div>
        </div>
        
        <!-- 结果表格 -->
        <div class="batch-table-wrapper">
          <table class="batch-table" id="batchTable">
            <thead>
              <tr>
                <th>学生</th>
                <th>词数</th>
                <th>WPM</th>
                <th>语速</th>
                <th>填充词</th>
                <th>重复</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="batchTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- F3模式结束 -->

<!-- 批量导入弹窗 -->
<div class="batch-import-modal" id="batchImportModal">
  <div class="batch-import-content">
    <h3>📥 批量导入</h3>
    <p>每行一个学生，格式：<code>学生名字: 转录文本</code><br>或者用空行分隔不同学生的内容</p>
    <textarea class="batch-import-textarea" id="batchImportTextarea" placeholder="示例格式：

张三: I think that studying abroad is a great opportunity because...

李四: In my opinion, the most important thing about learning is...

王五: Well, I believe that technology has changed our lives significantly..."></textarea>
    <div class="batch-import-actions">
      <button class="btn btn-ghost" id="closeBatchImportBtn">取消</button>
      <button class="btn btn-primary" id="applyBatchImportBtn">导入</button>
    </div>
  </div>
</div>

<!-- Markdown 导入弹窗 -->
<div class="modal" id="mdModal">
  <div class="modal-content modal-content-wide">
    <div class="modal-header-tabs">
      <button class="modal-tab active" data-tab="single" id="importTabSingle">单个导入</button>
      <button class="modal-tab" data-tab="batch" id="importTabBatch">📦 批量导入</button>
    </div>
    
    <!-- 单个导入 -->
    <div class="import-tab-content active" id="importSingleContent">
      <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">粘贴AI生成的Markdown，自动填充各个区块</p>
      <textarea id="mdTextarea" placeholder="支持以下格式：

| 原句 | 修改后 | 详细解释 |
| --- | --- | --- |
| ... | 🟢 语法... | ... |

## 中文思路
内容...

## 润色后高分版本示范
Although sometimes...

## 总评
整体表现...

## 地道表达练习
...

## 参考答案
..."></textarea>
      <div style="display: flex; gap: 12px; justify-content: space-between; align-items: center; margin-top: 12px;">
        <span style="font-size: 12px; color: var(--text-muted);">💡 Enter 应用 · Esc 取消</span>
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-ghost" id="closeMdBtn">取消</button>
          <button class="btn btn-primary" id="applyMdBtn">应用</button>
        </div>
      </div>
    </div>
    
    <!-- 批量导入 -->
    <div class="import-tab-content" id="importBatchContent">
      <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">
        导入多份批改内容，用 <code>===</code> 分隔不同学生/Task
      </p>
      
      <div class="batch-md-list" id="batchMdList">
        <!-- 动态添加 -->
      </div>
      
      <div class="batch-md-actions">
        <button class="btn btn-ghost" id="addBatchMdBtn">➕ 添加一份</button>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
        <span style="font-size: 12px; color: var(--text-muted);">💡 每份内容独立导出为图片</span>
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-ghost" id="closeBatchMdBtn">取消</button>
          <button class="btn btn-primary" id="applyBatchMdBtn">📦 全部导入</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 快捷键提示 -->
<div class="shortcut-hint" id="shortcutHint">
  <h4>⌨️ 快捷键</h4>
  <ul>
    <li><span>完整批改</span><kbd>F1</kbd></li>
    <li><span>快速检测</span><kbd>F2</kbd></li>
    <li><span>批量处理</span><kbd>F3</kbd></li>
    <li style="margin-top:8px;border-top:1px solid #e2e8f0;padding-top:8px;"><span>导入</span><kbd>Q → 1</kbd></li>
    <li><span>清空</span><kbd>Q → 2</kbd></li>
    <li><span>检测</span><kbd>Q → 3</kbd></li>
    <li><span>导出(常用)</span><kbd>Q → 4</kbd></li>
    <li><span>全部导出</span><kbd>Q → 5</kbd></li>
    <li><span>保存</span><kbd>⌘S</kbd></li>
  </ul>
</div>

<!-- 浮动工具栏 -->
<div class="floating-toolbar" id="floatingToolbar">
  <button data-action="strike" title="删除线"><s>S</s></button>
  <button data-action="bold" title="加粗"><b>B</b></button>
  <span style="color:#ddd;margin:0 4px">|</span>
  <button class="btn-hl" data-action="highlight" title="黄色高亮">🟡</button>
  <button class="btn-hl" data-action="blue-mark" title="蓝色高亮">🔵</button>
  <button class="btn-hl" data-action="red-mark" title="红色高亮(问题)">🔴</button>
  <button class="btn-hl" data-action="orange-mark" title="橙色高亮">🟠</button>
  <button class="btn-hl" data-action="purple-mark" title="紫色高亮">🟣</button>
  <span style="color:#ddd;margin:0 4px">|</span>
  <button class="btn-err" data-action="error-grammar" title="语法错误">语法</button>
  <button class="btn-err" data-action="error-pronunciation" title="发音错误">发音</button>
  <button class="btn-err" data-action="error-stress" title="重音错误">重音</button>
  <button class="btn-err" data-action="error-vowel" title="元音错误">元音</button>
  <span style="color:#ddd;margin:0 4px">|</span>
  <button class="btn-note" data-action="insert-note" title="插入备注" style="color:#78716c">📝</button>
  <button class="btn-issue" data-action="insert-issue" title="插入问题" style="color:#dc2626">⚠️</button>
  <span style="color:#ddd;margin:0 4px">|</span>
  <button class="btn-size" data-action="cell-size-sm" title="单元格小字号" style="font-size:11px">A⁻</button>
  <button class="btn-size" data-action="cell-size-lg" title="单元格大字号" style="font-size:15px">A⁺</button>
  <button data-action="clear" title="清除格式">✖</button>
</div>

<!-- 学生名单导入弹窗 -->
<div class="student-import-modal" id="studentImportModal">
  <div class="student-import-content">
    <h3>📥 导入学生名单</h3>
    <textarea id="studentListInput" placeholder="每行一个学生姓名&#10;例如:&#10;张三&#10;李四&#10;王五"></textarea>
    <p>提示: 粘贴学生名单，每行一个名字。导入后可在学生输入框中自动补全选择。</p>
    <div class="student-import-actions">
      <button class="btn btn-ghost" id="cancelStudentImport">取消</button>
      <button class="btn btn-primary" id="confirmStudentImport">导入</button>
    </div>
  </div>
</div>

<!-- 学生历史面板 -->
<div class="student-history-panel" id="studentHistoryPanel">
  <div class="student-history-content">
    <div class="student-history-header">
      <h3>📊 学生批改记录</h3>
      <button class="student-history-close" id="closeStudentHistoryBtn">×</button>
    </div>
    <div class="student-history-body">
      <!-- 学生选择 -->
      <div class="history-section">
        <label>选择学生：</label>
        <select id="historyStudentSelect" class="history-student-select">
          <option value="">-- 请选择 --</option>
        </select>
      </div>
      
      <!-- 学生统计 -->
      <div class="history-stats" id="historyStats" style="display:none;">
        <div class="stat-item">
          <div class="stat-value" id="statCount">0</div>
          <div class="stat-label">批改次数</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statFirstDate">-</div>
          <div class="stat-label">首次批改</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statLastDate">-</div>
          <div class="stat-label">最近批改</div>
        </div>
      </div>
      
      <!-- 进步曲线图表 -->
      <div class="progress-chart-section" id="progressChartSection" style="display:none;">
        <div class="progress-chart-header">
          <div class="progress-chart-title">
            📈 进步曲线
          </div>
          <div class="progress-chart-tabs">
            <button class="progress-chart-tab active" data-metric="words">词数</button>
            <button class="progress-chart-tab" data-metric="wpm">语速</button>
            <button class="progress-chart-tab" data-metric="fillers">填充词</button>
            <button class="progress-chart-tab" data-metric="errors">错误数</button>
          </div>
        </div>
        <div class="progress-chart-container">
          <canvas class="progress-chart-canvas" id="progressChartCanvas"></canvas>
        </div>
        <div class="progress-chart-legend" id="progressChartLegend">
          <div class="legend-item"><span class="legend-dot words"></span> 词数</div>
        </div>
        
        <!-- 进步趋势指标 -->
        <div class="progress-indicators">
          <div class="progress-indicator">
            <div class="indicator-value neutral" id="indWords">-</div>
            <div class="indicator-label">平均词数</div>
          </div>
          <div class="progress-indicator">
            <div class="indicator-value neutral" id="indWpm">-</div>
            <div class="indicator-label">平均语速</div>
          </div>
          <div class="progress-indicator">
            <div class="indicator-value neutral" id="indFillers">-</div>
            <div class="indicator-label">填充词趋势</div>
          </div>
          <div class="progress-indicator">
            <div class="indicator-value neutral" id="indErrors">-</div>
            <div class="indicator-label">错误趋势</div>
          </div>
        </div>
      </div>
      
      <!-- 历史记录列表 -->
      <div class="history-records" id="historyRecords"></div>
      
      <!-- 操作按钮 -->
      <div class="history-actions" id="historyActions" style="display:none;">
        <button class="btn btn-success" id="downloadHistoryBtn">📥 下载全部记录 (Markdown)</button>
        <button class="btn btn-ghost btn-danger" id="clearStudentHistoryBtn">🗑️ 清除该学生记录</button>
      </div>
    </div>
  </div>
</div>

<!-- TTS设置面板 -->
<div class="tts-settings-panel" id="ttsSettingsPanel">
  <div class="tts-settings-content">
    <div class="tts-settings-header">
      <h3>🎙️ TTS语音设置</h3>
      <button class="tts-settings-close" id="closeTtsSettingsBtn">×</button>
    </div>
    <div class="tts-settings-body">
      <!-- 提供商选择 -->
      <div class="tts-setting-group">
        <label>语音提供商</label>
        <div class="tts-provider-options">
          <label class="tts-provider-option">
            <input type="radio" name="ttsProvider" value="azure" checked>
            <span class="provider-card">
              <span class="provider-icon">🎙️</span>
              <span class="provider-name">Azure TTS</span>
              <span class="provider-desc">推荐！高质量自然语音</span>
              <span class="provider-price">每月50万字符免费</span>
            </span>
          </label>
          <label class="tts-provider-option">
            <input type="radio" name="ttsProvider" value="openai">
            <span class="provider-card">
              <span class="provider-icon">🤖</span>
              <span class="provider-name">OpenAI TTS</span>
              <span class="provider-desc">优质AI语音</span>
              <span class="provider-price">按使用付费</span>
            </span>
          </label>
          <label class="tts-provider-option">
            <input type="radio" name="ttsProvider" value="browser">
            <span class="provider-card">
              <span class="provider-icon">🔈</span>
              <span class="provider-name">浏览器语音</span>
              <span class="provider-desc">质量一般</span>
              <span class="provider-price">免费</span>
            </span>
          </label>
        </div>
      </div>
      
      <!-- Azure设置 -->
      <div class="tts-azure-settings" id="ttsAzureSettings">
        <div class="tts-setting-group">
          <label>Azure Speech Key</label>
          <input type="password" id="azureTtsKey" placeholder="输入Azure语音服务Key">
          <div class="setting-hint">
            获取方式：<a href="https://portal.azure.com" target="_blank">portal.azure.com</a> → 创建语音服务 → 密钥
          </div>
        </div>
        <div class="tts-setting-group">
          <label>Azure Region（区域）</label>
          <select id="azureTtsRegion">
            <option value="eastasia">East Asia（东亚）- 推荐国内</option>
            <option value="southeastasia">Southeast Asia（东南亚）</option>
            <option value="eastus">East US（美国东部）</option>
            <option value="westus">West US（美国西部）</option>
            <option value="westeurope">West Europe（西欧）</option>
          </select>
        </div>
        <div class="tts-setting-group">
          <label>声音选择</label>
          <select id="azureTtsVoice">
            <option value="en-US-JennyNeural">🇺🇸 Jenny（美式女声，自然）</option>
            <option value="en-US-GuyNeural">🇺🇸 Guy（美式男声）</option>
            <option value="en-US-AriaNeural">🇺🇸 Aria（美式女声，助手风格）</option>
            <option value="en-US-DavisNeural">🇺🇸 Davis（美式男声，自然）</option>
            <option value="en-GB-SoniaNeural">🇬🇧 Sonia（英式女声）</option>
            <option value="en-GB-RyanNeural">🇬🇧 Ryan（英式男声）</option>
            <option value="en-AU-NatashaNeural">🇦🇺 Natasha（澳洲女声）</option>
          </select>
        </div>
      </div>
      
      <!-- OpenAI设置 -->
      <div class="tts-openai-settings" id="ttsOpenaiSettings" style="display:none;">
        <div class="tts-setting-group">
          <label>OpenAI API Key</label>
          <input type="password" id="openaiTtsKey" placeholder="输入OpenAI API Key">
          <div class="setting-hint">
            获取方式：<a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a> → API Keys
          </div>
        </div>
        <div class="tts-setting-group">
          <label>声音选择</label>
          <select id="openaiTtsVoice">
            <option value="nova">Nova（女声，推荐）</option>
            <option value="alloy">Alloy（中性）</option>
            <option value="echo">Echo（男声）</option>
            <option value="fable">Fable（英式）</option>
            <option value="onyx">Onyx（低沉男声）</option>
            <option value="shimmer">Shimmer（女声）</option>
          </select>
        </div>
      </div>
      
      <!-- 语速设置 -->
      <div class="tts-setting-group">
        <label>语速：<span id="ttsRateValue">0.95x</span></label>
        <input type="range" id="ttsRateSlider" min="0.5" max="1.5" step="0.05" value="0.95">
        <div class="tts-rate-labels">
          <span>慢 0.5x</span>
          <span>正常 1.0x</span>
          <span>快 1.5x</span>
        </div>
      </div>
      
      <!-- 测试播放 -->
      <div class="tts-setting-group">
        <button class="btn btn-primary" id="testTtsBtn">🔊 测试播放</button>
        <span class="tts-test-status" id="ttsTestStatus"></span>
      </div>
    </div>
    <div class="tts-settings-footer">
      <button class="btn btn-ghost" id="cancelTtsSettingsBtn">取消</button>
      <button class="btn btn-success" id="saveTtsSettingsBtn">💾 保存设置</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// ==================== Supabase 配置 ====================
const SUPABASE_URL = 'https://pfebbjkavgvmsjtckjvz.supabase.co';
const SUPABASE_KEY = 'sb_publishable_iQdxtBINARxB7q33a8IlIw_0VGMtVLW';

// 初始化 Supabase 客户端（带错误处理）
let supabaseClient = null;
try {
  if (window.supabase && window.supabase.createClient) {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('Supabase 初始化成功');
  } else {
    console.warn('Supabase SDK 未加载，将使用游客模式');
  }
} catch (e) {
  console.error('Supabase 初始化失败:', e);
}

// 当前用户
let currentUser = null;
let isGuestMode = false;

// ==================== 认证管理 ====================
const AuthManager = {
  // 初始化：检查登录状态
  async init() {
    if (!supabaseClient) {
      console.log('无Supabase连接，跳过认证检查');
      return;
    }
    
    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        currentUser = session.user;
        this.showMainApp();
        this.updateUserUI();
      }
    } catch (e) {
      console.error('Auth init error:', e);
    }
    
    // 监听认证状态变化
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        currentUser = session.user;
        this.showMainApp();
        this.updateUserUI();
      } else if (event === 'SIGNED_OUT') {
        currentUser = null;
        this.showAuthPage();
      }
    });
  },
  
  // 邮箱登录
  async login(email, password) {
    if (!supabaseClient) throw new Error('服务未连接，请使用游客模式');
    
    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email,
      password
    });
    
    if (error) throw error;
    return data;
  },
  
  // 邮箱注册
  async register(email, password, name) {
    if (!supabaseClient) throw new Error('服务未连接，请使用游客模式');
    
    const { data, error } = await supabaseClient.auth.signUp({
      email,
      password,
      options: {
        data: { name }
      }
    });
    
    if (error) throw error;
    return data;
  },
  
  // 退出登录
  async logout() {
    if (supabase) {
      try {
        await supabaseClient.auth.signOut();
      } catch (e) {
        console.error('Logout error:', e);
      }
    }
    currentUser = null;
    isGuestMode = false;
    this.showAuthPage();
  },
  
  // 游客模式
  enterGuestMode() {
    isGuestMode = true;
    currentUser = { email: 'guest', user_metadata: { name: '游客' } };
    this.showMainApp();
    this.updateUserUI();
    console.log('进入游客模式');
  },
  
  // 显示主应用
  showMainApp() {
    document.getElementById('authContainer').classList.remove('show');
    document.getElementById('mainWrap').style.display = 'block';
    console.log('显示主应用');
  },
  
  // 显示登录页
  showAuthPage() {
    document.getElementById('authContainer').classList.add('show');
    document.getElementById('mainWrap').style.display = 'none';
  },
  
  // 更新用户UI
  updateUserUI() {
    const userInfo = document.getElementById('userInfo');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    
    if (currentUser) {
      const name = currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || '用户';
      userInfo.classList.add('show');
      userAvatar.textContent = name.charAt(0).toUpperCase();
      userName.textContent = isGuestMode ? '游客模式' : name;
    } else {
      userInfo.classList.remove('show');
    }
  },
  
  // 显示错误
  showError(msg) {
    const el = document.getElementById('authError');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
  },
  
  // 显示成功
  showSuccess(msg) {
    const el = document.getElementById('authSuccess');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
  }
};

// ==================== 认证UI绑定（立即执行）====================
(function initAuth() {
  // Tab切换
  document.querySelectorAll('.auth-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      this.classList.add('active');
      const formId = this.dataset.tab + 'Form';
      document.getElementById(formId).classList.add('active');
    });
  });
  
  // 登录表单
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    btn.disabled = true;
    btn.textContent = '登录中...';
    
    try {
      await AuthManager.login(email, password);
    } catch (err) {
      AuthManager.showError(err.message || '登录失败，请检查邮箱和密码');
    } finally {
      btn.disabled = false;
      btn.textContent = '登录';
    }
  });
  
  // 注册表单
  document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('registerBtn');
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const name = document.getElementById('registerName').value;
    
    btn.disabled = true;
    btn.textContent = '注册中...';
    
    try {
      await AuthManager.register(email, password, name);
      AuthManager.showSuccess('注册成功！请检查邮箱确认链接（如果收不到可直接登录）');
      document.querySelector('.auth-tab[data-tab="login"]').click();
    } catch (err) {
      AuthManager.showError(err.message || '注册失败');
    } finally {
      btn.disabled = false;
      btn.textContent = '注册';
    }
  });
  
  // 游客模式
  document.getElementById('guestBtn').addEventListener('click', function() {
    console.log('游客按钮点击');
    AuthManager.enterGuestMode();
  });
  
  // 退出登录
  document.getElementById('logoutBtn').addEventListener('click', async function() {
    if (isGuestMode) {
      AuthManager.showAuthPage();
      isGuestMode = false;
      currentUser = null;
    } else {
      await AuthManager.logout();
    }
  });
  
  // 延迟初始化Supabase认证
  setTimeout(() => {
    AuthManager.init();
  }, 100);
  
  console.log('认证UI初始化完成');
})();

// ==================== 全局配置 ====================
const APP_VERSION = 'v81';
const STORAGE_KEY = 'toefl_corrector_data';
const SETTINGS_KEY = 'toefl_corrector_settings';
const TEMPLATES_KEY = 'toefl_corrector_templates';
const STUDENTS_KEY = 'toefl_corrector_students';

// 语速自动判定阈值
const SPEED_THRESHOLDS = {
  '很慢': { min: 0, max: 69 },
  '较慢': { min: 70, max: 94 },
  '正常': { min: 95, max: 119 },
  '较快': { min: 120, max: 139 },
  '很快': { min: 140, max: Infinity }
};

// 用户是否手动修改过语速
let speedManuallySet = false;

// ==================== 学生名单管理 ====================
const StudentManager = {
  getAll() {
    try {
      return JSON.parse(localStorage.getItem(STUDENTS_KEY) || '[]');
    } catch { return []; }
  },
  save(list) {
    localStorage.setItem(STUDENTS_KEY, JSON.stringify(list));
    this.updateDatalist();
  },
  add(names) {
    const current = this.getAll();
    const newNames = names.filter(n => n && !current.includes(n));
    this.save([...current, ...newNames]);
  },
  updateDatalist() {
    const datalist = document.getElementById('studentNameList');
    if (!datalist) return;
    datalist.innerHTML = this.getAll().map(n => `<option value="${n}">`).join('');
  }
};

// ==================== 学生批改历史管理 ====================
const STUDENT_HISTORY_KEY = 'toefl_student_history';
const STUDENT_RECORDS_KEY = 'toefl_student_records'; // 完整批改记录

const StudentHistoryManager = {
  // 获取所有学生的历史记录（统计信息）
  getAll() {
    try {
      return JSON.parse(localStorage.getItem(STUDENT_HISTORY_KEY) || '{}');
    } catch { return {}; }
  },
  
  // 获取所有学生的完整批改记录
  getAllRecords() {
    try {
      return JSON.parse(localStorage.getItem(STUDENT_RECORDS_KEY) || '{}');
    } catch { return {}; }
  },
  
  // 获取某个学生的批改次数
  getCount(studentName) {
    if (!studentName) return 0;
    const history = this.getAll();
    return history[studentName]?.count || 0;
  },
  
  // 获取某个学生的详细历史
  getHistory(studentName) {
    if (!studentName) return null;
    const history = this.getAll();
    return history[studentName] || null;
  },
  
  // 获取某个学生的所有完整批改记录
  getRecords(studentName) {
    if (!studentName) return [];
    const records = this.getAllRecords();
    return records[studentName] || [];
  },
  
  // 记录一次批改（包含完整内容和进步数据）
  record(studentName, details = {}) {
    if (!studentName) return;
    
    // 更新统计信息
    const history = this.getAll();
    if (!history[studentName]) {
      history[studentName] = {
        count: 0,
        firstDate: new Date().toISOString(),
        records: [],
        progress: [] // 进步数据
      };
    }
    
    // 确保有progress数组
    if (!history[studentName].progress) {
      history[studentName].progress = [];
    }
    
    history[studentName].count++;
    history[studentName].lastDate = new Date().toISOString();
    
    // 保存简要记录（最多20条）
    history[studentName].records.unshift({
      date: details.date || new Date().toISOString().slice(0, 10),
      topic: details.topic || '',
      wordCount: details.wordCount || 0,
      timestamp: Date.now()
    });
    if (history[studentName].records.length > 20) {
      history[studentName].records.pop();
    }
    
    // 保存进步数据（最多30条）
    const progressEntry = {
      date: details.date || new Date().toISOString().slice(0, 10),
      wordCount: details.wordCount || 0,
      wpm: details.wpm || 0,
      fillerCount: details.fillerCount || 0,
      repeatCount: details.repeatCount || 0,
      errorCount: details.errorCount || 0,
      task: details.task || 'Task 1',
      timestamp: Date.now()
    };
    
    history[studentName].progress.unshift(progressEntry);
    if (history[studentName].progress.length > 30) {
      history[studentName].progress.pop();
    }
    
    localStorage.setItem(STUDENT_HISTORY_KEY, JSON.stringify(history));
    
    // 保存完整批改内容
    if (details.fullContent) {
      const records = this.getAllRecords();
      if (!records[studentName]) {
        records[studentName] = [];
      }
      
      records[studentName].unshift({
        id: Date.now(),
        date: details.date || new Date().toISOString().slice(0, 10),
        topic: details.topic || '',
        correctionNumber: details.correctionNumber || history[studentName].count,
        content: details.fullContent,
        timestamp: Date.now()
      });
      
      // 最多保留50条完整记录
      if (records[studentName].length > 50) {
        records[studentName].pop();
      }
      
      try {
        localStorage.setItem(STUDENT_RECORDS_KEY, JSON.stringify(records));
      } catch (e) {
        // localStorage可能满了，尝试清理旧记录
        console.warn('存储空间不足，清理旧记录');
        for (const name in records) {
          if (records[name].length > 10) {
            records[name] = records[name].slice(0, 10);
          }
        }
        try {
          localStorage.setItem(STUDENT_RECORDS_KEY, JSON.stringify(records));
        } catch (e2) {
          console.error('保存完整记录失败:', e2);
        }
      }
    }
    
    this.updateBadge(studentName);
    return history[studentName].count;
  },
  
  // 更新徽章显示
  updateBadge(studentName) {
    const badge = document.getElementById('studentHistoryBadge');
    if (!badge) return;
    
    const count = this.getCount(studentName);
    if (count > 0) {
      badge.textContent = `累计 ${count} 次`;
      badge.classList.add('show');
    } else {
      badge.classList.remove('show');
    }
  },
  
  // 导出某个学生的所有记录为Markdown
  exportStudentRecords(studentName) {
    const records = this.getRecords(studentName);
    const history = this.getHistory(studentName);
    
    if (!records.length) {
      showToast('⚠️ 该学生没有保存的批改记录');
      return null;
    }
    
    let markdown = `# ${studentName} 批改记录汇总\n\n`;
    markdown += `- 首次批改: ${history?.firstDate?.slice(0, 10) || '未知'}\n`;
    markdown += `- 最近批改: ${history?.lastDate?.slice(0, 10) || '未知'}\n`;
    markdown += `- 累计批改: ${history?.count || records.length} 次\n\n`;
    markdown += `---\n\n`;
    
    records.forEach((record, index) => {
      markdown += `## 第${record.correctionNumber || (records.length - index)}次批改 (${record.date})\n\n`;
      if (record.topic) {
        markdown += `**话题:** ${record.topic}\n\n`;
      }
      if (record.content) {
        markdown += record.content + '\n\n';
      }
      markdown += `---\n\n`;
    });
    
    return markdown;
  },
  
  // 下载某个学生的所有记录
  downloadStudentRecords(studentName) {
    const markdown = this.exportStudentRecords(studentName);
    if (!markdown) return;
    
    const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${studentName}_批改记录_${new Date().toISOString().slice(0, 10)}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast(`✅ 已下载 ${studentName} 的批改记录`);
  },
  
  // 清除某个学生的历史
  clear(studentName) {
    const history = this.getAll();
    delete history[studentName];
    localStorage.setItem(STUDENT_HISTORY_KEY, JSON.stringify(history));
    
    const records = this.getAllRecords();
    delete records[studentName];
    localStorage.setItem(STUDENT_RECORDS_KEY, JSON.stringify(records));
    
    this.updateBadge('');
  },
  
  // 清除所有历史
  clearAll() {
    localStorage.removeItem(STUDENT_HISTORY_KEY);
    localStorage.removeItem(STUDENT_RECORDS_KEY);
  }
};

// ==================== 本地存储管理 ====================
const StorageManager = {
  // 保存数据
  save() {
    if (!this.isEnabled()) return;
    
    const data = {
      version: APP_VERSION,
      timestamp: Date.now(),
      content: {
        headerTitle: document.getElementById('headerTitle').innerHTML,
        studentName: document.getElementById('studentName').value,
        correctionDate: document.getElementById('correctionDate').value,
        correctionNumber: document.getElementById('correctionNumber').value,
        speedSelect: document.getElementById('speedSelect').value,
        speedManuallySet: speedManuallySet,
        taskType: document.getElementById('taskType').value,
        bgTheme: document.getElementById('bgThemeSelect')?.value || 'default',
        correctionTable: document.querySelector('#correctionTable tbody').innerHTML,
        summaryTable: document.querySelector('#summaryTable tbody').innerHTML,
        polishedVersion: document.getElementById('polishedVersion').innerHTML,
        overallComment: document.getElementById('overallComment').innerHTML,
        exerciseContent: document.getElementById('exerciseContent').innerHTML,
        answerContent: document.getElementById('answerContent').innerHTML
      }
    };
    
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      this.showIndicator();
    } catch (e) {
      console.error('保存失败:', e);
    }
  },
  
  // 加载数据
  load() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return false;
      
      const data = JSON.parse(saved);
      if (!data.content) return false;
      
      const c = data.content;
      if (c.headerTitle) document.getElementById('headerTitle').innerHTML = c.headerTitle;
      if (c.studentName) document.getElementById('studentName').value = c.studentName;
      if (c.correctionDate) document.getElementById('correctionDate').value = c.correctionDate;
      if (c.correctionNumber) document.getElementById('correctionNumber').value = c.correctionNumber;
      if (c.speedSelect) document.getElementById('speedSelect').value = c.speedSelect;
      if (c.speedManuallySet !== undefined) speedManuallySet = c.speedManuallySet;
      if (c.taskType) document.getElementById('taskType').value = c.taskType;
      if (c.bgTheme && document.getElementById('bgThemeSelect')) {
        document.getElementById('bgThemeSelect').value = c.bgTheme;
        applyBgTheme(c.bgTheme);
      }
      if (c.correctionTable) document.querySelector('#correctionTable tbody').innerHTML = c.correctionTable;
      if (c.summaryTable) document.querySelector('#summaryTable tbody').innerHTML = c.summaryTable;
      if (c.polishedVersion) document.getElementById('polishedVersion').innerHTML = c.polishedVersion;
      if (c.overallComment) document.getElementById('overallComment').innerHTML = c.overallComment;
      if (c.exerciseContent) document.getElementById('exerciseContent').innerHTML = c.exerciseContent;
      if (c.answerContent) document.getElementById('answerContent').innerHTML = c.answerContent;
      
      return true;
    } catch (e) {
      console.error('加载失败:', e);
      return false;
    }
  },
  
  // 清除数据
  clear() {
    localStorage.removeItem(STORAGE_KEY);
    showToast('✓ 缓存已清除');
  },
  
  // 导出数据
  export() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) {
      showToast('⚠️ 没有数据可导出');
      return;
    }
    
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `toefl_corrector_backup_${new Date().toISOString().slice(0,10)}.json`;
    link.click();
    URL.revokeObjectURL(url);
    showToast('✓ 数据已导出');
  },
  
  // 检查是否启用
  isEnabled() {
    const settings = SettingsManager.get();
    return settings.autosaveEnabled !== 'false';
  },
  
  // 显示保存指示器
  showIndicator() {
    const indicator = document.getElementById('autosaveIndicator');
    indicator.classList.add('show');
    setTimeout(() => indicator.classList.remove('show'), 1500);
  }
};

// ==================== 设置管理 ====================
const SettingsManager = {
  defaults: {
    exportFormat: 'png',
    exportQuality: '2',
    autosaveEnabled: 'true',
    fillerWords: 'um\nuh\nyou know\nI mean\nlike\nso\nbasically\nactually\nliterally',
    theme: 'light'
  },
  
  get() {
    try {
      const saved = localStorage.getItem(SETTINGS_KEY);
      return saved ? { ...this.defaults, ...JSON.parse(saved) } : this.defaults;
    } catch (e) {
      return this.defaults;
    }
  },
  
  set(key, value) {
    const settings = this.get();
    settings[key] = value;
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  },
  
  save(settings) {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify({ ...this.defaults, ...settings }));
  },
  
  loadToUI() {
    const settings = this.get();
    document.getElementById('exportFormat').value = settings.exportFormat;
    document.getElementById('exportQuality').value = settings.exportQuality;
    document.getElementById('autosaveEnabled').value = settings.autosaveEnabled;
    document.getElementById('fillerWordsInput').value = settings.fillerWords;
    
    // 应用主题
    if (settings.theme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.getElementById('themeToggle').textContent = '☀️';
    }
  },
  
  saveFromUI() {
    const settings = {
      exportFormat: document.getElementById('exportFormat').value,
      exportQuality: document.getElementById('exportQuality').value,
      autosaveEnabled: document.getElementById('autosaveEnabled').value,
      fillerWords: document.getElementById('fillerWordsInput').value,
      theme: document.documentElement.getAttribute('data-theme') || 'light'
    };
    this.save(settings);
    showToast('✓ 设置已保存');
  }
};

// ==================== 模板管理 ====================
const TemplateManager = {
  defaultTemplates: [
    {
      id: 'default',
      name: '独立口语批改',
      content: `请帮我批改这段托福独立口语回答：

[在此粘贴学生的转录文本]

请按以下格式输出：
## 日期 – 话题标题

| 原句 | 修改后 | 详细解释 |
| --- | --- | --- |

## 中文思路
## 建议思路
## Idiom & 高分表达整理
## 润色后高分版本示范
## 总评
## 地道表达练习
## 参考答案`
    }
  ],
  
  getAll() {
    try {
      const saved = localStorage.getItem(TEMPLATES_KEY);
      return saved ? JSON.parse(saved) : this.defaultTemplates;
    } catch (e) {
      return this.defaultTemplates;
    }
  },
  
  save(templates) {
    localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates));
  },
  
  add(name, content) {
    const templates = this.getAll();
    templates.push({
      id: Date.now().toString(),
      name,
      content
    });
    this.save(templates);
    return templates;
  },
  
  update(id, content) {
    const templates = this.getAll();
    const idx = templates.findIndex(t => t.id === id);
    if (idx > -1) {
      templates[idx].content = content;
      this.save(templates);
    }
    return templates;
  },
  
  delete(id) {
    let templates = this.getAll();
    templates = templates.filter(t => t.id !== id);
    this.save(templates);
    return templates;
  },
  
  renderList() {
    const templates = this.getAll();
    const list = document.getElementById('templateList');
    const content = document.getElementById('templateContent');
    
    list.innerHTML = templates.map((t, i) => `
      <div class="template-item ${i === 0 ? 'active' : ''}" data-id="${t.id}">
        <span class="template-item-name">${t.name}</span>
        <div class="template-item-actions">
          <button onclick="TemplateManager.deleteItem('${t.id}')" style="background:#fee2e2;color:#dc2626;">删除</button>
        </div>
      </div>
    `).join('');
    
    // 绑定点击事件
    list.querySelectorAll('.template-item').forEach(item => {
      item.onclick = (e) => {
        if (e.target.tagName === 'BUTTON') return;
        list.querySelectorAll('.template-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        const template = templates.find(t => t.id === item.dataset.id);
        if (template) content.value = template.content;
      };
    });
    
    // 显示第一个模板内容
    if (templates.length > 0) {
      content.value = templates[0].content;
    }
  },
  
  deleteItem(id) {
    if (confirm('确定删除此模板？')) {
      this.delete(id);
      this.renderList();
      showToast('✓ 模板已删除');
    }
  },
  
  getActiveId() {
    const active = document.querySelector('.template-item.active');
    return active ? active.dataset.id : null;
  }
};

// ==================== 深色模式 ====================
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const newTheme = current === 'dark' ? 'light' : 'dark';
  
  html.setAttribute('data-theme', newTheme);
  document.getElementById('themeToggle').textContent = newTheme === 'dark' ? '☀️' : '🌙';
  SettingsManager.set('theme', newTheme);
}

// ==================== 工具函数 ====================
function debounce(fn, ms) { 
  let t; 
  return (...args) => { 
    clearTimeout(t); 
    t = setTimeout(() => fn(...args), ms); 
  }; 
}

function showToast(msg) { 
  const t = document.getElementById('toast'); 
  t.innerText = msg; 
  t.classList.add('show'); 
  const duration = msg.length > 20 ? 2500 : 1500;
  setTimeout(() => t.classList.remove('show'), duration); 
}

// ==================== 字体和宽度控制 ====================
function changeFont() {
  const font = document.getElementById('fontSelect').value;
  document.body.classList.remove('font-times', 'font-georgia');
  document.body.classList.add(font);
}

function changeFontSize() {
  const size = document.getElementById('fontSizeSelect').value;
  document.body.classList.remove('size-lg', 'size-xl', 'size-xxl');
  document.body.classList.add(size);
}

function changeWidth() {
  const w = document.getElementById('widthSelect').value;
  document.getElementById('mainWrap').style.maxWidth = w;
}

// ==================== 统计功能 ====================
function updateStats() {
  let wordCount = 0;
  
  // 统计批改表第一列的单词数
  const cells = document.querySelectorAll('#correctionTable tbody tr td:nth-child(1)');
  cells.forEach(td => {
    let d = document.createElement('div'); 
    d.innerHTML = td.innerHTML;
    d.querySelectorAll('.error-tag, .filler, .repeat').forEach(el => {
      const text = el.textContent;
      el.replaceWith(text);
    });
    let text = d.textContent || d.innerText || "";
    let cleanText = text.toLowerCase().replace(/[^\w\s']/g, ' ').replace(/\s+/g, ' ').trim();
    const tokens = cleanText.split(/\s+/).filter(w => w.length > 0);
    const englishWords = tokens.filter(w => /[a-z]/.test(w));
    wordCount += englishWords.length;
  });
  
  // 从 DOM 中统计已有的 .filler 和 .repeat 数量
  const fillerCount = document.querySelectorAll('#correctionTable td:nth-child(1) .filler').length;
  const repeatCount = document.querySelectorAll('#correctionTable td:nth-child(1) .repeat').length;
  
  document.getElementById('wordStats').innerText = wordCount;
  document.getElementById('fillerStats').innerText = fillerCount;
  document.getElementById('repeatStats').innerText = repeatCount;
  
  // 统计错误类型
  let grammarCount = 0, pronunciationCount = 0, stressCount = 0, vowelCount = 0;
  document.querySelectorAll('#correctionTable .error-tag').forEach(tag => {
    const text = tag.textContent.trim();
    if (text === '语法' || text === '低级') grammarCount++;
    else if (text === '发音') pronunciationCount++;
    else if (text === '重音') stressCount++;
    else if (text === '元音') vowelCount++;
  });
  
  document.getElementById('errGrammar').textContent = grammarCount;
  document.getElementById('errPronunciation').textContent = pronunciationCount;
  document.getElementById('errStress').textContent = stressCount;
  document.getElementById('errVowel').textContent = vowelCount;
  
  // 语速自动判定（仅独立口语时生效，且用户未手动修改）
  const taskType = document.getElementById('taskType').value;
  if ((taskType === 'Task 1' || taskType === '独立口语') && !speedManuallySet && wordCount > 0) {
    autoSetSpeed(wordCount);
  }
  
  // 更新润色版本字数
  updatePolishedWordCount();
}

// 语速自动判定
function autoSetSpeed(wordCount) {
  let speed = '正常';
  for (const [label, range] of Object.entries(SPEED_THRESHOLDS)) {
    if (wordCount >= range.min && wordCount <= range.max) {
      speed = label;
      break;
    }
  }
  document.getElementById('speedSelect').value = speed;
}

// 监听语速手动修改
document.getElementById('speedSelect').addEventListener('change', () => {
  speedManuallySet = true;
});

function updatePolishedWordCount() {
  const polished = document.getElementById('polishedVersion');
  let text = polished.textContent || polished.innerText || "";
  const words = text.trim().split(/\s+/).filter(w => w.length > 0 && /[a-z]/i.test(w));
  document.getElementById('polishedWordCount').innerText = words.length;
}

// ==================== 撤回管理器 ====================
const UndoManager = {
  stack: [], pointer: -1, max: 50,
  init() {
    this.save();
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'z') {
        e.preventDefault();
        if (e.shiftKey) this.redo(); else this.undo();
      }
    });
    document.getElementById('captureArea').addEventListener('input', debounce(() => this.save(), 800));
  },
  save() {
    const current = { 
      c: document.querySelector('#correctionTable tbody').innerHTML, 
      s: document.querySelector('#summaryTable tbody').innerHTML,
      p: document.getElementById('polishedVersion').innerHTML,
      o: document.getElementById('overallComment').innerHTML,
      h: document.getElementById('headerTitle').innerHTML,
      e: document.getElementById('exerciseContent').innerHTML,
      a: document.getElementById('answerContent').innerHTML
    };
    if(this.pointer > -1) {
      const prev = this.stack[this.pointer];
      if(prev.c === current.c && prev.s === current.s && prev.p === current.p) return;
    }
    this.stack = this.stack.slice(0, this.pointer + 1);
    this.stack.push(current);
    if(this.stack.length > this.max) this.stack.shift(); else this.pointer++;
  },
  undo() {
    if(this.pointer > 0) { 
      this.pointer--; 
      this.restore(this.stack[this.pointer]); 
      showToast('↩ 撤回'); 
    }
  },
  redo() {
    if(this.pointer < this.stack.length - 1) { 
      this.pointer++; 
      this.restore(this.stack[this.pointer]); 
      showToast('↪ 重做'); 
    }
  },
  restore(state) {
    document.querySelector('#correctionTable tbody').innerHTML = state.c;
    document.querySelector('#summaryTable tbody').innerHTML = state.s;
    if(state.p) document.getElementById('polishedVersion').innerHTML = state.p;
    if(state.o) document.getElementById('overallComment').innerHTML = state.o;
    if(state.h) document.getElementById('headerTitle').innerHTML = state.h;
    if(state.e) document.getElementById('exerciseContent').innerHTML = state.e;
    if(state.a) document.getElementById('answerContent').innerHTML = state.a;
    updateStats();
  }
};

// ==================== 导出功能 ====================
const exportConfig = {
  get scale() { return parseInt(SettingsManager.get().exportQuality) || 2; },
  backgroundColor: '#ffffff',
  logging: false
};

function getExportFormat() {
  return SettingsManager.get().exportFormat || 'png';
}

function cleanBeforeExport() {
  const saved = [];
  document.querySelectorAll('a[href*="http"], a[href*="file-service"], img').forEach((el, i) => {
    saved.push({ el, parent: el.parentNode, next: el.nextSibling });
    el.remove();
  });
  return saved;
}

function restoreAfterExport(saved) {
  saved.reverse().forEach(({ el, parent, next }) => {
    if (parent) {
      if (next) parent.insertBefore(el, next);
      else parent.appendChild(el);
    }
  });
}

async function exportPart(partId, filename) {
  const area = document.getElementById(partId);
  const title = document.getElementById('headerTitle').textContent || 'export';
  const studentName = document.getElementById('studentName').value;
  const safeName = title.replace(/[^\w\u4e00-\u9fa5]/g, '_').substring(0, 30);
  const namePrefix = studentName ? `${studentName}_` : '';
  const format = getExportFormat();
  
  // 如果是导出练习部分，先展开答案
  let wasAnswersClosed = false;
  if (partId === 'capturePart3') {
    const answersToggle = document.getElementById('answersToggle');
    const answersPanel = document.getElementById('answersPanel');
    if (answersToggle && answersPanel && !answersToggle.classList.contains('open')) {
      wasAnswersClosed = true;
      answersToggle.classList.add('open');
      answersPanel.classList.add('open');
      answersToggle.querySelector('.toggle-icon').textContent = '🔓';
      answersToggle.querySelector('.toggle-text').textContent = '隐藏参考答案';
      await new Promise(r => setTimeout(r, 400)); // 等待动画
    }
  }
  
  const saved = cleanBeforeExport();
  try {
    const canvas = await html2canvas(area, { ...exportConfig, scale: exportConfig.scale });
    const link = document.createElement('a');
    link.download = `${namePrefix}TOEFL_${filename}_${safeName}.${format}`;
    link.href = canvas.toDataURL(`image/${format}`, format === 'jpeg' ? 0.92 : undefined);
    link.click();
    return true;
  } catch (e) { 
    console.error('Export error:', e); 
    alert('导出失败: ' + e.message);
    return false;
  } finally {
    restoreAfterExport(saved);
    // 如果之前是关闭的，导出后恢复关闭状态（可选）
    // 这里保持展开，让用户看到答案
  }
}

// ==================== 导出下拉菜单 ====================
const exportDropdown = document.getElementById('exportDropdown');
const exportMainBtn = document.getElementById('exportMainBtn');
const exportMenu = document.getElementById('exportMenu');

// 切换下拉菜单
exportMainBtn.onclick = (e) => {
  e.stopPropagation();
  exportMenu.classList.toggle('show');
};

// 点击外部关闭
document.addEventListener('click', () => {
  exportMenu.classList.remove('show');
});

// 导出菜单项点击
exportMenu.addEventListener('click', async (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  
  const action = btn.dataset.export;
  exportMenu.classList.remove('show');
  
  switch(action) {
    case 'all':
      await exportAll();
      break;
    case 'main':
      await exportMain();
      break;
    case 'part1':
      showToast('📷 正在导出批改表...');
      if (await exportPart('capturePart1', '批改表')) {
        showToast('✅ 批改表导出成功');
      }
      break;
    case 'part2':
      showToast('📷 正在导出思路+总评...');
      if (await exportPart('capturePart2', '思路')) {
        showToast('✅ 思路+总评导出成功');
      }
      break;
    case 'part3':
      showToast('📷 正在导出练习+答案...');
      if (await exportPart('capturePart3', '练习')) {
        showToast('✅ 练习+答案导出成功');
      }
      break;
  }
});

// 导出全部
async function exportAll() {
  showToast('📷 正在导出全部...');
  
  await exportPart('capturePart1', '批改表');
  await new Promise(r => setTimeout(r, 500));
  
  await exportPart('capturePart2', '思路');
  await new Promise(r => setTimeout(r, 500));
  
  await exportPart('capturePart3', '练习');
  
  // 记录批改历史
  recordCorrectionHistory();
  
  showToast('✅ 全部导出完成！');
}

// 导出批改表+思路总评（常用）
async function exportMain() {
  showToast('📷 正在导出批改表+思路总评...');
  
  await exportPart('capturePart1', '批改表');
  await new Promise(r => setTimeout(r, 800)); // 增加延迟
  
  await exportPart('capturePart2', '思路');
  await new Promise(r => setTimeout(r, 300));
  
  // 记录批改历史
  recordCorrectionHistory();
  
  showToast('✅ 批改表+思路总评导出完成（共2张）');
}

// 记录批改历史（包含完整内容）- 带防重复逻辑
let lastRecordedKey = ''; // 防止重复记录

function recordCorrectionHistory() {
  const studentName = document.getElementById('studentName').value.trim();
  if (!studentName) return;
  
  const topic = document.getElementById('headerTitle').textContent || '';
  const wordCount = parseInt(document.getElementById('wordStats').textContent) || 0;
  const date = document.getElementById('correctionDate').value || new Date().toISOString().slice(0, 10);
  const correctionNumber = document.getElementById('correctionNumber').value || '1';
  
  // 获取进步相关数据
  const taskType = document.getElementById('taskType').value || 'Task 1';
  const polishedText = document.getElementById('polishedVersion').textContent || '';
  const polishedWordCount = polishedText.split(/\s+/).filter(w => w.length > 0).length;
  
  // 获取错误数（批改表行数）
  const errorCount = document.querySelectorAll('#correctionTable tbody tr').length;
  
  // 尝试从实时统计获取数据（如果可用）
  let wpm = 0;
  let fillerCount = 0;
  let repeatCount = 0;
  
  // 从润色版本估算WPM（假设45秒任务）
  const taskDuration = taskType.includes('Task 1') || taskType.includes('独立') ? 45 : 60;
  wpm = Math.round((polishedWordCount / taskDuration) * 60);
  
  // 生成唯一标识，防止同一次批改重复记录
  const recordKey = `${studentName}|${date}|${topic}|${correctionNumber}`;
  
  // 如果5分钟内已经记录过相同内容，跳过
  if (lastRecordedKey === recordKey) {
    console.log('跳过重复记录:', recordKey);
    return;
  }
  
  // 获取完整批改内容（Markdown格式）
  const fullContent = generateMarkdownContent();
  
  const count = StudentHistoryManager.record(studentName, {
    topic,
    wordCount: polishedWordCount || wordCount,
    date,
    correctionNumber,
    fullContent,
    // 进步数据
    wpm,
    fillerCount,
    repeatCount,
    errorCount,
    task: taskType
  });
  
  // 更新防重复标记
  lastRecordedKey = recordKey;
  // 5分钟后重置，允许真正的新批改
  setTimeout(() => {
    if (lastRecordedKey === recordKey) {
      lastRecordedKey = '';
    }
  }, 5 * 60 * 1000);
  
  // 自动更新批改次数
  const correctionNumberInput = document.getElementById('correctionNumber');
  if (correctionNumberInput.value === '1' || parseInt(correctionNumberInput.value) < count) {
    correctionNumberInput.value = count;
  }
  
  // 自动添加到学生名单
  StudentManager.add([studentName]);
}

// 生成Markdown格式的批改内容
function generateMarkdownContent() {
  let md = '';
  
  // 标题
  const title = document.getElementById('headerTitle').textContent || '';
  if (title) md += `### ${title}\n\n`;
  
  // 批改表
  const rows = document.querySelectorAll('#correctionTable tbody tr');
  if (rows.length > 0) {
    md += `#### 批改表\n\n`;
    rows.forEach((row, i) => {
      const cells = row.querySelectorAll('td');
      if (cells.length >= 3) {
        const original = cells[0].textContent.trim();
        const corrected = cells[1].textContent.trim();
        const explanation = cells[2].textContent.trim();
        if (original || corrected) {
          md += `**${i + 1}. 原句:** ${original}\n`;
          md += `**修改:** ${corrected}\n`;
          md += `**解释:** ${explanation}\n\n`;
        }
      }
    });
  }
  
  // 思路分析
  const summaryRows = document.querySelectorAll('#summaryTable tbody tr');
  if (summaryRows.length > 0) {
    md += `#### 思路分析\n\n`;
    summaryRows.forEach(row => {
      const label = row.querySelector('td:first-child')?.textContent.trim() || '';
      const content = row.querySelector('td:last-child')?.textContent.trim() || '';
      if (label && content) {
        md += `**${label}:** ${content}\n\n`;
      }
    });
  }
  
  // 润色版本
  const polished = document.getElementById('polishedVersion').textContent.trim();
  if (polished) {
    md += `#### 润色后高分版本\n\n${polished}\n\n`;
  }
  
  // 总评
  const comment = document.getElementById('overallComment').textContent.trim();
  if (comment) {
    md += `#### 总评\n\n${comment}\n\n`;
  }
  
  // 练习
  const exercises = document.getElementById('exerciseContent').textContent.trim();
  if (exercises) {
    md += `#### 练习\n\n${exercises}\n\n`;
  }
  
  // 答案
  const answers = document.getElementById('answerContent').textContent.trim();
  if (answers) {
    md += `#### 答案\n\n${answers}\n\n`;
  }
  
  return md;
}

// ==================== 清空功能 ====================
document.getElementById('clearAllBtn').onclick = () => {
  if(!confirm('确定清空所有内容？此操作不可撤回。')) return;
  
  document.getElementById('headerTitle').innerHTML = '';
  document.getElementById('studentName').value = '';
  document.getElementById('correctionNumber').value = '1';
  document.querySelector('#correctionTable tbody').innerHTML = '<tr><td data-placeholder="原句..."></td><td data-placeholder="修改后..."></td><td data-placeholder="详细解释..."></td></tr>';
  document.querySelector('#summaryTable tbody').innerHTML = '';
  document.getElementById('polishedVersion').innerHTML = '';
  document.getElementById('overallComment').innerHTML = '';
  document.getElementById('exerciseContent').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  
  updateStats();
  StorageManager.clear();
  showToast('🗑️ 已清空');
};

// ==================== 自动检测 ====================
document.getElementById('detectBtn').onclick = () => {
  UndoManager.save();
  
  // 从设置获取填充词列表
  const settings = SettingsManager.get();
  const fillerLines = settings.fillerWords.split('\n').map(l => l.trim().toLowerCase()).filter(l => l);
  
  // 分离单词和短语
  const singleFillers = fillerLines.filter(f => !f.includes(' '));
  const phraseFillers = fillerLines.filter(f => f.includes(' '));
  
  const beLikeSubjects = ['i', 'he', 'she', 'they', 'we', 'it'];
  const beVerbs = ['was', 'were', 'am', 'is', 'are'];
  
  document.querySelectorAll('#correctionTable td:nth-child(1)').forEach(td => {
    let text = td.textContent || '';
    if (!text.trim()) return;
    
    const wordRegex = /([a-zA-Z']+|\s+|[^a-zA-Z'\s]+)/g;
    const parts = text.match(wordRegex) || [];
    
    const tokens = [];
    const tokenIndices = [];
    parts.forEach((part, idx) => {
      if (/^[a-zA-Z']+$/.test(part)) {
        tokens.push(part.toLowerCase());
        tokenIndices.push(idx);
      }
    });
    
    const fillerSet = new Set();
    
    // 检测短语 filler
    phraseFillers.forEach(phrase => {
      const words = phrase.split(' ');
      for (let i = 0; i <= tokens.length - words.length; i++) {
        let match = true;
        for (let j = 0; j < words.length; j++) {
          if (tokens[i + j] !== words[j]) {
            match = false;
            break;
          }
        }
        if (match) {
          for (let j = 0; j < words.length; j++) {
            fillerSet.add(tokenIndices[i + j]);
          }
        }
      }
    });
    
    // 检测 be + like 结构
    for (let i = 0; i < tokens.length - 2; i++) {
      let startIdx = i;
      if (tokens[i] === 'and' && i + 3 < tokens.length) startIdx = i + 1;
      if (beLikeSubjects.includes(tokens[startIdx]) && 
          beVerbs.includes(tokens[startIdx + 1]) && 
          tokens[startIdx + 2] === 'like') {
        if (tokens[i] === 'and') fillerSet.add(tokenIndices[i]);
        fillerSet.add(tokenIndices[startIdx]);
        fillerSet.add(tokenIndices[startIdx + 1]);
        fillerSet.add(tokenIndices[startIdx + 2]);
      }
    }
    
    // 检测单词级 filler
    for (let i = 0; i < tokens.length; i++) {
      if (singleFillers.includes(tokens[i])) {
        fillerSet.add(tokenIndices[i]);
      }
    }
    
    // 标记重复位置（只检测真正的口语重复问题）
    const repeatSet = new Set();
    const usedForRepeat = new Set();
    
    // 常见词排除列表（这些词重复出现是正常的）
    const commonWords = new Set(['i', 'the', 'a', 'an', 'to', 'and', 'of', 'that', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'can', 'in', 'on', 'at', 'for', 'with', 'by', 'from', 'it', 'this', 'they', 'we', 'you', 'he', 'she', 'my', 'your', 'his', 'her', 'their', 'our', 'as', 'but', 'or', 'if', 'so', 'because', 'when', 'where', 'who', 'which', 'what', 'how', 'all', 'each', 'every', 'both', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'not', 'only', 'same', 'than', 'too', 'very', 'just', 'also', 'now', 'here', 'there', 'then', 'about', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'between', 'under', 'again', 'further', 'once', 'why', 'these', 'those', 'am', 'being', 'been', 'get', 'got', 'getting', 'go', 'going', 'went', 'come', 'coming', 'came', 'make', 'made', 'making', 'take', 'taking', 'took', 'see', 'seeing', 'saw', 'know', 'knowing', 'knew', 'think', 'thinking', 'thought', 'want', 'wanting', 'wanted', 'use', 'using', 'used', 'find', 'finding', 'found', 'give', 'giving', 'gave', 'tell', 'telling', 'told', 'say', 'saying', 'said', 'become', 'becoming', 'became', 'leave', 'leaving', 'left', 'put', 'putting', 'keep', 'keeping', 'kept', 'let', 'begin', 'beginning', 'began', 'seem', 'seeming', 'seemed', 'help', 'helping', 'helped', 'show', 'showing', 'showed', 'hear', 'hearing', 'heard', 'play', 'playing', 'played', 'run', 'running', 'ran', 'move', 'moving', 'moved', 'live', 'living', 'lived', 'believe', 'believing', 'believed', 'hold', 'holding', 'held', 'bring', 'bringing', 'brought', 'happen', 'happening', 'happened', 'write', 'writing', 'wrote', 'provide', 'providing', 'provided', 'sit', 'sitting', 'sat', 'stand', 'standing', 'stood', 'lose', 'losing', 'lost', 'pay', 'paying', 'paid', 'meet', 'meeting', 'met', 'include', 'including', 'included', 'continue', 'continuing', 'continued', 'set', 'setting', 'learn', 'learning', 'learned', 'change', 'changing', 'changed', 'lead', 'leading', 'led', 'understand', 'understanding', 'understood', 'watch', 'watching', 'watched', 'follow', 'following', 'followed', 'stop', 'stopping', 'stopped', 'create', 'creating', 'created', 'speak', 'speaking', 'spoke', 'read', 'reading', 'allow', 'allowing', 'allowed', 'add', 'adding', 'added', 'spend', 'spending', 'spent', 'grow', 'growing', 'grew', 'open', 'opening', 'opened', 'walk', 'walking', 'walked', 'win', 'winning', 'won', 'offer', 'offering', 'offered', 'remember', 'remembering', 'remembered', 'love', 'loving', 'loved', 'consider', 'considering', 'considered', 'appear', 'appearing', 'appeared', 'buy', 'buying', 'bought', 'wait', 'waiting', 'waited', 'serve', 'serving', 'served', 'die', 'dying', 'died', 'send', 'sending', 'sent', 'expect', 'expecting', 'expected', 'build', 'building', 'built', 'stay', 'staying', 'stayed', 'fall', 'falling', 'fell', 'cut', 'cutting', 'reach', 'reaching', 'reached', 'kill', 'killing', 'killed', 'remain', 'remaining', 'remained', 'really', 'actually', 'probably', 'people', 'person', 'thing', 'things', 'time', 'times', 'year', 'years', 'way', 'ways', 'day', 'days', 'man', 'men', 'woman', 'women', 'child', 'children', 'world', 'life', 'hand', 'hands', 'part', 'parts', 'place', 'places', 'case', 'cases', 'week', 'weeks', 'company', 'system', 'program', 'question', 'work', 'government', 'number', 'night', 'point', 'home', 'water', 'room', 'mother', 'area', 'money', 'story', 'fact', 'month', 'lot', 'right', 'study', 'book', 'eye', 'job', 'word', 'business', 'issue', 'side', 'kind', 'head', 'house', 'service', 'friend', 'father', 'power', 'hour', 'game', 'line', 'end', 'member', 'law', 'car', 'city', 'community', 'name', 'president', 'team', 'minute', 'idea', 'kid', 'body', 'information', 'back', 'parent', 'face', 'others', 'level', 'office', 'door', 'health', 'art', 'war', 'history', 'party', 'result', 'morning', 'reason', 'research', 'girl', 'guy', 'moment', 'air', 'teacher', 'force', 'education']);
    
    // 辅助函数：判断是否为标点符号
    const isPunctuation = (part) => /^[,;:.!?]$/.test(part);
    
    // 1. 检测连续重复（如 "I I I think"）- 这是真正的口语问题
    for (let i = 0; i < tokens.length - 1; i++) {
      if (usedForRepeat.has(i)) continue;
      if (tokens[i] === tokens[i + 1]) {
        let repeatLen = 1;
        while (i + repeatLen < tokens.length && tokens[i] === tokens[i + repeatLen]) {
          repeatLen++;
        }
        if (repeatLen > 1) {
          for (let k = i; k < i + repeatLen; k++) {
            repeatSet.add(tokenIndices[k]);
            usedForRepeat.add(k);
          }
        }
      }
    }
    
    // 2. 检测被标点隔开的短语重复（如 "I think the, I think the"）- 口语卡顿问题
    for (let phraseLen = 2; phraseLen <= 4; phraseLen++) {
      for (let i = 0; i < tokens.length - phraseLen; i++) {
        // 检查这个位置开始的短语是否已被标记
        let alreadyMarked = false;
        for (let k = 0; k < phraseLen; k++) {
          if (usedForRepeat.has(i + k)) { alreadyMarked = true; break; }
        }
        if (alreadyMarked) continue;
        
        // 获取当前短语
        const phrase = tokens.slice(i, i + phraseLen);
        
        // 注意：不跳过常见词短语，因为"I think the, I think the"这种立即重复是真正的口语卡顿
        
        // 直接检查下一个位置的tokens是否匹配（即j = i + phraseLen）
        let j = i + phraseLen;
        
        // 检查是否有足够的tokens来匹配短语
        if (j + phraseLen > tokens.length) continue;
        
        // 检查两个短语之间是否有标点（在parts数组中检查）
        let hasPunctuation = false;
        const endPartIdx = tokenIndices[i + phraseLen - 1]; // 第一个短语最后一个词的位置
        const startPartIdx = tokenIndices[j]; // 第二个短语第一个词的位置
        
        for (let p = endPartIdx + 1; p < startPartIdx; p++) {
          if (/^[,;:.!?]$/.test(parts[p])) {
            hasPunctuation = true;
            break;
          }
        }
        
        // 检查是否匹配
        let match = true;
        for (let k = 0; k < phraseLen; k++) {
          if (tokens[j + k] !== phrase[k]) {
            match = false;
            break;
          }
        }
        
        if (match && hasPunctuation) {
          // 标记两个短语为重复
          for (let k = 0; k < phraseLen; k++) {
            repeatSet.add(tokenIndices[i + k]);
            repeatSet.add(tokenIndices[j + k]);
            usedForRepeat.add(i + k);
            usedForRepeat.add(j + k);
          }
        }
      }
    }
    
    // 3. 检测被 filler 隔开的立即重复（如 "I um I think"）- 这也是口语卡顿问题
    for (let i = 0; i < tokens.length - 2; i++) {
      if (usedForRepeat.has(i) || fillerSet.has(tokenIndices[i])) continue;
      // 跳过常见词，因为它们自然会重复
      if (commonWords.has(tokens[i])) continue;
      
      const word = tokens[i];
      let j = i + 1;
      // 只检查紧邻的 filler 后面是否重复（不跨句子）
      let fillerCount = 0;
      while (j < tokens.length && fillerSet.has(tokenIndices[j]) && fillerCount < 3) {
        j++;
        fillerCount++;
      }
      // 只有当中间确实有 filler 且紧接着就是重复词时才标记
      if (fillerCount > 0 && j < tokens.length && tokens[j] === word && !usedForRepeat.has(j)) {
        repeatSet.add(tokenIndices[i]);
        repeatSet.add(tokenIndices[j]);
        usedForRepeat.add(i);
        usedForRepeat.add(j);
      }
    }
    
    // 注意：移除了"3词短语重复检测"，因为跨句子的短语重复是正常表达，不是口语问题
    
    // 重建 HTML
    const newParts = parts.map((part, idx) => {
      if (!/^[a-zA-Z']+$/.test(part)) return part;
      
      const isFiller = fillerSet.has(idx);
      const isRepeat = repeatSet.has(idx);
      
      if (isFiller && isRepeat) {
        return `<span class="filler repeat">${part}</span>`;
      } else if (isFiller) {
        return `<span class="filler">${part}</span>`;
      } else if (isRepeat) {
        return `<span class="repeat">${part}</span>`;
      }
      return part;
    });
    
    td.innerHTML = newParts.join('');
  });
  
  updateStats(); 
  UndoManager.save(); 
  showToast('🔍 检测完成');
};

// ==================== Modal 控制 ====================
const modal = document.getElementById('mdModal');
document.getElementById('openMdBtn').onclick = () => {
  modal.classList.add('open');
  // 聚焦到textarea
  setTimeout(() => document.getElementById('mdTextarea').focus(), 100);
};
document.getElementById('closeMdBtn').onclick = () => modal.classList.remove('open');
document.getElementById('closeBatchMdBtn')?.addEventListener('click', () => modal.classList.remove('open'));
modal.onclick = (e) => { if(e.target === modal) modal.classList.remove('open'); };

// 导入弹窗标签切换
document.getElementById('importTabSingle')?.addEventListener('click', function() {
  document.getElementById('importTabSingle').classList.add('active');
  document.getElementById('importTabBatch').classList.remove('active');
  document.getElementById('importSingleContent').classList.add('active');
  document.getElementById('importBatchContent').classList.remove('active');
});

document.getElementById('importTabBatch')?.addEventListener('click', function() {
  document.getElementById('importTabBatch').classList.add('active');
  document.getElementById('importTabSingle').classList.remove('active');
  document.getElementById('importBatchContent').classList.add('active');
  document.getElementById('importSingleContent').classList.remove('active');
  // 初始化批量导入列表
  if (document.querySelectorAll('.batch-md-item').length === 0) {
    BatchMdManager.addItem();
  }
});

// ==================== 批量Markdown导入管理 ====================
const BatchMdManager = {
  itemCount: 0,
  queue: [], // 批改队列
  currentIndex: 0,
  
  addItem(student = '', task = 'Task 1', content = '') {
    this.itemCount++;
    const list = document.getElementById('batchMdList');
    const item = document.createElement('div');
    item.className = 'batch-md-item';
    item.dataset.id = this.itemCount;
    item.innerHTML = `
      <div class="batch-md-item-header">
        <div class="batch-md-item-num">${this.itemCount}</div>
        <div class="batch-md-item-inputs">
          <input type="text" placeholder="学生名" list="studentNameList" value="${student}">
          <select>
            <option value="Task 1" ${task === 'Task 1' ? 'selected' : ''}>Task 1</option>
            <option value="Task 2" ${task === 'Task 2' ? 'selected' : ''}>Task 2</option>
            <option value="Task 3" ${task === 'Task 3' ? 'selected' : ''}>Task 3</option>
            <option value="Task 4" ${task === 'Task 4' ? 'selected' : ''}>Task 4</option>
          </select>
        </div>
        <button class="batch-md-item-remove" title="移除">🗑️</button>
      </div>
      <textarea placeholder="粘贴该学生的Markdown批改内容...">${content}</textarea>
    `;
    
    item.querySelector('.batch-md-item-remove').addEventListener('click', () => {
      item.remove();
      this.updateItemNumbers();
    });
    
    list.appendChild(item);
    
    if (!content) {
      item.querySelector('input').focus();
    }
  },
  
  updateItemNumbers() {
    const items = document.querySelectorAll('.batch-md-item');
    items.forEach((item, idx) => {
      item.querySelector('.batch-md-item-num').textContent = idx + 1;
    });
    this.itemCount = items.length;
  },
  
  getItems() {
    const items = document.querySelectorAll('.batch-md-item');
    return Array.from(items).map(item => ({
      student: item.querySelector('input').value.trim(),
      task: item.querySelector('select').value,
      content: item.querySelector('textarea').value.trim()
    })).filter(i => i.content);
  },
  
  importAll() {
    const items = this.getItems();
    if (items.length === 0) {
      showToast('⚠️ 请至少添加一份批改内容');
      return;
    }
    
    this.queue = items.map((item, idx) => ({
      ...item,
      id: idx + 1,
      exported: false
    }));
    
    this.currentIndex = 0;
    
    // 加载第一个
    this.loadItem(0);
    
    // 显示队列指示器
    this.updateQueueUI();
    
    // 关闭弹窗
    modal.classList.remove('open');
    
    showToast(`✅ 已导入 ${items.length} 份批改，可逐个导出`);
  },
  
  loadItem(index) {
    if (index < 0 || index >= this.queue.length) return;
    
    this.currentIndex = index;
    const item = this.queue[index];
    
    // 设置学生名
    document.getElementById('studentName').value = item.student;
    
    // 设置题型
    const taskType = document.getElementById('taskType');
    if (item.task.includes('1')) {
      taskType.value = '独立口语 Task 1';
    } else {
      taskType.value = '综合口语 Task 2-4';
    }
    
    // 解析并应用Markdown - 直接触发应用按钮
    document.getElementById('mdTextarea').value = item.content;
    document.getElementById('applyMdBtn').click();
    
    // 更新队列UI
    this.updateQueueUI();
  },
  
  updateQueueUI() {
    const queueEl = document.getElementById('correctionQueue');
    if (!queueEl) return;
    
    if (this.queue.length === 0) {
      queueEl.classList.remove('show');
      return;
    }
    
    queueEl.classList.add('show');
    
    const listEl = document.getElementById('correctionQueueList');
    listEl.innerHTML = this.queue.map((item, idx) => `
      <div class="correction-queue-item ${idx === this.currentIndex ? 'active' : ''} ${item.exported ? 'exported' : ''}" 
           data-index="${idx}">
        <span class="status"></span>
        <span>${item.student || '未命名'} - ${item.task}</span>
      </div>
    `).join('');
    
    // 点击切换
    listEl.querySelectorAll('.correction-queue-item').forEach(el => {
      el.addEventListener('click', () => {
        this.loadItem(parseInt(el.dataset.index));
      });
    });
  },
  
  markExported() {
    if (this.queue[this.currentIndex]) {
      this.queue[this.currentIndex].exported = true;
      this.updateQueueUI();
    }
  },
  
  async exportAll() {
    if (this.queue.length === 0) {
      showToast('⚠️ 没有可导出的批改');
      return;
    }
    
    showToast(`📦 开始导出 ${this.queue.length} 份批改...`);
    
    for (let i = 0; i < this.queue.length; i++) {
      this.loadItem(i);
      
      // 等待UI更新
      await new Promise(r => setTimeout(r, 300));
      
      // 导出当前批改的所有部分
      await exportAll();
      
      this.queue[i].exported = true;
      this.updateQueueUI();
      
      // 间隔
      await new Promise(r => setTimeout(r, 500));
    }
    
    showToast(`✅ 已导出全部 ${this.queue.length} 份批改！`);
  },
  
  clear() {
    this.queue = [];
    this.currentIndex = 0;
    document.getElementById('correctionQueue')?.classList.remove('show');
  }
};

// 添加批量导入项按钮
document.getElementById('addBatchMdBtn')?.addEventListener('click', () => {
  BatchMdManager.addItem();
});

// 批量导入应用按钮
document.getElementById('applyBatchMdBtn')?.addEventListener('click', () => {
  BatchMdManager.importAll();
});

// 全部导出按钮
document.getElementById('exportAllQueueBtn')?.addEventListener('click', () => {
  BatchMdManager.exportAll();
});

// 清空队列按钮
document.getElementById('clearQueueBtn')?.addEventListener('click', () => {
  if (confirm('确定要清空批改队列吗？')) {
    BatchMdManager.clear();
    showToast('🗑️ 已清空批改队列');
  }
});

// Modal 键盘快捷键：Enter = 应用，Esc = 取消
document.getElementById('mdTextarea').addEventListener('keydown', (e) => {
  // Enter (不需要Ctrl) = 应用，但如果是Shift+Enter则允许换行
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    document.getElementById('applyMdBtn').click();
  }
  // Esc = 取消
  if (e.key === 'Escape') {
    e.preventDefault();
    modal.classList.remove('open');
  }
});

// Modal 容器级别的 Esc 监听
modal.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    e.preventDefault();
    modal.classList.remove('open');
  }
});

// 设置面板
const settingsPanel = document.getElementById('settingsPanel');
const settingsOverlay = document.createElement('div');
settingsOverlay.className = 'recorder-overlay';
document.body.appendChild(settingsOverlay);

document.getElementById('settingsBtn').onclick = () => {
  settingsPanel.classList.add('open');
  settingsOverlay.classList.add('open');
};
document.getElementById('closeSettingsBtn').onclick = () => {
  settingsPanel.classList.remove('open');
  settingsOverlay.classList.remove('open');
  SettingsManager.saveFromUI();
};
settingsOverlay.onclick = () => {
  settingsPanel.classList.remove('open');
  templatePanel.classList.remove('open');
  settingsOverlay.classList.remove('open');
  SettingsManager.saveFromUI();
};

document.getElementById('clearCacheBtn').onclick = () => {
  if (confirm('确定清除所有缓存数据？')) {
    StorageManager.clear();
  }
};
document.getElementById('exportDataBtn').onclick = () => StorageManager.export();

// 模板面板
const templatePanel = document.getElementById('templatePanel');
document.getElementById('templateBtn').onclick = () => {
  templatePanel.classList.add('open');
  settingsOverlay.classList.add('open');
  TemplateManager.renderList();
};
document.getElementById('closeTemplateBtn').onclick = () => {
  templatePanel.classList.remove('open');
  settingsOverlay.classList.remove('open');
};

document.getElementById('addTemplateBtn').onclick = () => {
  const name = document.getElementById('newTemplateName').value.trim();
  if (!name) {
    showToast('⚠️ 请输入模板名称');
    return;
  }
  TemplateManager.add(name, document.getElementById('templateContent').value);
  document.getElementById('newTemplateName').value = '';
  TemplateManager.renderList();
  showToast('✓ 模板已添加');
};

document.getElementById('saveTemplateBtn').onclick = () => {
  const id = TemplateManager.getActiveId();
  if (!id) {
    showToast('⚠️ 请先选择一个模板');
    return;
  }
  TemplateManager.update(id, document.getElementById('templateContent').value);
  showToast('✓ 模板已保存');
};

document.getElementById('copyTemplateBtn').onclick = () => {
  const content = document.getElementById('templateContent').value;
  navigator.clipboard.writeText(content).then(() => {
    showToast('✓ 已复制到剪贴板');
  });
};

// ==================== 快捷键 ====================
// 使用 Q+数字 快捷键
let qKeyPressed = false;
let qKeyTimer = null;

document.addEventListener('keydown', (e) => {
  const ctrl = e.ctrlKey || e.metaKey;
  
  // F1/F2/F3 模式切换（全局生效）
  if (e.key === 'F1') {
    e.preventDefault();
    switchMode('full');
    return;
  }
  if (e.key === 'F2') {
    e.preventDefault();
    switchMode('quick');
    return;
  }
  if (e.key === 'F3') {
    e.preventDefault();
    switchMode('batch');
    return;
  }
  
  // 如果焦点在输入框内，不触发Q+数字快捷键
  const activeEl = document.activeElement;
  const isTyping = activeEl && (
    activeEl.tagName === 'INPUT' || 
    activeEl.tagName === 'TEXTAREA' || 
    activeEl.isContentEditable
  );
  
  // 追踪Q键状态（只在非输入状态下）
  if (e.key === 'q' || e.key === 'Q') {
    if (!isTyping) {
      e.preventDefault();
      qKeyPressed = true;
      clearTimeout(qKeyTimer);
      qKeyTimer = setTimeout(() => { qKeyPressed = false; }, 500);
    }
    return;
  }
  
  // Q+数字快捷键
  if (qKeyPressed && ['1','2','3','4','5'].includes(e.key)) {
    e.preventDefault();
    e.stopPropagation();
    qKeyPressed = false;
    
    // Q+1 导入
    if (e.key === '1') {
      modal.classList.add('open');
      showToast('📥 打开导入面板 (Q+1)');
      return;
    }
    // Q+2 清空
    if (e.key === '2') {
      document.getElementById('clearAllBtn').click();
      return;
    }
    // Q+3 检测
    if (e.key === '3') {
      document.getElementById('detectBtn').click();
      showToast('🔍 自动检测中... (Q+3)');
      return;
    }
    // Q+4 导出（批改表+思路，常用）
    if (e.key === '4') {
      exportMain();
      return;
    }
    // Q+5 全部导出
    if (e.key === '5') {
      exportAll();
      return;
    }
  }
  
  // Ctrl+S 保存
  if (ctrl && e.key === 's') {
    e.preventDefault();
    StorageManager.save();
    showToast('✓ 已保存');
  }
  // Ctrl+? 显示快捷键提示
  else if (e.key === '?' && ctrl) {
    e.preventDefault();
    document.getElementById('shortcutHint').classList.toggle('show');
  }
}, true);

// ==================== 模式切换 ====================
function switchMode(mode) {
  const fullBtn = document.getElementById('modeFullBtn');
  const quickBtn = document.getElementById('modeQuickBtn');
  const batchBtn = document.getElementById('modeBatchBtn');
  const fullContent = document.getElementById('modeFullContent');
  const quickContent = document.getElementById('modeQuickContent');
  const batchContent = document.getElementById('modeBatchContent');
  
  // 重置所有标签和内容
  [fullBtn, quickBtn, batchBtn].forEach(btn => btn?.classList.remove('active'));
  [fullContent, quickContent, batchContent].forEach(c => c?.classList.remove('active'));
  
  if (mode === 'full') {
    fullBtn?.classList.add('active');
    fullContent?.classList.add('active');
    showToast('📝 完整批改模式 (F1)');
  } else if (mode === 'quick') {
    quickBtn?.classList.add('active');
    quickContent?.classList.add('active');
    showToast('⚡ 课堂快速检测 (F2)');
  } else if (mode === 'batch') {
    batchBtn?.classList.add('active');
    batchContent?.classList.add('active');
    // 初始化批量处理（添加一个空条目）
    if (document.querySelectorAll('.batch-entry').length === 0) {
      BatchManager.addEntry();
    }
    showToast('📋 批量处理模式 (F3)');
  }
}

// 模式标签点击
document.getElementById('modeFullBtn')?.addEventListener('click', () => switchMode('full'));
document.getElementById('modeQuickBtn')?.addEventListener('click', () => switchMode('quick'));
document.getElementById('modeBatchBtn')?.addEventListener('click', () => switchMode('batch'));

// ==================== 课堂快速检测功能 ====================
const QuickCheckManager = {
  // 填充词列表和备注
  fillerWords: ['um', 'uh', 'er', 'ah', 'eh', 'hmm', 'mmm', 'mm', 'like', 'you know', 'yknow', 'well', 'so', 'actually', 'basically'],
  
  // 填充词备注映射
  fillerNotes: {
    'um': '犹豫停顿',
    'uh': '犹豫停顿',
    'er': '犹豫停顿',
    'ah': '犹豫停顿',
    'eh': '犹豫停顿',
    'hmm': '思考停顿',
    'mmm': '思考停顿',
    'mm': '思考停顿',
    'like': '口语填充词，非比喻',
    'you know': '口语填充词',
    'yknow': '口语填充词',
    'well': '句首填充词',
    'so': '过度使用的连接词',
    'actually': '口语习惯用词',
    'basically': '口语习惯用词'
  },
  
  // 题型时长映射
  taskDurations: {
    'task1': 45,
    'task2': 60,
    'task3': 60,
    'task4': 60,
    'custom': null
  },
  
  // 分词
  tokenize(text) {
    return text
      .replace(/[.,!?;:'"()[\]{}]/g, ' ')
      .split(/\s+/)
      .filter(w => w.length > 0);
  },
  
  // 分析文本
  analyze(text, durationSeconds) {
    const tokens = this.tokenize(text);
    const lowerTokens = tokens.map(t => t.toLowerCase());
    
    // 基本统计
    const wordCount = tokens.filter(t => /[a-zA-Z]/.test(t)).length;
    const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
    
    // 填充词检测
    const fillerResults = {};
    let fillerTotal = 0;
    
    this.fillerWords.forEach(filler => {
      const lowerFiller = filler.toLowerCase();
      const indices = [];
      lowerTokens.forEach((token, idx) => {
        if (token === lowerFiller) {
          indices.push(idx);
        }
      });
      if (indices.length > 0) {
        fillerResults[filler] = { 
          count: indices.length, 
          indices,
          note: this.fillerNotes[filler] || '填充词'
        };
        fillerTotal += indices.length;
      }
    });
    
    // 相邻重复检测
    let repeatCount = 0;
    const repeatIndices = [];
    const repeatWords = [];
    
    for (let i = 1; i < lowerTokens.length; i++) {
      if (lowerTokens[i] === lowerTokens[i-1] && /[a-zA-Z]/.test(tokens[i])) {
        repeatCount++;
        if (!repeatIndices.includes(i-1)) repeatIndices.push(i-1);
        repeatIndices.push(i);
        if (!repeatWords.includes(tokens[i].toLowerCase())) {
          repeatWords.push(tokens[i].toLowerCase());
        }
      }
    }
    
    // 计算WPM
    const minutes = durationSeconds / 60;
    const wpmAll = minutes > 0 ? Math.round(wordCount / minutes) : 0;
    const wpmClean = minutes > 0 ? Math.round((wordCount - fillerTotal) / minutes) : 0;
    const fillersPerMin = minutes > 0 ? (fillerTotal / minutes).toFixed(1) : 0;
    const repeatsPerMin = minutes > 0 ? (repeatCount / minutes).toFixed(1) : 0;
    
    // 判断语速等级
    let wpmLevel = '正常';
    let wpmClass = 'wpm-normal';
    if (wpmAll < 90) { wpmLevel = '很慢'; wpmClass = 'wpm-very-slow'; }
    else if (wpmAll < 110) { wpmLevel = '较慢'; wpmClass = 'wpm-slow'; }
    else if (wpmAll <= 140) { wpmLevel = '正常'; wpmClass = 'wpm-normal'; }
    else if (wpmAll <= 160) { wpmLevel = '较快'; wpmClass = 'wpm-fast'; }
    else { wpmLevel = '很快'; wpmClass = 'wpm-very-fast'; }
    
    // 生成标注文本（带备注）
    const fillerIndicesMap = new Map(); // idx -> note
    Object.entries(fillerResults).forEach(([word, data]) => {
      data.indices.forEach(i => fillerIndicesMap.set(i, data.note));
    });
    const repeatIndicesSet = new Set(repeatIndices);
    
    const annotatedTokens = tokens.map((token, idx) => {
      const fillerNote = fillerIndicesMap.get(idx);
      const isRepeat = repeatIndicesSet.has(idx);
      
      if (fillerNote && isRepeat) {
        return `<mark class="filler repeat filler-tooltip" data-note="${fillerNote} + 重复">${token}</mark>`;
      } else if (fillerNote) {
        return `<mark class="filler filler-tooltip" data-note="${fillerNote}">${token}</mark>`;
      } else if (isRepeat) {
        return `<mark class="repeat filler-tooltip" data-note="相邻重复">${token}</mark>`;
      }
      return token;
    });
    
    return {
      wordCount,
      sentences,
      fillerTotal,
      fillerBreakdown: fillerResults,
      repeatCount,
      repeatWords,
      wpmAll,
      wpmClean,
      wpmLevel,
      wpmClass,
      fillersPerMin,
      repeatsPerMin,
      annotatedText: annotatedTokens.join(' ')
    };
  },
  
  // 更新UI显示
  updateUI(result) {
    document.getElementById('qStatWords').textContent = result.wordCount;
    document.getElementById('qStatSentences').textContent = result.sentences;
    
    const wpmEl = document.getElementById('qStatWPM');
    wpmEl.textContent = result.wpmAll;
    wpmEl.className = `stat-value ${result.wpmClass}`;
    document.getElementById('qStatWPMLevel').textContent = result.wpmLevel;
    
    document.getElementById('qStatWPMClean').textContent = result.wpmClean;
    document.getElementById('qStatFillers').textContent = result.fillerTotal;
    document.getElementById('qStatFillersPerMin').textContent = `${result.fillersPerMin}/分钟`;
    document.getElementById('qStatRepeats').textContent = result.repeatCount;
    document.getElementById('qStatRepeatsPerMin').textContent = `${result.repeatsPerMin}/分钟`;
    
    // 填充词详情
    const fillerDetail = document.getElementById('qFillerDetail');
    const fillerBreakdown = document.getElementById('qFillerBreakdown');
    if (result.fillerTotal > 0) {
      fillerDetail.style.display = 'block';
      fillerBreakdown.innerHTML = Object.entries(result.fillerBreakdown)
        .map(([word, data]) => `
          <span class="filler-tag" title="${data.note || '填充词'}">
            <span class="filler-word">${word}</span>
            <span class="filler-count">${data.count}</span>
            <span class="filler-note">${data.note || ''}</span>
          </span>
        `).join('');
    } else {
      fillerDetail.style.display = 'none';
    }
    
    // 重复词详情
    const repeatDetail = document.getElementById('qRepeatDetail');
    const repeatList = document.getElementById('qRepeatList');
    if (result.repeatCount > 0) {
      repeatDetail.style.display = 'block';
      repeatList.innerHTML = result.repeatWords
        .map(word => `<span class="repeat-tag">${word} (重复)</span>`)
        .join('');
    } else {
      repeatDetail.style.display = 'none';
    }
    
    // 标注文本
    document.getElementById('qAnnotatedText').innerHTML = result.annotatedText;
    
    // 显示结果区域
    document.getElementById('quickResults').style.display = 'block';
  },
  
  // 获取时长
  getDuration() {
    const taskType = document.getElementById('quickTaskType').value;
    if (taskType === 'custom') {
      return parseInt(document.getElementById('quickDuration').value) || 45;
    }
    return this.taskDurations[taskType] || 45;
  }
};

// 题型切换时显示/隐藏自定义时长
document.getElementById('quickTaskType')?.addEventListener('change', function() {
  const customGroup = document.getElementById('customDurationGroup');
  if (this.value === 'custom') {
    customGroup.style.display = 'block';
  } else {
    customGroup.style.display = 'none';
  }
});

// 即时分析按钮
document.getElementById('quickAnalyzeBtn')?.addEventListener('click', () => {
  const text = document.getElementById('quickTranscript').value.trim();
  if (!text) {
    showToast('⚠️ 请先输入学生转录文本');
    return;
  }
  
  const duration = QuickCheckManager.getDuration();
  const result = QuickCheckManager.analyze(text, duration);
  QuickCheckManager.updateUI(result);
  showToast('✅ 分析完成');
});

// 清空按钮
document.getElementById('quickClearBtn')?.addEventListener('click', () => {
  document.getElementById('quickTranscript').value = '';
  document.getElementById('quickResults').style.display = 'none';
  showToast('🗑️ 已清空');
});

// 转到完整批改
document.getElementById('quickToFullBtn')?.addEventListener('click', () => {
  const text = document.getElementById('quickTranscript').value.trim();
  const studentName = document.getElementById('quickStudentName').value.trim();
  
  // 切换到完整批改模式
  switchMode('full');
  
  // 填充数据
  if (studentName) {
    document.getElementById('studentName').value = studentName;
  }
  
  // 打开导入弹窗并填入文本
  if (text) {
    document.getElementById('mdModal').classList.add('open');
    document.getElementById('mdTextarea').value = text;
    showToast('📝 已转到完整批改，请调整格式后应用');
  }
});

// 保存到学生记录
document.getElementById('quickSaveBtn')?.addEventListener('click', () => {
  const studentName = document.getElementById('quickStudentName').value.trim();
  if (!studentName) {
    showToast('⚠️ 请先输入学生名字');
    return;
  }
  
  const text = document.getElementById('quickTranscript').value.trim();
  if (!text) {
    showToast('⚠️ 请先输入转录文本');
    return;
  }
  
  const duration = QuickCheckManager.getDuration();
  const result = QuickCheckManager.analyze(text, duration);
  
  // 保存快速检测记录
  const quickRecord = {
    type: 'quick_check',
    date: new Date().toISOString().slice(0, 10),
    taskType: document.getElementById('quickTaskType').value,
    duration: duration,
    wordCount: result.wordCount,
    wpm: result.wpmAll,
    wpmClean: result.wpmClean,
    fillers: result.fillerTotal,
    repeats: result.repeatCount,
    text: text.slice(0, 500) // 只保存前500字符
  };
  
  // 保存进步数据到学生历史
  StudentHistoryManager.record(studentName, {
    topic: `快速检测 - ${quickRecord.taskType}`,
    wordCount: result.wordCount,
    date: quickRecord.date,
    wpm: result.wpmAll,
    fillerCount: result.fillerTotal,
    repeatCount: result.repeatCount,
    errorCount: 0,
    task: quickRecord.taskType
  });
  
  // 添加到学生名单
  StudentManager.add([studentName]);
  
  showToast(`✅ 已保存 ${studentName} 的检测记录（含进步数据）`);
});

// ==================== 输入方式切换 ====================
document.getElementById('inputTabText')?.addEventListener('click', function() {
  document.getElementById('inputTabText').classList.add('active');
  document.getElementById('inputTabAudio').classList.remove('active');
  document.getElementById('inputMethodText').classList.add('active');
  document.getElementById('inputMethodAudio').classList.remove('active');
});

document.getElementById('inputTabAudio')?.addEventListener('click', function() {
  document.getElementById('inputTabAudio').classList.add('active');
  document.getElementById('inputTabText').classList.remove('active');
  document.getElementById('inputMethodAudio').classList.add('active');
  document.getElementById('inputMethodText').classList.remove('active');
});

// ==================== 音频上传功能 ====================
const audioUploadArea = document.getElementById('audioUploadArea');
const audioFileInput = document.getElementById('audioFileInput');
const audioPreview = document.getElementById('audioPreview');
const audioPlayer = document.getElementById('audioPlayer');

// 点击上传区域
audioUploadArea?.addEventListener('click', () => {
  audioFileInput?.click();
});

// 拖拽上传
audioUploadArea?.addEventListener('dragover', (e) => {
  e.preventDefault();
  audioUploadArea.classList.add('dragover');
});

audioUploadArea?.addEventListener('dragleave', () => {
  audioUploadArea.classList.remove('dragover');
});

audioUploadArea?.addEventListener('drop', (e) => {
  e.preventDefault();
  audioUploadArea.classList.remove('dragover');
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    handleAudioFile(files[0]);
  }
});

// 文件选择
audioFileInput?.addEventListener('change', (e) => {
  if (e.target.files.length > 0) {
    handleAudioFile(e.target.files[0]);
  }
});

// 处理音频文件
let currentAudioFile = null;

function handleAudioFile(file) {
  // 验证文件类型
  const validTypes = ['audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/mp4', 'audio/webm', 'audio/ogg'];
  if (!validTypes.includes(file.type) && !file.name.match(/\.(mp3|wav|m4a|webm|ogg)$/i)) {
    showToast('❌ 不支持的音频格式');
    return;
  }
  
  // 验证文件大小（25MB限制）
  if (file.size > 25 * 1024 * 1024) {
    showToast('❌ 文件太大，最大支持25MB');
    return;
  }
  
  currentAudioFile = file;
  
  // 显示预览
  document.getElementById('audioFileName').textContent = file.name;
  audioPlayer.src = URL.createObjectURL(file);
  
  // 获取音频时长
  audioPlayer.addEventListener('loadedmetadata', function() {
    const duration = Math.round(audioPlayer.duration);
    document.getElementById('audioDuration').textContent = `${duration}秒`;
    
    // 自动设置时长
    if (duration > 0) {
      document.getElementById('quickTaskType').value = 'custom';
      document.getElementById('customDurationGroup').style.display = 'block';
      document.getElementById('quickDuration').value = duration;
    }
  }, { once: true });
  
  audioUploadArea.style.display = 'none';
  audioPreview.style.display = 'block';
  document.getElementById('whisperKeyHint').style.display = 'flex';
  
  showToast('✅ 音频已加载');
}

// 移除音频
document.getElementById('removeAudioBtn')?.addEventListener('click', () => {
  currentAudioFile = null;
  audioPlayer.src = '';
  audioUploadArea.style.display = 'block';
  audioPreview.style.display = 'none';
  audioFileInput.value = '';
});

// Whisper转录
document.getElementById('transcribeBtn')?.addEventListener('click', async () => {
  if (!currentAudioFile) {
    showToast('⚠️ 请先上传音频文件');
    return;
  }
  
  // 获取API Key
  let apiKey = localStorage.getItem('toefl_whisper_api_key') || localStorage.getItem('toefl_api_key_openai');
  
  if (!apiKey) {
    apiKey = prompt('请输入 OpenAI API Key（用于Whisper转录）：');
    if (!apiKey) {
      showToast('❌ 需要API Key才能转录');
      return;
    }
    localStorage.setItem('toefl_whisper_api_key', apiKey.trim());
  }
  
  // 显示进度
  document.getElementById('whisperProgress').style.display = 'flex';
  document.getElementById('transcribeBtn').disabled = true;
  
  try {
    const formData = new FormData();
    formData.append('file', currentAudioFile);
    formData.append('model', 'whisper-1');
    formData.append('language', 'en');
    formData.append('response_format', 'text');
    
    const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`
      },
      body: formData
    });
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.error?.message || `转录失败 (${response.status})`);
    }
    
    const text = await response.text();
    
    // 填入转录文本
    document.getElementById('quickTranscript').value = text;
    
    // 切换到文本输入模式
    document.getElementById('inputTabText').click();
    
    // 自动分析
    const duration = QuickCheckManager.getDuration();
    const result = QuickCheckManager.analyze(text, duration);
    QuickCheckManager.updateUI(result);
    
    showToast('✅ 转录完成！');
    
  } catch (error) {
    console.error('Whisper转录错误:', error);
    showToast(`❌ ${error.message}`);
    
    // 如果是认证错误，清除key
    if (error.message.includes('401') || error.message.includes('Incorrect API key')) {
      localStorage.removeItem('toefl_whisper_api_key');
    }
  } finally {
    document.getElementById('whisperProgress').style.display = 'none';
    document.getElementById('transcribeBtn').disabled = false;
  }
});

// 设置Whisper Key按钮
document.getElementById('setWhisperKeyBtn')?.addEventListener('click', () => {
  const currentKey = localStorage.getItem('toefl_whisper_api_key') || '';
  const newKey = prompt('请输入 OpenAI API Key（用于Whisper转录）：', currentKey ? '••••••••' : '');
  if (newKey && newKey !== '••••••••') {
    localStorage.setItem('toefl_whisper_api_key', newKey.trim());
    showToast('✅ Whisper API Key 已保存');
  }
});

// ==================== 批量处理功能 ====================
const BatchManager = {
  entryCount: 0,
  
  // 获取时长
  getDuration() {
    const taskType = document.getElementById('batchTaskType').value;
    if (taskType === 'custom') {
      return parseInt(document.getElementById('batchDuration').value) || 45;
    }
    return QuickCheckManager.taskDurations[taskType] || 45;
  },
  
  // 添加一个学生条目
  addEntry(name = '', text = '') {
    this.entryCount++;
    const container = document.getElementById('batchEntries');
    const entry = document.createElement('div');
    entry.className = 'batch-entry';
    entry.dataset.id = this.entryCount;
    entry.innerHTML = `
      <div class="batch-entry-num">${this.entryCount}</div>
      <div class="batch-entry-fields">
        <div class="batch-entry-row">
          <input type="text" class="batch-entry-name" placeholder="学生名字" list="studentNameList" value="${name}">
        </div>
        <textarea class="batch-entry-text" placeholder="粘贴转录文本...">${text}</textarea>
      </div>
      <button class="batch-entry-remove" title="移除">🗑️</button>
    `;
    
    // 移除按钮事件
    entry.querySelector('.batch-entry-remove').addEventListener('click', () => {
      entry.remove();
      this.updateEntryNumbers();
    });
    
    container.appendChild(entry);
    
    // 聚焦到新添加的输入框
    if (!name) {
      entry.querySelector('.batch-entry-name').focus();
    }
  },
  
  // 更新条目编号
  updateEntryNumbers() {
    const entries = document.querySelectorAll('.batch-entry');
    entries.forEach((entry, idx) => {
      entry.querySelector('.batch-entry-num').textContent = idx + 1;
    });
  },
  
  // 获取所有条目数据
  getEntries() {
    const entries = document.querySelectorAll('.batch-entry');
    return Array.from(entries).map(entry => ({
      name: entry.querySelector('.batch-entry-name').value.trim(),
      text: entry.querySelector('.batch-entry-text').value.trim()
    })).filter(e => e.name && e.text);
  },
  
  // 清空所有条目
  clear() {
    document.getElementById('batchEntries').innerHTML = '';
    document.getElementById('batchResults').style.display = 'none';
    this.entryCount = 0;
    this.addEntry();
  },
  
  // 批量分析
  analyze() {
    const entries = this.getEntries();
    if (entries.length === 0) {
      showToast('⚠️ 请至少添加一个学生的转录文本');
      return;
    }
    
    const duration = this.getDuration();
    const results = [];
    
    entries.forEach(entry => {
      const result = QuickCheckManager.analyze(entry.text, duration);
      results.push({
        name: entry.name,
        ...result
      });
    });
    
    this.displayResults(results);
  },
  
  // 显示分析结果
  displayResults(results) {
    // 计算汇总
    const count = results.length;
    const avgWords = Math.round(results.reduce((sum, r) => sum + r.wordCount, 0) / count);
    const avgWPM = Math.round(results.reduce((sum, r) => sum + r.wpmAll, 0) / count);
    const avgFillers = (results.reduce((sum, r) => sum + r.fillerTotal, 0) / count).toFixed(1);
    const avgRepeats = (results.reduce((sum, r) => sum + r.repeatCount, 0) / count).toFixed(1);
    
    // 更新汇总
    document.getElementById('batchSumStudents').textContent = count;
    document.getElementById('batchSumWords').textContent = avgWords;
    document.getElementById('batchSumWPM').textContent = avgWPM;
    document.getElementById('batchSumFillers').textContent = avgFillers;
    document.getElementById('batchSumRepeats').textContent = avgRepeats;
    
    // 生成表格
    const tbody = document.getElementById('batchTableBody');
    tbody.innerHTML = results.map(r => {
      let wpmBadgeClass = 'normal';
      if (r.wpmAll < 90) wpmBadgeClass = 'very-slow';
      else if (r.wpmAll < 110) wpmBadgeClass = 'slow';
      else if (r.wpmAll > 160) wpmBadgeClass = 'very-fast';
      else if (r.wpmAll > 140) wpmBadgeClass = 'fast';
      
      return `
        <tr>
          <td><strong>${r.name}</strong></td>
          <td>${r.wordCount}</td>
          <td>${r.wpmAll}</td>
          <td><span class="wpm-badge ${wpmBadgeClass}">${r.wpmLevel}</span></td>
          <td>${r.fillerTotal}</td>
          <td>${r.repeatCount}</td>
          <td><button class="action-btn" data-name="${r.name}">查看详情</button></td>
        </tr>
      `;
    }).join('');
    
    // 详情按钮事件
    tbody.querySelectorAll('.action-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const name = btn.dataset.name;
        const entry = results.find(r => r.name === name);
        if (entry) {
          // 切换到快速检测模式并显示结果
          document.getElementById('quickStudentName').value = name;
          document.getElementById('quickTranscript').value = this.getEntries().find(e => e.name === name)?.text || '';
          switchMode('quick');
          QuickCheckManager.updateUI(entry);
        }
      });
    });
    
    // 显示结果区域
    document.getElementById('batchResults').style.display = 'block';
    showToast(`✅ 已分析 ${count} 个学生`);
    
    // 保存结果供导出
    this.lastResults = results;
  },
  
  // 导出CSV
  exportCSV() {
    if (!this.lastResults || this.lastResults.length === 0) {
      showToast('⚠️ 没有可导出的结果');
      return;
    }
    
    const headers = ['学生', '词数', 'WPM', '净WPM', '语速', '填充词', '重复', '句子数'];
    const rows = this.lastResults.map(r => [
      r.name,
      r.wordCount,
      r.wpmAll,
      r.wpmClean,
      r.wpmLevel,
      r.fillerTotal,
      r.repeatCount,
      r.sentences
    ]);
    
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `批量分析_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('✅ CSV已下载');
  },
  
  // 复制结果
  copyResults() {
    if (!this.lastResults || this.lastResults.length === 0) {
      showToast('⚠️ 没有可复制的结果');
      return;
    }
    
    const text = this.lastResults.map(r => 
      `${r.name}: ${r.wordCount}词, ${r.wpmAll}WPM(${r.wpmLevel}), 填充词${r.fillerTotal}, 重复${r.repeatCount}`
    ).join('\n');
    
    navigator.clipboard.writeText(text).then(() => {
      showToast('✅ 已复制到剪贴板');
    });
  },
  
  // 批量导入
  importBatch(text) {
    const lines = text.split('\n').filter(l => l.trim());
    let currentName = '';
    let currentText = '';
    const entries = [];
    
    lines.forEach(line => {
      // 检查是否是 "名字: 内容" 格式
      const match = line.match(/^([^:：]+)[：:]\s*(.+)$/);
      if (match) {
        // 保存之前的条目
        if (currentName && currentText) {
          entries.push({ name: currentName, text: currentText.trim() });
        }
        currentName = match[1].trim();
        currentText = match[2];
      } else if (currentName) {
        // 追加到当前条目
        currentText += ' ' + line;
      }
    });
    
    // 保存最后一个条目
    if (currentName && currentText) {
      entries.push({ name: currentName, text: currentText.trim() });
    }
    
    if (entries.length === 0) {
      showToast('⚠️ 未识别到有效内容，请检查格式');
      return;
    }
    
    // 清空并添加条目
    document.getElementById('batchEntries').innerHTML = '';
    this.entryCount = 0;
    entries.forEach(e => this.addEntry(e.name, e.text));
    
    showToast(`✅ 已导入 ${entries.length} 个学生`);
  }
};

// 批量处理事件绑定
document.getElementById('batchTaskType')?.addEventListener('change', function() {
  const customGroup = document.getElementById('batchCustomDuration');
  customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
});

document.getElementById('addBatchEntryBtn')?.addEventListener('click', () => {
  BatchManager.addEntry();
});

document.getElementById('clearBatchBtn')?.addEventListener('click', () => {
  if (confirm('确定要清空所有学生数据吗？')) {
    BatchManager.clear();
    showToast('🗑️ 已清空');
  }
});

document.getElementById('analyzeBatchBtn')?.addEventListener('click', () => {
  BatchManager.analyze();
});

document.getElementById('exportBatchCsvBtn')?.addEventListener('click', () => {
  BatchManager.exportCSV();
});

document.getElementById('copyBatchResultsBtn')?.addEventListener('click', () => {
  BatchManager.copyResults();
});

// 批量导入弹窗
document.getElementById('importBatchBtn')?.addEventListener('click', () => {
  document.getElementById('batchImportModal').classList.add('show');
});

document.getElementById('closeBatchImportBtn')?.addEventListener('click', () => {
  document.getElementById('batchImportModal').classList.remove('show');
});

document.getElementById('applyBatchImportBtn')?.addEventListener('click', () => {
  const text = document.getElementById('batchImportTextarea').value;
  if (text.trim()) {
    BatchManager.importBatch(text);
    document.getElementById('batchImportModal').classList.remove('show');
    document.getElementById('batchImportTextarea').value = '';
  } else {
    showToast('⚠️ 请输入内容');
  }
});

// ==================== 学生选择同步 ====================
// F1和F2模式共享学生选择
document.getElementById('studentName')?.addEventListener('change', function() {
  const name = this.value;
  const quickStudentName = document.getElementById('quickStudentName');
  if (quickStudentName && quickStudentName.value !== name) {
    quickStudentName.value = name;
  }
});

document.getElementById('quickStudentName')?.addEventListener('change', function() {
  const name = this.value;
  const studentName = document.getElementById('studentName');
  if (studentName && studentName.value !== name) {
    studentName.value = name;
    // 也更新F1模式的历史徽章
    StudentHistoryManager.updateBadge(name);
  }
  // 自动添加到学生列表
  if (name) {
    StudentManager.add([name]);
  }
});

// ==================== 深色模式切换 ====================
document.getElementById('themeToggle').onclick = toggleTheme;

// ==================== 答案折叠功能 ====================
const answersToggle = document.getElementById('answersToggle');
const answersPanel = document.getElementById('answersPanel');

if (answersToggle && answersPanel) {
  answersToggle.addEventListener('click', function() {
    const isOpen = this.classList.toggle('open');
    answersPanel.classList.toggle('open', isOpen);
    
    // 更新按钮文本和图标
    const toggleIcon = this.querySelector('.toggle-icon');
    const toggleText = this.querySelector('.toggle-text');
    
    if (isOpen) {
      toggleIcon.textContent = '🔓';
      toggleText.textContent = '隐藏参考答案';
    } else {
      toggleIcon.textContent = '🔒';
      toggleText.textContent = '点击查看参考答案';
    }
  });
}

// 导出图片时自动展开答案
const originalExportAll = window.exportAll;
window.exportAllWithAnswers = async function() {
  // 先展开答案
  if (answersToggle && !answersToggle.classList.contains('open')) {
    answersToggle.click();
    await new Promise(r => setTimeout(r, 500)); // 等待动画完成
  }
  // 然后导出
  if (typeof exportAll === 'function') {
    await exportAll();
  }
};

// ==================== 浮动工具栏 ====================
const tb = document.getElementById('floatingToolbar');
document.addEventListener('selectionchange', () => {
  const sel = window.getSelection();
  if(sel.isCollapsed || !document.getElementById('captureArea').contains(sel.anchorNode)) {
    tb.style.display = 'none'; return;
  }
  const r = sel.getRangeAt(0).getBoundingClientRect();
  const toolbarWidth = tb.offsetWidth || 500; 
  const viewportWidth = window.innerWidth;
  
  tb.style.display = 'flex';
  let left = r.left + (r.width / 2) - (toolbarWidth / 2);
  if (left < 10) left = 10;
  if (left + toolbarWidth > viewportWidth - 10) left = viewportWidth - toolbarWidth - 10;
  
  let top = r.top + window.scrollY - 50;
  if (top < window.scrollY + 10) top = r.bottom + window.scrollY + 10; 

  tb.style.left = `${left}px`;
  tb.style.top = `${top}px`;
});

tb.onmousedown = e => e.preventDefault();
tb.onclick = e => {
  const btn = e.target.closest('button'); if(!btn) return;
  UndoManager.save();
  const act = btn.dataset.action;
  
  if (act === 'strike') document.execCommand('strikeThrough');
  else if (act === 'bold') document.execCommand('bold');
  else if (act === 'highlight') execHighlight('hl-yellow');
  else if (act === 'blue-mark') execHighlight('hl-blue');
  else if (act === 'red-mark') execHighlight('hl-red');
  else if (act === 'orange-mark') execHighlight('hl-orange');
  else if (act === 'purple-mark') execHighlight('hl-purple');
  else if (act === 'insert-note') insertBlock('note-block');
  else if (act === 'insert-issue') insertBlock('issue-block');
  else if (act === 'cell-size-sm') setCellSize('cell-size-sm');
  else if (act === 'cell-size-lg') setCellSize('cell-size-lg');
  else if (act.startsWith('error')) insertErr(act.split('-')[1]);
  else if (act === 'clear') { document.execCommand('removeFormat'); document.execCommand('unlink'); }
  
  tb.style.display = 'none'; 
  UndoManager.save();
  updateStats();
};

// 高亮函数 - 修复跨行问题
function execHighlight(cls) {
  const sel = window.getSelection();
  if (!sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  const selectedText = range.toString();
  if (!selectedText.trim()) return;
  
  try {
    // 检查是否跨行（包含换行符或跨越多个块级元素）
    const fragment = range.cloneContents();
    const tempDiv = document.createElement('div');
    tempDiv.appendChild(fragment);
    
    // 如果选区跨多行，拆分处理
    if (tempDiv.innerHTML.includes('<br') || tempDiv.innerHTML.includes('<div') || tempDiv.innerHTML.includes('<p') || tempDiv.innerHTML.includes('<tr')) {
      // 提取选区内容
      const extractedFragment = range.extractContents();
      const wrapper = document.createElement('span');
      wrapper.className = cls;
      
      // 递归处理文本节点
      function wrapTextNodes(node) {
        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
          const span = document.createElement('span');
          span.className = cls;
          span.textContent = node.textContent;
          return span;
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          const newNode = node.cloneNode(false);
          node.childNodes.forEach(child => {
            newNode.appendChild(wrapTextNodes(child));
          });
          return newNode;
        }
        return node.cloneNode(true);
      }
      
      const wrapped = wrapTextNodes(extractedFragment);
      range.insertNode(wrapped);
    } else {
      // 单行简单处理
      const el = document.createElement('span');
      el.className = cls;
      try {
        range.surroundContents(el);
      } catch (e) {
        const fragment = range.extractContents();
        el.textContent = fragment.textContent;
        range.insertNode(el);
      }
    }
    sel.removeAllRanges();
  } catch (e) {
    console.warn("Highlight error:", e);
    // 降级处理
    const el = document.createElement('span');
    el.className = cls;
    el.textContent = selectedText;
    range.deleteContents();
    range.insertNode(el);
    sel.removeAllRanges();
  }
}

// 插入备注/问题块
function insertBlock(cls) {
  const sel = window.getSelection();
  if (!sel.rangeCount) return;
  
  const range = sel.getRangeAt(0);
  const selectedText = range.toString().trim();
  
  const block = document.createElement('span');
  block.className = cls;
  block.contentEditable = 'true';
  block.textContent = selectedText || ''; // 空内容，不显示placeholder
  
  if (selectedText) {
    range.deleteContents();
  }
  range.insertNode(block);
  
  // 聚焦到块内
  const newRange = document.createRange();
  newRange.selectNodeContents(block);
  newRange.collapse(false); // 光标放在末尾
  sel.removeAllRanges();
  sel.addRange(newRange);
  block.focus();
}

// 设置单元格字号
function setCellSize(sizeClass) {
  const sel = window.getSelection();
  if (!sel.rangeCount) return;
  
  const range = sel.getRangeAt(0);
  const selectedText = range.toString();
  
  // 如果有选中文字，只对选中的文字应用字号
  if (selectedText.trim()) {
    try {
      // 先清除选区内已有的字号span
      const fragment = range.cloneContents();
      const tempDiv = document.createElement('div');
      tempDiv.appendChild(fragment);
      
      // 移除现有的字号span
      tempDiv.querySelectorAll('.text-size-sm, .text-size-lg').forEach(el => {
        el.replaceWith(...el.childNodes);
      });
      
      // 提取内容并包裹新span
      const extractedFragment = range.extractContents();
      const wrapper = document.createElement('span');
      wrapper.className = sizeClass === 'cell-size-sm' ? 'text-size-sm' : 'text-size-lg';
      wrapper.appendChild(extractedFragment);
      range.insertNode(wrapper);
      
      sel.removeAllRanges();
      showToast(sizeClass === 'cell-size-sm' ? '📝 选中文字已缩小' : '📝 选中文字已放大');
    } catch (e) {
      // fallback: 对整个单元格应用
      let node = sel.anchorNode;
      while (node && node.nodeName !== 'TD') {
        node = node.parentNode;
      }
      if (node && node.nodeName === 'TD') {
        node.classList.remove('cell-size-sm', 'cell-size-md', 'cell-size-lg');
        node.classList.add(sizeClass);
        showToast(sizeClass === 'cell-size-sm' ? '📝 小字号' : '📝 大字号');
      }
    }
  } else {
    // 没有选中文字时，对整个单元格应用
    let node = sel.anchorNode;
    while (node && node.nodeName !== 'TD') {
      node = node.parentNode;
    }
    if (node && node.nodeName === 'TD') {
      node.classList.remove('cell-size-sm', 'cell-size-md', 'cell-size-lg');
      node.classList.add(sizeClass);
      showToast(sizeClass === 'cell-size-sm' ? '📝 小字号' : '📝 大字号');
    }
  }
}

function exec(tag, cls) {
  const sel = window.getSelection(); if(!sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  const selectedText = range.toString();
  if (!selectedText.trim()) return;
  
  try {
    const el = document.createElement(tag);
    if(cls) el.className = cls;
    
    try {
      range.surroundContents(el);
    } catch (e) {
      const fragment = range.extractContents();
      const textContent = fragment.textContent;
      el.textContent = textContent;
      range.insertNode(el);
    }
    sel.removeAllRanges();
  } catch (e) { console.warn("Selection error:", e); }
}

function insertErr(type) {
  const map = { 
    grammar: '语法',
    pronunciation: '发音', 
    stress: '重音', 
    vowel: '元音'
  };
  const sel = window.getSelection();
  if (!sel.rangeCount || sel.isCollapsed) return;
  
  const range = sel.getRangeAt(0);
  const selectedText = sel.toString();
  if (!selectedText.trim()) return;
  
  const wrapper = document.createElement('span');
  wrapper.className = 'error-text';
  
  const tag = document.createElement('span');
  tag.className = 'error-tag';
  tag.innerText = map[type] || '错误';
  tag.contentEditable = 'false';
  
  try {
    range.surroundContents(wrapper);
    wrapper.insertAdjacentElement('afterend', tag);
  } catch (e) {
    const fragment = range.extractContents();
    wrapper.appendChild(fragment);
    range.insertNode(wrapper);
    wrapper.insertAdjacentElement('afterend', tag);
  }
  sel.removeAllRanges();
}

// ==================== Markdown 导入 ====================
document.getElementById('applyMdBtn').onclick = () => {
  UndoManager.save();
  let md = document.getElementById('mdTextarea').value.trim();
  if(!md) return;
  
  // 清理不安全内容
  md = md.replace(/\[oai_citation:[^\]]*\]\([^)]*\)/g, '');
  md = md.replace(/\(file-service:[^)]*\)/g, '');
  md = md.replace(/file-service:\/\/[^\s)"]*/g, '');
  md = md.replace(/\[([^\]]*)\]\(https?:[^)]*\)/g, '$1');
  
  // 清空旧内容
  document.getElementById('polishedVersion').innerHTML = '';
  document.getElementById('overallComment').innerHTML = '';
  document.getElementById('exerciseContent').innerHTML = '';
  document.getElementById('answerContent').innerHTML = '';
  document.querySelector('#correctionTable tbody').innerHTML = '';
  document.querySelector('#summaryTable tbody').innerHTML = '';
  
  // 提取标题
  const titleMatch = md.match(/^#{1,2}\s+(?:托福独立口语批改\s*[·\·]\s*)?(.+)$/m);
  if (titleMatch) {
    let titleText = titleMatch[1].replace(/[·\·]/g, ' – ').replace(/题目[：:]\s*/i, '').trim();
    titleText = titleText.replace(/\[oai_citation:[^\]]*\]\([^)]*\)/g, '').replace(/\(file-service:[^)]*\)/g, '').trim();
    document.getElementById('headerTitle').innerHTML = titleText;
  }
  
  // 提取表格行
  let tableRows = [];
  md.split('\n').forEach(line => {
    if (line.includes('|') && !line.match(/^\|?\s*:?-+:?\s*\|/) && !line.match(/^\|\s*---/) && !line.match(/^\s*\|[\s-:]+\|/)) {
      tableRows.push(line);
    }
  });
  
  // 分割区块
  const sections = md.split(/(?=^#{2,4}\s)/m);
  
  let polishedContent = '';
  let overallContent = '';
  let exerciseContent = '';
  let answerContent = '';
  let chineseThought = '';
  let suggestThought = '';
  let idiomList = '';
  
  sections.forEach(section => {
    const lines = section.trim().split('\n');
    const header = lines[0] || '';
    const headerText = header.replace(/^#+\s*/, '');
    let content = lines.slice(1).join('\n').trim();
    content = content.replace(/^---+$/gm, '').trim();
    
    if (/^#\s/.test(header) && !/^##/.test(header)) return;
    if (/主表格批改|原句.*修改后.*详细解释/.test(section)) return;
    
    if (/润色后高分版本|高分版本示范|Polished/i.test(headerText)) {
      polishedContent = content;
    }
    else if (/参考答案/i.test(headerText)) {
      answerContent += (answerContent ? '\n\n' : '') + content;
    }
    else if (/总评/i.test(headerText) && !/高分/.test(headerText)) {
      overallContent = content;
    }
    else if (/中文思路/i.test(headerText)) {
      chineseThought = content;
    }
    else if (/建议思路/i.test(headerText)) {
      suggestThought = content;
    }
    else if (/Idiom|高分表达/i.test(headerText)) {
      const exercisePatterns = [
        /^[>＞]\s*先自己做完/m,
        /^###\s*练习\s*\d*/m,
        /^\d+\.\s*用.*翻译/m,
        /^\d+\.\s*完成句子/m,
        /^>\s*[🏁📝✅]/m,
        /^---\s*$/m
      ];
      
      let splitIndex = -1;
      for (const pattern of exercisePatterns) {
        const match = content.match(pattern);
        if (match) {
          const idx = content.indexOf(match[0]);
          if (splitIndex === -1 || idx < splitIndex) splitIndex = idx;
        }
      }
      
      if (splitIndex > -1) {
        idiomList = content.substring(0, splitIndex).trim();
        let exContent = content.substring(splitIndex).trim().replace(/^---\s*\n?/, '').trim();
        exerciseContent = exContent;
      } else {
        idiomList = content;
      }
    }
    else if (/地道表达练习/i.test(headerText)) {
      exerciseContent = content;
    }
  });
  
  // 处理表格
  const uniqueTableRows = [...new Set(tableRows)];
  const cBody = document.querySelector('#correctionTable tbody');
  const sBody = document.querySelector('#summaryTable tbody');
  cBody.innerHTML = ''; sBody.innerHTML = '';
  
  let collectedChinese = [];
  let collectedSuggest = [];
  let collectedIdiom = [];
  
  const smartFormat = (text, isLogicCell) => {
    if(!text) return '';
    text = text.replace(/&nbsp;/g, ' ').replace(/\s+/g, ' ').trim();
    text = text.replace(/🟢\s*([^：:\s]{1,10}[：:])/g, '<span class="green-tag">🟢$1</span>');
    text = text.replace(/🟡\s*([^：:\s]{1,10}[：:])/g, '<span class="yellow-tag">🟡$1</span>');
    if (isLogicCell) {
      text = text
        .replace(/(理由[一二三四五六七八九十\d]+[：:]?)/g, '<br><br><b>$1</b>')
        .replace(/(开头[：:])/g, '<br><br><b>$1</b>')
        .replace(/(结尾[：:])/g, '<br><br><b>$1</b>')
        .replace(/(最后[用一])/g, '<br><br><b>$1</b>')
        .replace(/(正式答题时)/g, '<br><br><b>$1</b>')
        .replace(/(补充观点[：:]?)/g, '<br><br><b>$1</b>')
        .replace(/\b(First,?|Second,?|Third,?|Finally,?|Overall,?|Conclusion[：:,]?)/gi, '<br><br><b>$1</b>')
        .replace(/\b(Reason\s*\d[：:,]?)/gi, '<br><br><b>$1</b>');
      if(text.startsWith('<br><br>')) text = text.substring(8);
      text = text.replace(/(<br>){3,}/g, '<br><br>');
    }
    return fmt(text);
  };
  
  uniqueTableRows.forEach((row, i) => {
    if(i===0 && (row.includes('原句') || row.includes('Original'))) return; 
    let cols = row.split('|').map(c=>c.trim());
    if(!cols[0] && !cols[cols.length-1]) cols = cols.slice(1, -1);
    if(cols.length < 2) return;
    
    const col0Text = cols[0] || '';
    const isChinese = /中文思路/.test(col0Text);
    const isSuggest = /建议思路/.test(col0Text);
    const isIdiom = /Idiom|高分表达/.test(col0Text);
    const isSum = isChinese || isSuggest || isIdiom;
    
    if (isSum) {
      const mergedContent = [cols[1], cols[2]].filter(Boolean).join(' ');
      if (isChinese && mergedContent) collectedChinese.push(mergedContent);
      if (isSuggest && mergedContent) collectedSuggest.push(mergedContent);
      if (isIdiom && mergedContent) collectedIdiom.push(mergedContent);
    } else {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${smartFormat(cols[0], false)}</td><td>${smartFormat(cols[1], false)}</td><td>${smartFormat(cols[2] || '', false)}</td>`;
      cBody.appendChild(tr);
    }
  });
  
  if (chineseThought) collectedChinese.push(chineseThought);
  if (suggestThought) collectedSuggest.push(suggestThought);
  if (idiomList) collectedIdiom.push(idiomList);
  
  if (collectedChinese.length > 0) {
    const tr = document.createElement('tr');
    const content = [...new Set(collectedChinese)].join('<br><br>');
    tr.innerHTML = `<td><span class="summary-tag">中文思路</span></td><td>${smartFormat(content, true)}</td>`;
    sBody.appendChild(tr);
  }
  if (collectedSuggest.length > 0) {
    const tr = document.createElement('tr');
    const content = [...new Set(collectedSuggest)].join('<br><br>');
    tr.innerHTML = `<td><span class="summary-tag">建议思路</span></td><td>${smartFormat(content, true)}</td>`;
    sBody.appendChild(tr);
  }
  if (collectedIdiom.length > 0) {
    const tr = document.createElement('tr');
    const content = [...new Set(collectedIdiom)].join('<br><br>');
    tr.innerHTML = `<td><span class="summary-tag">Idiom & 高分表达</span></td><td>${markdownToHtmlSimple(content)}</td>`;
    sBody.appendChild(tr);
  }
  
  if (polishedContent) {
    let cleaned = polishedContent.replace(/^---+$/gm, '').trim();
    document.getElementById('polishedVersion').innerHTML = fmt(cleaned).replace(/\n/g, '<br>');
  }
  
  if (overallContent) {
    document.getElementById('overallComment').innerHTML = markdownToHtmlSimple(overallContent);
  }
  
  if (exerciseContent) {
    document.getElementById('exerciseContent').innerHTML = markdownToHtml(exerciseContent);
  }
  
  const answerEl = document.getElementById('answerContent');
  if (answerContent) {
    answerEl.innerHTML = markdownToHtml(answerContent);
  } else {
    answerEl.innerHTML = '';
  }
  
  document.getElementById('mdModal').classList.remove('open');
  updateStats();
  syncExerciseTopic();
  UndoManager.save();
  
  const imported = [];
  if (tableRows.length > 0) imported.push('批改表');
  if (chineseThought || suggestThought || idiomList) imported.push('思路');
  if (polishedContent) imported.push('润色版');
  if (overallContent) imported.push('总评');
  if (exerciseContent) imported.push('练习');
  if (answerContent) imported.push('答案');
  
  if (imported.length > 0) {
    showToast(`✅ 已导入: ${imported.join('、')}`);
  } else {
    showToast('⚠️ 未识别到有效内容');
  }
};

function fmt(t) { 
  if(!t) return ''; 
  t = t.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');
  t = t.replace(/\*\*/g, '');
  t = t.replace(/\*([^*]+)\*/g, '<i>$1</i>');
  t = t.replace(/`([^`]+)`/g, '<code style="background:#f1f5f9;padding:1px 4px;border-radius:3px;">$1</code>');
  return t;
}

function markdownToHtmlSimple(md) {
  if (!md) return '';
  let html = md;
  html = html.replace(/^---+$/gm, '');
  html = html.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');
  html = html.replace(/\*\*/g, '');
  html = html.replace(/\*([^*]+)\*/g, '<i>$1</i>');
  html = html.replace(/^-\s+(.+)$/gm, '• $1');
  html = html.replace(/\n\n+/g, '<br><br>');
  html = html.replace(/\n/g, '<br>');
  return html;
}

function markdownToHtml(md) {
  if (!md) return '';
  
  let html = '';
  const lines = md.split('\n');
  let inList = false;
  let listItems = [];
  let inBulletList = false;
  let bulletItems = [];
  
  const flushList = () => {
    if (listItems.length > 0) {
      html += '<ol>' + listItems.map(li => `<li>${fmt(li)}</li>`).join('') + '</ol>';
      listItems = [];
    }
    inList = false;
  };
  
  const flushBulletList = () => {
    if (bulletItems.length > 0) {
      html += '<ul style="list-style:disc;padding-left:20px;margin:10px 0;">' + bulletItems.map(li => `<li>${fmt(li)}</li>`).join('') + '</ul>';
      bulletItems = [];
    }
    inBulletList = false;
  };
  
  for (let i = 0; i < lines.length; i++) {
    let line = lines[i];
    
    if (/^---+$/.test(line.trim())) {
      flushList();
      flushBulletList();
      continue;
    }
    
    if (/^###\s/.test(line)) {
      flushList();
      flushBulletList();
      const headerText = line.replace(/^###\s*/, '').trim();
      html += `<h3>${fmt(headerText)}</h3>`;
      continue;
    }
    
    if (/^>\s/.test(line)) {
      flushList();
      flushBulletList();
      const quoteText = line.replace(/^>\s*/, '').trim();
      html += `<blockquote>${fmt(quoteText)}</blockquote>`;
      continue;
    }
    
    const bulletMatch = line.match(/^-\s+(.+)/);
    if (bulletMatch) {
      flushList();
      if (!inBulletList) inBulletList = true;
      bulletItems.push(bulletMatch[1]);
      continue;
    }
    
    const listMatch = line.match(/^(\d+)[\.\、]\s*(.+)/);
    if (listMatch) {
      flushBulletList();
      if (!inList) inList = true;
      listItems.push(listMatch[2]);
      continue;
    }
    
    if (/^[\(（][^)）]+\/[^)）]+[\)）]$/.test(line.trim())) {
      flushList();
      flushBulletList();
      html += `<div class="ex-wordbank">${line.trim()}</div>`;
      continue;
    }
    
    if (line.trim() === '') {
      flushList();
      flushBulletList();
      continue;
    }
    
    flushList();
    flushBulletList();
    html += `<p class="ex-instruction">${fmt(line)}</p>`;
  }
  
  flushList();
  flushBulletList();
  return html;
}

// ==================== 同步题目 ====================
function syncExerciseTopic() {
  const topic = document.getElementById('headerTitle').textContent || '';
  document.getElementById('exerciseTopicMirror').textContent = topic;
}

// ==================== 监听输入变化 ====================
document.querySelector('#correctionTable').addEventListener('input', debounce(updateStats, 500));
document.getElementById('polishedVersion').addEventListener('input', debounce(updatePolishedWordCount, 300));
document.getElementById('headerTitle').addEventListener('input', debounce(syncExerciseTopic, 300));

// 自动保存
document.getElementById('captureArea').addEventListener('input', debounce(() => StorageManager.save(), 2000));
['studentName', 'correctionDate', 'correctionNumber', 'speedSelect', 'taskType'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => StorageManager.save());
});

// ==================== 录音功能 ====================
const recorderPanel = document.getElementById('recorderPanel');
const recorderBtn = document.getElementById('recorderBtn');
const closeRecorderBtn = document.getElementById('closeRecorderBtn');
const startRecBtn = document.getElementById('startRecBtn');
const stopRecBtn = document.getElementById('stopRecBtn');
const playRecBtn = document.getElementById('playRecBtn');
const downloadRecBtn = document.getElementById('downloadRecBtn');
const recorderTimer = document.getElementById('recorderTimer');
const recorderStatus = document.getElementById('recorderStatus');
const audioPlayback = document.getElementById('audioPlayback');
const waveformCanvas = document.getElementById('waveformCanvas');
const waveformCtx = waveformCanvas.getContext('2d');

let mediaRecorder = null;
let audioChunks = [];
let audioBlob = null;
let audioUrl = null;
let recordingStartTime = null;
let timerInterval = null;
let audioContext = null;
let analyser = null;
let animationId = null;
let isPlaying = false;

const recorderOverlay = document.createElement('div');
recorderOverlay.className = 'recorder-overlay';
recorderOverlay.id = 'recorderOverlay';
document.body.appendChild(recorderOverlay);

recorderBtn.onclick = () => {
  if (window.location.protocol === 'file:') {
    const choice = confirm(
      '⚠️ 直接打开 HTML 文件无法使用录音功能（浏览器安全限制）\n\n' +
      '解决方案：\n' +
      '1. 使用 VS Code + Live Server 打开此文件\n' +
      '2. 或点击"确定"打开在线录音工具\n\n' +
      '点击"确定"打开在线录音工具，点击"取消"关闭此提示'
    );
    if (choice) window.open('https://online-voice-recorder.com/cn/', '_blank');
    return;
  }
  
  recorderPanel.classList.add('open');
  recorderOverlay.classList.add('open');
  initCanvas();
};

closeRecorderBtn.onclick = closeRecorder;
recorderOverlay.onclick = closeRecorder;

function closeRecorder() {
  recorderPanel.classList.remove('open');
  recorderOverlay.classList.remove('open');
  stopRecording();
  if (audioPlayback) {
    audioPlayback.pause();
    audioPlayback.currentTime = 0;
  }
  isPlaying = false;
  playRecBtn.innerHTML = '<span class="rec-icon">▶</span> 播放';
  playRecBtn.classList.remove('playing');
}

function initCanvas() {
  const container = document.getElementById('waveformContainer');
  waveformCanvas.width = container.offsetWidth;
  waveformCanvas.height = container.offsetHeight;
  drawIdleWaveform();
}

function drawIdleWaveform() {
  const width = waveformCanvas.width;
  const height = waveformCanvas.height;
  waveformCtx.fillStyle = document.documentElement.getAttribute('data-theme') === 'dark' ? '#1e293b' : '#f1f5f9';
  waveformCtx.fillRect(0, 0, width, height);
  
  waveformCtx.beginPath();
  waveformCtx.strokeStyle = '#cbd5e1';
  waveformCtx.lineWidth = 2;
  waveformCtx.moveTo(0, height / 2);
  waveformCtx.lineTo(width, height / 2);
  waveformCtx.stroke();
}

function drawWaveform() {
  if (!analyser) return;
  
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  analyser.getByteTimeDomainData(dataArray);
  
  const width = waveformCanvas.width;
  const height = waveformCanvas.height;
  
  waveformCtx.fillStyle = '#fef2f2';
  waveformCtx.fillRect(0, 0, width, height);
  
  waveformCtx.lineWidth = 2;
  waveformCtx.strokeStyle = '#ef4444';
  waveformCtx.beginPath();
  
  const sliceWidth = width / bufferLength;
  let x = 0;
  
  for (let i = 0; i < bufferLength; i++) {
    const v = dataArray[i] / 128.0;
    const y = (v * height) / 2;
    
    if (i === 0) waveformCtx.moveTo(x, y);
    else waveformCtx.lineTo(x, y);
    x += sliceWidth;
  }
  
  waveformCtx.lineTo(width, height / 2);
  waveformCtx.stroke();
  
  animationId = requestAnimationFrame(drawWaveform);
}

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function updateTimer() {
  if (!recordingStartTime) return;
  const elapsed = (Date.now() - recordingStartTime) / 1000;
  recorderTimer.textContent = formatTime(elapsed);
}

startRecBtn.onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);
    analyser.fftSize = 2048;
    
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    
    mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) audioChunks.push(e.data);
    };
    
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      audioUrl = URL.createObjectURL(audioBlob);
      audioPlayback.src = audioUrl;
      
      playRecBtn.disabled = false;
      downloadRecBtn.disabled = false;
      recorderStatus.textContent = '✅ 录音完成！可以播放或下载';
      
      stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.start();
    recordingStartTime = Date.now();
    timerInterval = setInterval(updateTimer, 100);
    
    recorderTimer.classList.add('recording');
    startRecBtn.classList.add('recording');
    startRecBtn.innerHTML = '<span class="rec-icon">●</span> 录音中...';
    startRecBtn.disabled = true;
    stopRecBtn.disabled = false;
    playRecBtn.disabled = true;
    downloadRecBtn.disabled = true;
    recorderStatus.textContent = '🔴 正在录音...';
    
    drawWaveform();
    
  } catch (err) {
    console.error('录音错误:', err);
    recorderStatus.textContent = '❌ 无法访问麦克风，请检查权限设置';
    alert('无法访问麦克风。请确保：\n1. 浏览器有麦克风权限\n2. 使用 HTTPS 或 localhost');
  }
};

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
  
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  
  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
  }
  
  if (audioContext) {
    audioContext.close();
    audioContext = null;
    analyser = null;
  }
  
  recordingStartTime = null;
  recorderTimer.classList.remove('recording');
  startRecBtn.classList.remove('recording');
  startRecBtn.innerHTML = '<span class="rec-icon">●</span> 开始';
  startRecBtn.disabled = false;
  stopRecBtn.disabled = true;
  
  drawIdleWaveform();
}

stopRecBtn.onclick = stopRecording;

playRecBtn.onclick = () => {
  if (!audioUrl) return;
  
  if (isPlaying) {
    audioPlayback.pause();
    audioPlayback.currentTime = 0;
    isPlaying = false;
    playRecBtn.innerHTML = '<span class="rec-icon">▶</span> 播放';
    playRecBtn.classList.remove('playing');
  } else {
    audioPlayback.play();
    isPlaying = true;
    playRecBtn.innerHTML = '<span class="rec-icon">⏸</span> 暂停';
    playRecBtn.classList.add('playing');
  }
};

audioPlayback.onended = () => {
  isPlaying = false;
  playRecBtn.innerHTML = '<span class="rec-icon">▶</span> 播放';
  playRecBtn.classList.remove('playing');
};

downloadRecBtn.onclick = () => {
  if (!audioBlob) return;
  
  const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
  const topic = document.getElementById('headerTitle').textContent || 'recording';
  const studentName = document.getElementById('studentName').value;
  const safeTopic = topic.replace(/[^\w\u4e00-\u9fa5]/g, '_').substring(0, 20);
  const namePrefix = studentName ? `${studentName}_` : '';
  
  const link = document.createElement('a');
  link.href = audioUrl;
  link.download = `${namePrefix}TOEFL_口语_${safeTopic}_${timestamp}.webm`;
  link.click();
  
  showToast('✅ 录音已下载');
};

// ==================== 学生名单导入 ====================
document.getElementById('importStudentsBtn').onclick = () => {
  document.getElementById('studentImportModal').classList.add('show');
  document.getElementById('studentListInput').value = StudentManager.getAll().join('\n');
};

document.getElementById('cancelStudentImport').onclick = () => {
  document.getElementById('studentImportModal').classList.remove('show');
};

document.getElementById('confirmStudentImport').onclick = () => {
  const text = document.getElementById('studentListInput').value;
  const names = text.split('\n').map(n => n.trim()).filter(n => n);
  StudentManager.save(names);
  document.getElementById('studentImportModal').classList.remove('show');
  showToast(`✅ 已导入 ${names.length} 个学生`);
};

// 点击背景关闭
document.getElementById('studentImportModal').onclick = (e) => {
  if (e.target === document.getElementById('studentImportModal')) {
    document.getElementById('studentImportModal').classList.remove('show');
  }
};

// ==================== 学生名字自动保存 ====================
// 当输入学生名字后自动添加到列表
const studentNameInput = document.getElementById('studentName');

studentNameInput.addEventListener('change', () => {
  const name = studentNameInput.value.trim();
  if (name) {
    StudentManager.add([name]);
    StudentHistoryManager.updateBadge(name);
    
    // 自动设置批改次数
    const count = StudentHistoryManager.getCount(name);
    const correctionNumber = document.getElementById('correctionNumber');
    if (count > 0) {
      correctionNumber.value = count + 1;
    }
  }
});

studentNameInput.addEventListener('blur', () => {
  const name = studentNameInput.value.trim();
  if (name) {
    StudentManager.add([name]);
    StudentHistoryManager.updateBadge(name);
  }
});

// ==================== 学生历史面板 ====================
const studentHistoryPanel = document.getElementById('studentHistoryPanel');
const historyStudentSelect = document.getElementById('historyStudentSelect');

// 打开学生历史面板
document.getElementById('studentHistoryBtn').onclick = () => {
  // 填充学生列表
  const students = StudentManager.getAll();
  const history = StudentHistoryManager.getAll();
  
  // 合并有历史记录的学生
  const allStudents = new Set([...students, ...Object.keys(history)]);
  
  historyStudentSelect.innerHTML = '<option value="">-- 请选择学生 --</option>';
  Array.from(allStudents).sort().forEach(name => {
    const count = StudentHistoryManager.getCount(name);
    const option = document.createElement('option');
    option.value = name;
    option.textContent = count > 0 ? `${name} (${count}次)` : name;
    historyStudentSelect.appendChild(option);
  });
  
  // 如果当前有选中的学生，自动选中
  const currentStudent = document.getElementById('studentName').value.trim();
  if (currentStudent) {
    historyStudentSelect.value = currentStudent;
    updateHistoryDisplay(currentStudent);
  } else {
    document.getElementById('historyStats').style.display = 'none';
    document.getElementById('historyActions').style.display = 'none';
    document.getElementById('historyRecords').innerHTML = `
      <div class="history-empty">
        <div class="history-empty-icon">📚</div>
        <div>请选择学生查看历史记录</div>
      </div>
    `;
  }
  
  studentHistoryPanel.classList.add('show');
};

// 关闭学生历史面板
document.getElementById('closeStudentHistoryBtn').onclick = () => {
  studentHistoryPanel.classList.remove('show');
};

studentHistoryPanel.onclick = (e) => {
  if (e.target === studentHistoryPanel) {
    studentHistoryPanel.classList.remove('show');
  }
};

// 选择学生时更新显示
historyStudentSelect.addEventListener('change', () => {
  const studentName = historyStudentSelect.value;
  updateHistoryDisplay(studentName);
});

// 更新历史记录显示
function updateHistoryDisplay(studentName) {
  const statsDiv = document.getElementById('historyStats');
  const actionsDiv = document.getElementById('historyActions');
  const recordsDiv = document.getElementById('historyRecords');
  
  if (!studentName) {
    statsDiv.style.display = 'none';
    actionsDiv.style.display = 'none';
    recordsDiv.innerHTML = `
      <div class="history-empty">
        <div class="history-empty-icon">📚</div>
        <div>请选择学生查看历史记录</div>
      </div>
    `;
    return;
  }
  
  const history = StudentHistoryManager.getHistory(studentName);
  const records = StudentHistoryManager.getRecords(studentName);
  
  if (!history || history.count === 0) {
    statsDiv.style.display = 'none';
    actionsDiv.style.display = 'none';
    recordsDiv.innerHTML = `
      <div class="history-empty">
        <div class="history-empty-icon">📝</div>
        <div>该学生暂无批改记录</div>
      </div>
    `;
    return;
  }
  
  // 显示统计
  statsDiv.style.display = 'flex';
  actionsDiv.style.display = 'flex';
  
  document.getElementById('statCount').textContent = history.count;
  document.getElementById('statFirstDate').textContent = history.firstDate?.slice(0, 10) || '-';
  document.getElementById('statLastDate').textContent = history.lastDate?.slice(0, 10) || '-';
  
  // 显示记录列表
  if (history.records && history.records.length > 0) {
    recordsDiv.innerHTML = history.records.map((record, index) => `
      <div class="history-record-item">
        <div class="history-record-info">
          <div class="history-record-date">${record.date}</div>
          <div class="history-record-topic">${record.topic || '(未记录话题)'}</div>
        </div>
        <div class="history-record-badge">第${history.count - index}次</div>
      </div>
    `).join('');
  } else {
    recordsDiv.innerHTML = `
      <div class="history-empty">
        <div class="history-empty-icon">📄</div>
        <div>有${history.count}次批改记录，但详情未保存</div>
      </div>
    `;
  }
  
  // 显示进步曲线
  ProgressChartManager.render(history.progress || []);
}

// ==================== 进步曲线管理器 ====================
const ProgressChartManager = {
  currentMetric: 'words',
  data: [],
  
  render(progressData) {
    const chartSection = document.getElementById('progressChartSection');
    
    if (!progressData || progressData.length < 2) {
      chartSection.style.display = 'none';
      return;
    }
    
    chartSection.style.display = 'block';
    this.data = progressData.slice().reverse(); // 按时间正序
    this.drawChart(this.currentMetric);
    this.updateIndicators();
    this.bindTabs();
  },
  
  bindTabs() {
    document.querySelectorAll('.progress-chart-tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.progress-chart-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        this.currentMetric = tab.dataset.metric;
        this.drawChart(this.currentMetric);
        this.updateLegend(this.currentMetric);
      };
    });
  },
  
  drawChart(metric) {
    const canvas = document.getElementById('progressChartCanvas');
    const ctx = canvas.getContext('2d');
    const rect = canvas.parentElement.getBoundingClientRect();
    
    canvas.width = rect.width * 2;
    canvas.height = rect.height * 2;
    ctx.scale(2, 2);
    
    const width = rect.width;
    const height = rect.height;
    const padding = { top: 20, right: 20, bottom: 30, left: 45 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;
    
    // 获取数据
    const values = this.data.map(d => {
      switch(metric) {
        case 'words': return d.wordCount || 0;
        case 'wpm': return d.wpm || 0;
        case 'fillers': return d.fillerCount || 0;
        case 'errors': return d.errorCount || 0;
        default: return 0;
      }
    });
    
    const maxVal = Math.max(...values, 1);
    const minVal = Math.min(...values, 0);
    const range = maxVal - minVal || 1;
    
    // 清空画布
    ctx.clearRect(0, 0, width, height);
    
    // 获取颜色
    const colors = {
      words: { line: '#3B82F6', fill: 'rgba(59, 130, 246, 0.1)' },
      wpm: { line: '#10B981', fill: 'rgba(16, 185, 129, 0.1)' },
      fillers: { line: '#F59E0B', fill: 'rgba(245, 158, 11, 0.1)' },
      errors: { line: '#EF4444', fill: 'rgba(239, 68, 68, 0.1)' }
    };
    const color = colors[metric] || colors.words;
    
    // 绘制网格线
    ctx.strokeStyle = '#e5e7eb';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
      const y = padding.top + (chartHeight * i / 4);
      ctx.beginPath();
      ctx.moveTo(padding.left, y);
      ctx.lineTo(width - padding.right, y);
      ctx.stroke();
      
      // Y轴标签
      const val = Math.round(maxVal - (range * i / 4));
      ctx.fillStyle = '#9ca3af';
      ctx.font = '11px system-ui';
      ctx.textAlign = 'right';
      ctx.fillText(val, padding.left - 8, y + 4);
    }
    
    // 绘制填充区域
    ctx.beginPath();
    ctx.moveTo(padding.left, padding.top + chartHeight);
    
    values.forEach((val, i) => {
      const x = padding.left + (chartWidth * i / (values.length - 1 || 1));
      const y = padding.top + chartHeight - ((val - minVal) / range * chartHeight);
      if (i === 0) {
        ctx.lineTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });
    
    ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
    ctx.closePath();
    ctx.fillStyle = color.fill;
    ctx.fill();
    
    // 绘制线条
    ctx.beginPath();
    ctx.strokeStyle = color.line;
    ctx.lineWidth = 2.5;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    
    values.forEach((val, i) => {
      const x = padding.left + (chartWidth * i / (values.length - 1 || 1));
      const y = padding.top + chartHeight - ((val - minVal) / range * chartHeight);
      if (i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });
    ctx.stroke();
    
    // 绘制数据点
    values.forEach((val, i) => {
      const x = padding.left + (chartWidth * i / (values.length - 1 || 1));
      const y = padding.top + chartHeight - ((val - minVal) / range * chartHeight);
      
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, Math.PI * 2);
      ctx.fillStyle = '#fff';
      ctx.fill();
      ctx.strokeStyle = color.line;
      ctx.lineWidth = 2;
      ctx.stroke();
    });
    
    // X轴标签（日期）
    ctx.fillStyle = '#9ca3af';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    
    const labelStep = Math.ceil(values.length / 6);
    this.data.forEach((d, i) => {
      if (i % labelStep === 0 || i === this.data.length - 1) {
        const x = padding.left + (chartWidth * i / (values.length - 1 || 1));
        const dateStr = d.date?.slice(5) || '';
        ctx.fillText(dateStr, x, height - 8);
      }
    });
  },
  
  updateLegend(metric) {
    const labels = {
      words: '词数',
      wpm: '语速 (WPM)',
      fillers: '填充词',
      errors: '错误数'
    };
    document.getElementById('progressChartLegend').innerHTML = `
      <div class="legend-item"><span class="legend-dot ${metric}"></span> ${labels[metric]}</div>
    `;
  },
  
  updateIndicators() {
    if (this.data.length < 2) return;
    
    // 计算平均值和趋势
    const recent = this.data.slice(-5);
    const earlier = this.data.slice(0, Math.min(5, this.data.length - 5));
    
    // 平均词数
    const avgWords = Math.round(this.data.reduce((s, d) => s + (d.wordCount || 0), 0) / this.data.length);
    document.getElementById('indWords').textContent = avgWords;
    document.getElementById('indWords').className = 'indicator-value neutral';
    
    // 平均语速
    const avgWpm = Math.round(this.data.reduce((s, d) => s + (d.wpm || 0), 0) / this.data.length);
    document.getElementById('indWpm').textContent = avgWpm || '-';
    document.getElementById('indWpm').className = 'indicator-value neutral';
    
    // 填充词趋势
    if (recent.length && earlier.length) {
      const recentFillers = recent.reduce((s, d) => s + (d.fillerCount || 0), 0) / recent.length;
      const earlierFillers = earlier.reduce((s, d) => s + (d.fillerCount || 0), 0) / earlier.length;
      const fillerDiff = earlierFillers - recentFillers;
      
      const indFillers = document.getElementById('indFillers');
      if (Math.abs(fillerDiff) < 0.5) {
        indFillers.innerHTML = '→ 持平';
        indFillers.className = 'indicator-value neutral';
      } else if (fillerDiff > 0) {
        indFillers.innerHTML = `<span class="indicator-trend">↓</span> ${Math.abs(fillerDiff).toFixed(1)}`;
        indFillers.className = 'indicator-value positive';
      } else {
        indFillers.innerHTML = `<span class="indicator-trend">↑</span> ${Math.abs(fillerDiff).toFixed(1)}`;
        indFillers.className = 'indicator-value negative';
      }
      
      // 错误趋势
      const recentErrors = recent.reduce((s, d) => s + (d.errorCount || 0), 0) / recent.length;
      const earlierErrors = earlier.reduce((s, d) => s + (d.errorCount || 0), 0) / earlier.length;
      const errorDiff = earlierErrors - recentErrors;
      
      const indErrors = document.getElementById('indErrors');
      if (Math.abs(errorDiff) < 0.5) {
        indErrors.innerHTML = '→ 持平';
        indErrors.className = 'indicator-value neutral';
      } else if (errorDiff > 0) {
        indErrors.innerHTML = `<span class="indicator-trend">↓</span> ${Math.abs(errorDiff).toFixed(1)}`;
        indErrors.className = 'indicator-value positive';
      } else {
        indErrors.innerHTML = `<span class="indicator-trend">↑</span> ${Math.abs(errorDiff).toFixed(1)}`;
        indErrors.className = 'indicator-value negative';
      }
    } else {
      document.getElementById('indFillers').textContent = '-';
      document.getElementById('indErrors').textContent = '-';
    }
  }
};
document.getElementById('downloadHistoryBtn').onclick = () => {
  const studentName = historyStudentSelect.value;
  if (!studentName) {
    showToast('⚠️ 请先选择学生');
    return;
  }
  StudentHistoryManager.downloadStudentRecords(studentName);
};

// 清除学生历史
document.getElementById('clearStudentHistoryBtn').onclick = () => {
  const studentName = historyStudentSelect.value;
  if (!studentName) {
    showToast('⚠️ 请先选择学生');
    return;
  }
  
  if (!confirm(`确定要清除 ${studentName} 的所有批改记录吗？此操作不可恢复。`)) {
    return;
  }
  
  StudentHistoryManager.clear(studentName);
  showToast(`✅ 已清除 ${studentName} 的记录`);
  
  // 更新显示
  updateHistoryDisplay('');
  historyStudentSelect.value = '';
};

// ==================== 背景主题切换 ====================
function applyBgTheme(theme) {
  if (theme === 'default') {
    document.documentElement.removeAttribute('data-bg-theme');
  } else {
    document.documentElement.setAttribute('data-bg-theme', theme);
  }
}

document.getElementById('bgThemeSelect')?.addEventListener('change', (e) => {
  applyBgTheme(e.target.value);
  StorageManager.save();
});

// ==================== TTS 语音朗读功能（支持 Azure / OpenAI）====================
const TTSManager = {
  isPlaying: false,
  audioElement: null,
  currentProvider: localStorage.getItem('toefl_tts_provider') || 'azure',
  rate: 0.95,
  
  // Azure TTS 声音选项
  azureVoices: {
    'en-US-JennyNeural': '🇺🇸 Jenny (女声，自然)',
    'en-US-GuyNeural': '🇺🇸 Guy (男声，自然)',
    'en-US-AriaNeural': '🇺🇸 Aria (女声，助手风格)',
    'en-US-DavisNeural': '🇺🇸 Davis (男声，自然)',
    'en-GB-SoniaNeural': '🇬🇧 Sonia (英式女声)',
    'en-GB-RyanNeural': '🇬🇧 Ryan (英式男声)',
    'en-AU-NatashaNeural': '🇦🇺 Natasha (澳洲女声)',
  },
  
  // 获取Azure配置
  getAzureConfig() {
    return {
      key: localStorage.getItem('toefl_azure_tts_key') || '',
      region: localStorage.getItem('toefl_azure_tts_region') || 'eastasia',
      voice: localStorage.getItem('toefl_azure_tts_voice') || 'en-US-JennyNeural'
    };
  },
  
  // 保存Azure配置
  saveAzureConfig(key, region, voice) {
    if (key) localStorage.setItem('toefl_azure_tts_key', key);
    if (region) localStorage.setItem('toefl_azure_tts_region', region);
    if (voice) localStorage.setItem('toefl_azure_tts_voice', voice);
  },
  
  // 播放文本
  async play(text, button) {
    if (!text || !text.trim()) {
      showToast('⚠️ 没有内容可以播放');
      return;
    }
    
    if (this.isPlaying) {
      this.stop(button);
      return;
    }
    
    const cleanText = text
      .replace(/<[^>]*>/g, '')
      .replace(/\*\*/g, '')
      .replace(/\n+/g, ' ')
      .trim();
    
    if (!cleanText) {
      showToast('⚠️ 没有内容可以播放');
      return;
    }
    
    if (this.currentProvider === 'azure') {
      await this.playWithAzure(cleanText, button);
    } else if (this.currentProvider === 'openai') {
      await this.playWithOpenAI(cleanText, button);
    } else {
      this.playWithBrowser(cleanText, button);
    }
  },
  
  // Microsoft Azure TTS（推荐！高质量，每月50万字符免费）
  async playWithAzure(text, button) {
    const config = this.getAzureConfig();
    
    if (!config.key) {
      showToast('⚠️ 请先设置 Azure TTS Key');
      this.showSettings();
      return;
    }
    
    try {
      this.updateButton(button, '⏳', '生成中...');
      showToast('🎙️ Azure TTS 生成中...');
      
      // 转义XML特殊字符
      const escapedText = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
      
      // 构建SSML
      const ssml = `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="en-US">
        <voice name="${config.voice}">
          <prosody rate="${Math.round((this.rate - 1) * 100)}%">${escapedText}</prosody>
        </voice>
      </speak>`;
      
      const response = await fetch(
        `https://${config.region}.tts.speech.microsoft.com/cognitiveservices/v1`,
        {
          method: 'POST',
          headers: {
            'Ocp-Apim-Subscription-Key': config.key,
            'Content-Type': 'application/ssml+xml',
            'X-Microsoft-OutputFormat': 'audio-24khz-96kbitrate-mono-mp3'
          },
          body: ssml
        }
      );
      
      if (!response.ok) {
        if (response.status === 401) {
          throw new Error('API Key 无效，请检查设置');
        } else if (response.status === 403) {
          throw new Error('API Key 权限不足或额度用完');
        }
        throw new Error(`请求失败: ${response.status}`);
      }
      
      const audioBlob = await response.blob();
      await this.playAudioBlob(audioBlob, button, 'Azure');
      
    } catch (error) {
      console.error('Azure TTS错误:', error);
      showToast('❌ ' + error.message);
      this.resetButton(button);
    }
  },
  
  // OpenAI TTS
  async playWithOpenAI(text, button) {
    const apiKey = localStorage.getItem('toefl_api_key_openai');
    
    if (!apiKey) {
      showToast('⚠️ 请先在设置中配置 OpenAI API Key');
      return;
    }
    
    try {
      this.updateButton(button, '⏳', '生成中...');
      showToast('🎙️ OpenAI TTS 生成中...');
      
      const response = await fetch('https://api.openai.com/v1/audio/speech', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'tts-1',
          voice: 'nova',
          input: text,
          speed: this.rate
        })
      });
      
      if (!response.ok) {
        throw new Error('OpenAI TTS 请求失败');
      }
      
      const audioBlob = await response.blob();
      await this.playAudioBlob(audioBlob, button, 'OpenAI');
      
    } catch (error) {
      console.error('OpenAI TTS错误:', error);
      showToast('❌ OpenAI TTS 失败');
      this.resetButton(button);
    }
  },
  
  // 浏览器内置TTS（备用）
  playWithBrowser(text, button) {
    speechSynthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(text);
    const voices = speechSynthesis.getVoices();
    const englishVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Google')) 
                      || voices.find(v => v.lang.startsWith('en'));
    if (englishVoice) utterance.voice = englishVoice;
    utterance.rate = this.rate;
    
    utterance.onstart = () => {
      this.isPlaying = true;
      this.updateButton(button, '⏸', '暂停');
    };
    
    utterance.onend = () => {
      this.isPlaying = false;
      this.resetButton(button);
    };
    
    utterance.onerror = (e) => {
      this.isPlaying = false;
      this.resetButton(button);
      if (e.error !== 'canceled') {
        showToast('❌ 浏览器语音失败');
      }
    };
    
    speechSynthesis.speak(utterance);
    showToast('🔊 播放中（浏览器语音）');
  },
  
  // 播放音频Blob
  async playAudioBlob(blob, button, provider) {
    const audioUrl = URL.createObjectURL(blob);
    
    if (this.audioElement) {
      this.audioElement.pause();
      URL.revokeObjectURL(this.audioElement.src);
    }
    
    this.audioElement = new Audio(audioUrl);
    this.isPlaying = true;
    
    this.updateButton(button, '⏸', '暂停');
    
    this.audioElement.onended = () => {
      this.isPlaying = false;
      this.resetButton(button);
      URL.revokeObjectURL(audioUrl);
    };
    
    this.audioElement.onerror = () => {
      this.isPlaying = false;
      this.resetButton(button);
      showToast('❌ 音频播放失败');
    };
    
    await this.audioElement.play();
    showToast(`🔊 正在播放（${provider} 高质量语音）`);
  },
  
  // 更新按钮状态
  updateButton(button, icon, text) {
    if (button) {
      button.classList.add('playing');
      const iconEl = button.querySelector('.tts-icon');
      const textEl = button.querySelector('.tts-text');
      if (iconEl) iconEl.textContent = icon;
      if (textEl) textEl.textContent = text;
    }
  },
  
  // 重置按钮状态
  resetButton(button) {
    if (button) {
      button.classList.remove('playing');
      const iconEl = button.querySelector('.tts-icon');
      const textEl = button.querySelector('.tts-text');
      if (iconEl) iconEl.textContent = '🔊';
      if (textEl) textEl.textContent = '播放';
    }
  },
  
  // 停止播放
  stop(button) {
    speechSynthesis.cancel();
    if (this.audioElement) {
      this.audioElement.pause();
      this.audioElement.currentTime = 0;
    }
    this.isPlaying = false;
    this.resetButton(button);
  },
  
  // 设置提供商
  setProvider(provider) {
    this.currentProvider = provider;
    localStorage.setItem('toefl_tts_provider', provider);
  },
  
  // 打开TTS设置面板
  showSettings() {
    const panel = document.getElementById('ttsSettingsPanel');
    if (panel) {
      // 加载当前设置
      const azureConfig = this.getAzureConfig();
      document.getElementById('azureTtsKey').value = azureConfig.key || '';
      document.getElementById('azureTtsRegion').value = azureConfig.region || 'eastasia';
      document.getElementById('azureTtsVoice').value = azureConfig.voice || 'en-US-JennyNeural';
      
      document.getElementById('openaiTtsKey').value = localStorage.getItem('toefl_api_key_openai') || '';
      document.getElementById('openaiTtsVoice').value = localStorage.getItem('toefl_openai_voice') || 'nova';
      
      document.getElementById('ttsRateSlider').value = this.rate;
      document.getElementById('ttsRateValue').textContent = this.rate + 'x';
      
      // 选中当前提供商
      const radios = document.querySelectorAll('input[name="ttsProvider"]');
      radios.forEach(r => {
        r.checked = r.value === this.currentProvider;
      });
      
      // 显示对应的设置区域
      this.updateSettingsVisibility(this.currentProvider);
      
      panel.classList.add('show');
    }
  },
  
  // 更新设置区域可见性
  updateSettingsVisibility(provider) {
    document.getElementById('ttsAzureSettings').style.display = provider === 'azure' ? 'block' : 'none';
    document.getElementById('ttsOpenaiSettings').style.display = provider === 'openai' ? 'block' : 'none';
  },
  
  // 保存设置
  saveSettings() {
    const provider = document.querySelector('input[name="ttsProvider"]:checked')?.value || 'azure';
    
    // 保存Azure设置
    const azureKey = document.getElementById('azureTtsKey').value.trim();
    const azureRegion = document.getElementById('azureTtsRegion').value;
    const azureVoice = document.getElementById('azureTtsVoice').value;
    this.saveAzureConfig(azureKey, azureRegion, azureVoice);
    
    // 保存OpenAI设置
    const openaiKey = document.getElementById('openaiTtsKey').value.trim();
    const openaiVoice = document.getElementById('openaiTtsVoice').value;
    if (openaiKey) localStorage.setItem('toefl_api_key_openai', openaiKey);
    localStorage.setItem('toefl_openai_voice', openaiVoice);
    
    // 保存语速
    this.rate = parseFloat(document.getElementById('ttsRateSlider').value);
    localStorage.setItem('toefl_tts_rate', this.rate);
    
    // 保存提供商
    this.setProvider(provider);
    
    // 更新按钮显示
    const modeText = document.getElementById('ttsModeText');
    const toggleBtn = document.getElementById('toggleTtsMode');
    const names = { 'azure': '🎙️ Azure', 'openai': '🤖 OpenAI', 'browser': '🔈 浏览器' };
    if (modeText) modeText.textContent = names[provider];
    if (toggleBtn) {
      toggleBtn.classList.toggle('ai-mode', provider !== 'browser');
    }
    
    document.getElementById('ttsSettingsPanel').classList.remove('show');
    showToast('✅ TTS设置已保存！');
  },
  
  // 测试播放
  async testPlay() {
    const testText = "Hello! This is a test of the text to speech system. How does it sound?";
    const statusEl = document.getElementById('ttsTestStatus');
    
    // 临时应用设置
    const provider = document.querySelector('input[name="ttsProvider"]:checked')?.value || 'azure';
    const originalProvider = this.currentProvider;
    this.currentProvider = provider;
    
    // 临时保存key
    if (provider === 'azure') {
      const key = document.getElementById('azureTtsKey').value.trim();
      const region = document.getElementById('azureTtsRegion').value;
      const voice = document.getElementById('azureTtsVoice').value;
      if (key) this.saveAzureConfig(key, region, voice);
    } else if (provider === 'openai') {
      const key = document.getElementById('openaiTtsKey').value.trim();
      if (key) localStorage.setItem('toefl_api_key_openai', key);
    }
    
    this.rate = parseFloat(document.getElementById('ttsRateSlider').value);
    
    statusEl.textContent = '正在测试...';
    
    try {
      await this.play(testText, document.getElementById('testTtsBtn'));
      statusEl.textContent = '✅ 播放成功！';
    } catch (e) {
      statusEl.textContent = '❌ 测试失败';
    }
    
    // 恢复原设置（如果用户没保存）
    // this.currentProvider = originalProvider;
  }
};

// TTS设置面板事件
document.getElementById('closeTtsSettingsBtn')?.addEventListener('click', () => {
  document.getElementById('ttsSettingsPanel').classList.remove('show');
});

document.getElementById('cancelTtsSettingsBtn')?.addEventListener('click', () => {
  document.getElementById('ttsSettingsPanel').classList.remove('show');
});

document.getElementById('saveTtsSettingsBtn')?.addEventListener('click', () => {
  TTSManager.saveSettings();
});

document.getElementById('testTtsBtn')?.addEventListener('click', () => {
  TTSManager.testPlay();
});

// 提供商切换时更新显示
document.querySelectorAll('input[name="ttsProvider"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    TTSManager.updateSettingsVisibility(e.target.value);
  });
});

// 语速滑块
document.getElementById('ttsRateSlider')?.addEventListener('input', (e) => {
  document.getElementById('ttsRateValue').textContent = e.target.value + 'x';
});

// 点击面板背景关闭
document.getElementById('ttsSettingsPanel')?.addEventListener('click', (e) => {
  if (e.target.id === 'ttsSettingsPanel') {
    e.target.classList.remove('show');
  }
});

// 绑定播放按钮
document.getElementById('playPolishedBtn')?.addEventListener('click', function() {
  const text = document.getElementById('polishedVersion').textContent;
  TTSManager.play(text, this);
});

// TTS模式切换 - 改为打开设置面板
document.getElementById('toggleTtsMode')?.addEventListener('click', function() {
  TTSManager.showSettings();
});

// 初始化TTS
(function initTTSMode() {
  // 加载保存的语速
  const savedRate = localStorage.getItem('toefl_tts_rate');
  if (savedRate) TTSManager.rate = parseFloat(savedRate);
  
  const modeText = document.getElementById('ttsModeText');
  const toggleBtn = document.getElementById('toggleTtsMode');
  if (modeText) {
    const names = { 'azure': '🎙️ Azure', 'openai': '🤖 OpenAI', 'browser': '🔈 浏览器' };
    modeText.textContent = names[TTSManager.currentProvider] || '🎙️ Azure';
  }
  if (toggleBtn && TTSManager.currentProvider !== 'browser') {
    toggleBtn.classList.add('ai-mode');
  }
})();

// ==================== AI 批改功能 ====================
// 每个provider独立存储API Key
const API_KEY_PREFIX = 'toefl_api_key_';

const AICorrectionManager = {
  // 获取当前provider的API Key
  getApiKey() {
    const provider = this.getProvider();
    return localStorage.getItem(API_KEY_PREFIX + provider) || '';
  },
  
  // 保存当前provider的API Key
  saveApiKey(key) {
    const provider = this.getProvider();
    if (key) {
      localStorage.setItem(API_KEY_PREFIX + provider, key);
    } else {
      localStorage.removeItem(API_KEY_PREFIX + provider);
    }
    this.updateKeyStatus();
  },
  
  // 加载当前provider的API Key到输入框
  loadKeyForProvider() {
    const key = this.getApiKey();
    const input = document.getElementById('openaiApiKey');
    if (input) {
      input.value = key;
    }
    this.updateKeyStatus();
  },
  
  // 更新Key状态显示
  updateKeyStatus() {
    const status = document.getElementById('aiKeyStatus');
    const key = this.getApiKey();
    if (key) {
      status.textContent = '✓ 已保存';
      status.className = 'ai-key-status saved';
    } else {
      status.textContent = '未设置';
      status.className = 'ai-key-status missing';
    }
  },
  
  // 构建批改提示词
  buildPrompt(transcript, topic, customRequirements = '') {
    const customSection = customRequirements ? `
【老师的特别要求】
${customRequirements}
` : '';

    return `你是一位专业的托福口语批改老师。请批改以下学生的托福独立口语回答。

${topic ? `【话题】${topic}\n` : ''}
【学生回答转录】
${transcript}
${customSection}
请按照以下JSON格式输出批改结果（注意：必须是合法的JSON格式）：

{
  "title": "日期和话题标题，格式如：12月25日 – Should celebrities...",
  "corrections": [
    {
      "original": "学生原句（包含错误的部分）",
      "corrected": "修改后的正确表达",
      "explanation": "详细解释为什么这样修改，包括语法、用词、表达等方面"
    }
  ],
  "chineseThought": "分析学生的中文思维方式",
  "suggestedOutline": "建议的答题思路大纲",
  "idioms": [
    {
      "expression": "地道表达或习语",
      "meaning": "含义和用法说明"
    }
  ],
  "polishedVersion": "润色后的高分版本示范（约100-120词）",
  "overallComment": "总评，包括优点和需要改进的地方",
  "exercises": [
    "练习题1：用英文翻译...",
    "练习题2：..."
  ],
  "answers": [
    "练习题1答案",
    "练习题2答案"
  ]
}

批改要求：
1. 重点关注语法错误、用词不当、表达不地道的地方
2. 每个修改都要有详细的解释
3. 润色版本要自然流畅，适合托福口语评分标准
4. 练习题要针对学生的薄弱点设计
5. 只输出JSON，不要有其他内容`;
  },
  
  // 获取当前选择的提供商
  getProvider() {
    const selected = document.querySelector('input[name="aiProvider"]:checked');
    return selected ? selected.value : 'deepseek';
  },
  
  // 提供商配置
  providers: {
    deepseek: {
      name: 'DeepSeek',
      endpoint: 'https://api.deepseek.com/chat/completions',
      model: 'deepseek-chat',
      keyPrefix: 'sk-',
      getUrl: 'https://platform.deepseek.com'
    },
    openai: {
      name: 'OpenAI',
      endpoint: 'https://api.openai.com/v1/chat/completions',
      model: 'gpt-4o',
      keyPrefix: 'sk-',
      getUrl: 'https://platform.openai.com'
    },
    'openai-o1': {
      name: 'OpenAI o1',
      endpoint: 'https://api.openai.com/v1/chat/completions',
      model: 'o1-preview',
      keyPrefix: 'sk-',
      getUrl: 'https://platform.openai.com',
      isO1: true // o1不支持system message
    },
    gemini: {
      name: 'Google Gemini',
      endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
      model: 'gemini-2.0-flash',
      keyPrefix: 'AIza',
      getUrl: 'https://aistudio.google.com/apikey',
      isGemini: true
    }
  },
  
  // 获取自定义要求
  getCustomPrompt() {
    const input = document.getElementById('customPromptInput');
    return input ? input.value.trim() : '';
  },
  
  // 调用AI API（支持多个提供商）
  async callAI(prompt) {
    const apiKey = this.getApiKey();
    if (!apiKey) {
      throw new Error('请先设置 API Key');
    }
    
    const provider = this.getProvider();
    const config = this.providers[provider];
    
    // Gemini使用不同的API格式
    if (config.isGemini) {
      return await this.callGemini(prompt, apiKey);
    }
    
    // 构建消息
    let messages;
    let bodyParams;
    
    if (config.isO1) {
      // o1模型不支持system message和temperature
      messages = [{
        role: 'user',
        content: `你是一位专业的托福口语批改老师，擅长帮助中国学生提高英语口语表达能力。请始终用JSON格式回复。\n\n${prompt}`
      }];
      bodyParams = {
        model: config.model,
        messages: messages,
        max_completion_tokens: 4000
      };
    } else {
      // 标准OpenAI兼容格式（DeepSeek, GPT-4o等）
      messages = [
        {
          role: 'system',
          content: '你是一位专业的托福口语批改老师，擅长帮助中国学生提高英语口语表达能力。请始终用JSON格式回复。'
        },
        {
          role: 'user',
          content: prompt
        }
      ];
      bodyParams = {
        model: config.model,
        messages: messages,
        temperature: 0.7,
        max_tokens: 3000
      };
    }
    
    const response = await fetch(config.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify(bodyParams)
    });
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      if (response.status === 401) {
        throw new Error('API Key 无效，请检查后重试');
      } else if (response.status === 429) {
        throw new Error('API 调用频率过高，请稍后再试');
      } else if (response.status === 402 || response.status === 400) {
        throw new Error('API 余额不足或请求错误');
      }
      throw new Error(error.error?.message || `API请求失败 (${response.status})`);
    }
    
    const data = await response.json();
    return data.choices[0].message.content;
  },
  
  // Gemini专用调用
  async callGemini(prompt, apiKey) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `你是一位专业的托福口语批改老师。请用JSON格式回复。\n\n${prompt}`
          }]
        }],
        generationConfig: {
          temperature: 0.7,
          maxOutputTokens: 3000
        }
      })
    });
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.error?.message || `Gemini API请求失败 (${response.status})`);
    }
    
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
  },
  
  // 解析AI返回的JSON
  parseResponse(content) {
    // 尝试提取JSON部分
    let jsonStr = content;
    const jsonMatch = content.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      jsonStr = jsonMatch[0];
    }
    
    try {
      return JSON.parse(jsonStr);
    } catch (e) {
      console.error('JSON解析失败:', e, jsonStr);
      throw new Error('AI返回格式错误，请重试');
    }
  },
  
  // 将结果填入表格
  applyResults(result) {
    // 填充标题
    if (result.title) {
      document.getElementById('headerTitle').innerHTML = result.title;
    }
    
    // 填充批改表
    if (result.corrections && result.corrections.length > 0) {
      const tbody = document.querySelector('#correctionTable tbody');
      tbody.innerHTML = result.corrections.map(c => `
        <tr>
          <td>${c.original || ''}</td>
          <td>${c.corrected || ''}</td>
          <td>${c.explanation || ''}</td>
        </tr>
      `).join('');
    }
    
    // 填充思路表（中文思路 + 建议思路 + 地道表达）
    const summaryRows = [];
    if (result.chineseThought) {
      summaryRows.push(`<tr><td class="summary-label">中文思路</td><td>${result.chineseThought}</td></tr>`);
    }
    if (result.suggestedOutline) {
      summaryRows.push(`<tr><td class="summary-label">建议思路</td><td>${result.suggestedOutline}</td></tr>`);
    }
    if (result.idioms && result.idioms.length > 0) {
      const idiomHtml = result.idioms.map(i => `<b>${i.expression}</b>：${i.meaning}`).join('<br>');
      summaryRows.push(`<tr><td class="summary-label">Idiom & 高分表达</td><td>${idiomHtml}</td></tr>`);
    }
    if (summaryRows.length > 0) {
      document.querySelector('#summaryTable tbody').innerHTML = summaryRows.join('');
    }
    
    // 填充润色版本
    if (result.polishedVersion) {
      document.getElementById('polishedVersion').innerHTML = result.polishedVersion;
    }
    
    // 填充总评
    if (result.overallComment) {
      document.getElementById('overallComment').innerHTML = result.overallComment;
    }
    
    // 填充练习
    if (result.exercises && result.exercises.length > 0) {
      document.getElementById('exerciseContent').innerHTML = result.exercises.map((e, i) => `${i + 1}. ${e}`).join('<br>');
    }
    
    // 填充答案
    if (result.answers && result.answers.length > 0) {
      document.getElementById('answerContent').innerHTML = result.answers.map((a, i) => `${i + 1}. ${a}`).join('<br>');
    }
    
    // 更新统计
    updateStats();
    UndoManager.save();
    syncExerciseTopic();
  },
  
  // 开始批改
  async startCorrection() {
    const transcript = document.getElementById('studentTranscript').value.trim();
    const topic = document.getElementById('aiTopic').value.trim();
    const customRequirements = this.getCustomPrompt();
    
    if (!transcript) {
      showToast('⚠️ 请输入学生的口语转录');
      return;
    }
    
    const apiKey = this.getApiKey();
    if (!apiKey) {
      showToast('⚠️ 请先设置 API Key');
      return;
    }
    
    const progress = document.getElementById('aiProgress');
    const btn = document.getElementById('startAiCorrectionBtn');
    const provider = this.getProvider();
    const providerName = this.providers[provider]?.name || provider;
    
    try {
      // 显示进度
      progress.classList.add('show');
      btn.disabled = true;
      btn.querySelector('.ai-btn-text').textContent = `${providerName} 批改中...`;
      
      // 调用API（传入自定义要求）
      const prompt = this.buildPrompt(transcript, topic, customRequirements);
      const response = await this.callAI(prompt);
      
      // 解析结果
      const result = this.parseResponse(response);
      
      // 应用结果
      this.applyResults(result);
      
      // 关闭面板
      document.getElementById('aiPanel').classList.remove('open');
      document.querySelector('.ai-overlay')?.classList.remove('open');
      
      showToast('✅ AI批改完成！');
      
    } catch (error) {
      console.error('AI批改错误:', error);
      showToast(`❌ ${error.message}`);
    } finally {
      progress.classList.remove('show');
      btn.disabled = false;
      btn.querySelector('.ai-btn-text').textContent = '开始AI批改';
    }
  }
};

// AI面板控制
const aiPanel = document.getElementById('aiPanel');
const aiOverlay = document.createElement('div');
aiOverlay.className = 'recorder-overlay ai-overlay';
document.body.appendChild(aiOverlay);

document.getElementById('aiCorrectionBtn')?.addEventListener('click', () => {
  aiPanel.classList.add('open');
  aiOverlay.classList.add('open');
  // 加载当前provider的API Key
  AICorrectionManager.loadKeyForProvider();
});

document.getElementById('closeAiPanelBtn')?.addEventListener('click', () => {
  aiPanel.classList.remove('open');
  aiOverlay.classList.remove('open');
});

aiOverlay.addEventListener('click', () => {
  aiPanel.classList.remove('open');
  aiOverlay.classList.remove('open');
});

// ========== 模式切换Tab ==========
document.querySelectorAll('.ai-mode-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    // 切换Tab高亮
    document.querySelectorAll('.ai-mode-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    // 切换内容显示
    const mode = tab.dataset.mode;
    document.getElementById('copyMode').style.display = mode === 'copy' ? 'block' : 'none';
    document.getElementById('apiMode').style.display = mode === 'api' ? 'block' : 'none';
  });
});

// ========== 提供商选择 ==========
const providerHints = {
  deepseek: '💡 <b>DeepSeek获取方式：</b><a href="https://platform.deepseek.com" target="_blank">platform.deepseek.com</a> → 注册 → API Keys → 创建',
  openai: '💡 <b>OpenAI获取方式：</b><a href="https://platform.openai.com" target="_blank">platform.openai.com</a> → API Keys → Create',
  'openai-o1': '💡 <b>OpenAI o1获取方式：</b>同OpenAI，需要 <a href="https://platform.openai.com" target="_blank">platform.openai.com</a> 开通Tier 5（o1较贵，深度思考）',
  gemini: '💡 <b>Gemini获取方式（免费）：</b><a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com</a> → Get API Key'
};

document.querySelectorAll('input[name="aiProvider"]').forEach(radio => {
  radio.addEventListener('change', () => {
    const hint = document.getElementById('apiHint');
    if (hint) {
      hint.innerHTML = providerHints[radio.value] || '';
    }
    // 切换provider时加载对应的API Key
    AICorrectionManager.loadKeyForProvider();
  });
});

// ========== 自定义要求展开/折叠 ==========
document.getElementById('toggleCustomPrompt')?.addEventListener('click', function() {
  const container = document.getElementById('customPromptContainer');
  if (container.style.display === 'none') {
    container.style.display = 'block';
    this.textContent = '收起';
  } else {
    container.style.display = 'none';
    this.textContent = '展开';
  }
});

// ========== 复制粘贴模式功能 ==========
// Step 1: 生成Prompt
document.getElementById('generatePromptBtn')?.addEventListener('click', () => {
  const transcript = document.getElementById('studentTranscript').value.trim();
  const topic = document.getElementById('aiTopic').value.trim();
  
  if (!transcript) {
    showToast('⚠️ 请先输入学生的口语转录');
    return;
  }
  
  // 生成Prompt
  const prompt = AICorrectionManager.buildPrompt(transcript, topic);
  document.getElementById('generatedPrompt').value = prompt;
  
  // 显示Prompt区域和回复输入区域
  document.getElementById('promptSection').style.display = 'block';
  document.getElementById('responseSection').style.display = 'block';
  document.getElementById('importResponseBtn').style.display = 'inline-flex';
  
  // 自动复制到剪贴板
  navigator.clipboard.writeText(prompt).then(() => {
    showToast('✅ Prompt已复制！现在去ChatGPT粘贴');
  }).catch(() => {
    showToast('📄 请手动复制Prompt');
  });
});

// 复制Prompt按钮
document.getElementById('copyPromptBtn')?.addEventListener('click', () => {
  const prompt = document.getElementById('generatedPrompt').value;
  navigator.clipboard.writeText(prompt).then(() => {
    showToast('✅ 已复制到剪贴板！');
  }).catch(() => {
    showToast('❌ 复制失败，请手动选择复制');
  });
});

// Step 3: 导入ChatGPT回复
document.getElementById('importResponseBtn')?.addEventListener('click', () => {
  const response = document.getElementById('chatgptResponse').value.trim();
  
  if (!response) {
    showToast('⚠️ 请先粘贴ChatGPT的回复');
    return;
  }
  
  try {
    // 解析回复
    const result = AICorrectionManager.parseResponse(response);
    
    // 应用结果
    AICorrectionManager.applyResults(result);
    
    // 关闭面板
    aiPanel.classList.remove('open');
    aiOverlay.classList.remove('open');
    
    // 重置表单
    document.getElementById('studentTranscript').value = '';
    document.getElementById('aiTopic').value = '';
    document.getElementById('generatedPrompt').value = '';
    document.getElementById('chatgptResponse').value = '';
    document.getElementById('promptSection').style.display = 'none';
    document.getElementById('responseSection').style.display = 'none';
    document.getElementById('importResponseBtn').style.display = 'none';
    
    showToast('✅ 批改结果已导入！');
    
  } catch (error) {
    console.error('解析错误:', error);
    showToast('❌ 无法解析回复，请确保复制了完整的JSON内容');
  }
});

// ========== API模式功能 ==========
// 保存API Key
document.getElementById('saveApiKeyBtn')?.addEventListener('click', () => {
  const key = document.getElementById('openaiApiKey').value.trim();
  AICorrectionManager.saveApiKey(key);
  showToast(key ? '✅ API Key 已保存' : '已清除 API Key');
});

// 切换Key可见性
document.getElementById('toggleKeyVisibility')?.addEventListener('click', () => {
  const input = document.getElementById('openaiApiKey');
  input.type = input.type === 'password' ? 'text' : 'password';
});

// 开始批改（API模式）
document.getElementById('startAiCorrectionBtn')?.addEventListener('click', () => {
  // API模式使用单独的输入框
  const transcriptApi = document.getElementById('studentTranscriptApi');
  const topicApi = document.getElementById('aiTopicApi');
  
  if (transcriptApi && topicApi) {
    // 临时替换输入值
    const origTranscript = document.getElementById('studentTranscript').value;
    const origTopic = document.getElementById('aiTopic').value;
    
    document.getElementById('studentTranscript').value = transcriptApi.value;
    document.getElementById('aiTopic').value = topicApi.value;
    
    AICorrectionManager.startCorrection().then(() => {
      // 恢复原值
      document.getElementById('studentTranscript').value = origTranscript;
      document.getElementById('aiTopic').value = origTopic;
    });
  } else {
    AICorrectionManager.startCorrection();
  }
});

// ==================== Whisper 音频转录 ====================
const WhisperManager = {
  // 调用Whisper API转录音频
  async transcribe(audioFile) {
    const apiKey = AICorrectionManager.getApiKey();
    if (!apiKey) {
      throw new Error('请先设置 OpenAI API Key');
    }
    
    // 检查文件大小（Whisper限制25MB）
    if (audioFile.size > 25 * 1024 * 1024) {
      throw new Error('音频文件不能超过25MB');
    }
    
    const formData = new FormData();
    formData.append('file', audioFile);
    formData.append('model', 'whisper-1');
    formData.append('language', 'en'); // 英语
    formData.append('response_format', 'verbose_json'); // 详细输出，包含时间戳
    
    const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`
      },
      body: formData
    });
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      if (response.status === 401) {
        throw new Error('API Key 无效');
      }
      throw new Error(error.error?.message || `转录失败 (${response.status})`);
    }
    
    const data = await response.json();
    return data.text;
  }
};

// 音频上传处理
const audioUploadBox = document.getElementById('audioUploadBox');
const recorderAudioInput = document.getElementById('audioFileInput');
const uploadProgress = document.getElementById('uploadProgress');
const uploadSuccess = document.getElementById('uploadSuccess');

if (audioUploadBox) {
  // 点击上传
  audioUploadBox.addEventListener('click', () => {
    recorderAudioInput?.click();
  });
  
  // 拖拽上传
  audioUploadBox.addEventListener('dragover', (e) => {
    e.preventDefault();
    audioUploadBox.classList.add('dragover');
  });
  
  audioUploadBox.addEventListener('dragleave', () => {
    audioUploadBox.classList.remove('dragover');
  });
  
  audioUploadBox.addEventListener('drop', async (e) => {
    e.preventDefault();
    audioUploadBox.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      await handleRecorderAudioFile(files[0]);
    }
  });
  
  // 文件选择
  recorderAudioInput?.addEventListener('change', async (e) => {
    if (e.target.files.length > 0) {
      await handleRecorderAudioFile(e.target.files[0]);
    }
  });
}

async function handleRecorderAudioFile(file) {
  // 检查是否是音频文件
  if (!file.type.startsWith('audio/') && !file.name.match(/\.(mp3|wav|m4a|webm|ogg|flac)$/i)) {
    showToast('⚠️ 请上传音频文件');
    return;
  }
  
  const apiKey = AICorrectionManager.getApiKey();
  if (!apiKey) {
    showToast('⚠️ 请先设置 OpenAI API Key');
    return;
  }
  
  try {
    // 显示进度
    uploadProgress.classList.add('show');
    uploadSuccess.classList.remove('show');
    
    // 调用Whisper
    const transcript = await WhisperManager.transcribe(file);
    
    // 填入文本框
    document.getElementById('studentTranscript').value = transcript;
    
    // 显示成功
    uploadProgress.classList.remove('show');
    uploadSuccess.classList.add('show');
    
    showToast('✅ 转录完成！');
    
    // 3秒后隐藏成功提示
    setTimeout(() => {
      uploadSuccess.classList.remove('show');
    }, 3000);
    
  } catch (error) {
    console.error('Whisper转录错误:', error);
    uploadProgress.classList.remove('show');
    showToast(`❌ ${error.message}`);
  }
  
  // 清空input以便再次选择同一文件
  audioFileInput.value = '';
}

// ==================== 初始化 ====================
document.addEventListener('DOMContentLoaded', () => {
  // 设置今天的日期
  document.getElementById('correctionDate').valueAsDate = new Date();
  
  // 加载设置
  SettingsManager.loadToUI();
  
  // 初始化学生名单
  StudentManager.updateDatalist();
  
  // 尝试加载保存的数据
  if (StorageManager.load()) {
    showToast('📂 已恢复上次的工作');
  }
  
  // 初始化
  UndoManager.init();
  updateStats();
  syncExerciseTopic();
  
  // 学生输入框事件监听 - 选择/输入学生时更新历史徽章和批改次数
  const studentNameInput = document.getElementById('studentName');
  studentNameInput.addEventListener('input', () => {
    const name = studentNameInput.value.trim();
    StudentHistoryManager.updateBadge(name);
    
    // 自动设置批改次数为历史次数+1
    if (name) {
      const historyCount = StudentHistoryManager.getCount(name);
      document.getElementById('correctionNumber').value = historyCount + 1;
    }
  });
  studentNameInput.addEventListener('change', () => {
    const name = studentNameInput.value.trim();
    StudentHistoryManager.updateBadge(name);
    
    // 自动设置批改次数为历史次数+1
    if (name) {
      const historyCount = StudentHistoryManager.getCount(name);
      document.getElementById('correctionNumber').value = historyCount + 1;
    }
  });
  
  // 初始化时如果已有学生名，更新徽章
  if (studentNameInput.value.trim()) {
    StudentHistoryManager.updateBadge(studentNameInput.value.trim());
  }
});
</script>
</body>
</html>
